<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Practice Tool - Stock Valuation</title>

    <!-- KaTeX for LaTeX rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #ffffff;
            color: #1a1a1a;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            background-color: #2C5282;
            color: white;
            padding: 2rem;
            margin-bottom: 2rem;
            border-radius: 8px;
        }

        .header-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .back-link {
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .back-link:hover {
            color: white;
        }

        h1 {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }

        .progress-bar {
            background-color: #E2E8F0;
            height: 8px;
            border-radius: 4px;
            margin: 1.5rem 0;
            overflow: hidden;
        }

        .progress-fill {
            background-color: #48BB78;
            height: 100%;
            transition: width 0.3s ease;
        }

        .problem-card {
            background: white;
            border: 2px solid #E2E8F0;
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .problem-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #E2E8F0;
        }

        .problem-meta {
            display: flex;
            gap: 1rem;
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .badge-easy { background-color: #C6F6D5; color: #22543D; }
        .badge-medium { background-color: #FEF3C7; color: #78350F; }
        .badge-hard { background-color: #FED7D7; color: #742A2A; }

        .problem-number {
            font-size: 0.875rem;
            color: #718096;
            font-weight: 500;
        }

        .problem-text {
            font-size: 1.125rem;
            line-height: 1.8;
            margin-bottom: 2rem;
            color: #2D3748;
        }

        .formula-box {
            background-color: #F7FAFC;
            border-left: 4px solid #2C5282;
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            border-radius: 4px;
        }

        .formula-label {
            font-size: 0.875rem;
            color: #4A5568;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .answer-section {
            margin: 2rem 0;
        }

        .input-group {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        label {
            font-weight: 500;
            color: #2D3748;
        }

        input[type="number"] {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 2px solid #CBD5E0;
            border-radius: 6px;
            font-size: 1.125rem;
            transition: border-color 0.2s;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #2C5282;
        }

        button {
            padding: 0.75rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: #2C5282;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2A4365;
        }

        .btn-primary:disabled {
            background-color: #CBD5E0;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: #E2E8F0;
            color: #2D3748;
        }

        .btn-secondary:hover {
            background-color: #CBD5E0;
        }

        .feedback-box {
            margin-top: 1.5rem;
            padding: 1.5rem;
            border-radius: 8px;
            border: 2px solid;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .feedback-correct {
            background-color: #F0FFF4;
            border-color: #48BB78;
            color: #22543D;
        }

        .feedback-incorrect {
            background-color: #FFF5F5;
            border-color: #F56565;
            color: #742A2A;
        }

        .feedback-title {
            font-weight: 600;
            font-size: 1.125rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .feedback-content {
            margin-top: 1rem;
            line-height: 1.8;
        }

        .hint-box {
            background-color: #EBF8FF;
            border-left: 4px solid #3182CE;
            padding: 1rem 1.5rem;
            margin-top: 1rem;
            border-radius: 4px;
        }

        .solution-steps {
            margin-top: 1rem;
        }

        .solution-step {
            padding: 0.75rem 0;
            border-bottom: 1px solid #E2E8F0;
        }

        .solution-step:last-child {
            border-bottom: none;
        }

        .step-number {
            font-weight: 600;
            color: #2C5282;
        }

        .navigation {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .navigation button {
            flex: 1;
        }

        .hidden {
            display: none;
        }

        /* Calculator Styles */
        .calculator-toolbar {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .calculator-toggle-btn {
            background-color: #2C5282;
            color: white;
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 50px;
            font-size: 1.125rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .calculator-toggle-btn:hover {
            background-color: #2A4365;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }

        .calculator-container {
            position: absolute;
            bottom: 70px;
            right: 0;
            width: 320px;
            background-color: #F7FAFC;
            border: 2px solid #E2E8F0;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            padding: 1rem;
            display: none;
        }

        .calculator-container.active {
            display: block;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .calculator-display {
            background-color: #2D3748;
            color: #48BB78;
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            font-family: 'Courier New', monospace;
            font-size: 1.25rem;
            text-align: right;
            min-height: 50px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .calculator-expression {
            font-size: 0.875rem;
            color: #CBD5E0;
            margin-bottom: 0.25rem;
        }

        .calculator-result {
            font-size: 1.25rem;
            color: #48BB78;
            font-weight: 600;
        }

        .calculator-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
        }

        .calc-btn {
            padding: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            border: 1px solid #CBD5E0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            background-color: white;
            color: #2D3748;
        }

        .calc-btn:hover {
            background-color: #EDF2F7;
            transform: translateY(-1px);
        }

        .calc-btn:active {
            transform: translateY(0);
        }

        .calc-btn-operator {
            background-color: #2C5282;
            color: white;
            border-color: #2C5282;
        }

        .calc-btn-operator:hover {
            background-color: #2A4365;
        }

        .calc-btn-equals {
            background-color: #48BB78;
            color: white;
            border-color: #48BB78;
        }

        .calc-btn-equals:hover {
            background-color: #38A169;
        }

        .calc-btn-clear {
            background-color: #F56565;
            color: white;
            border-color: #F56565;
        }

        .calc-btn-clear:hover {
            background-color: #E53E3E;
        }


        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            h1 {
                font-size: 1.5rem;
            }

            .problem-card {
                padding: 1.5rem;
            }

            .input-group {
                flex-direction: column;
                align-items: stretch;
            }

            .navigation {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-nav">
                <a href="index.html" class="back-link">← Back to Topics</a>
            </div>
            <h1>Stock Valuation</h1>
            <div class="subtitle">Week 3 - MGMT 408</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: 0%"></div>
            </div>
            <div class="problem-number" id="progressText">Problem 1 of 10</div>
        </header>

        <div class="problem-card" id="problemCard">
            <div class="problem-header">
                <div class="problem-meta">
                    <span class="badge" id="difficultyBadge">Easy</span>
                    <span class="badge" style="background-color: #EBF8FF; color: #2C5282;" id="topicBadge">Topic</span>
                </div>
            </div>

            <div class="problem-text" id="problemText">
                Loading problem...
            </div>

            <div class="formula-box hidden" id="formulaBox">
                <div class="formula-label">Formula:</div>
                <div id="formulaText"></div>
            </div>

            <div class="answer-section">
                <div class="input-group">
                    <label for="answerInput">Your Answer:</label>
                    <input type="number" id="answerInput" step="0.01" placeholder="Enter your answer">
                    <button class="btn-primary" id="submitBtn" onclick="checkAnswer()">Submit</button>
                </div>
            </div>

            <div id="feedbackBox" class="hidden"></div>

            <div class="navigation">
                <button class="btn-secondary" id="prevBtn" onclick="previousProblem()">Previous</button>
                <button class="btn-secondary" id="nextBtn" onclick="nextProblem()">Next Problem</button>
            </div>
        </div>
    </div>

    <!-- Calculator Toolbar -->
    <div class="calculator-toolbar">
        <button class="calculator-toggle-btn" onclick="toggleCalculator()">
            Calculator
        </button>
        <div class="calculator-container" id="calculatorContainer">
            <div class="calculator-display">
                <div class="calculator-expression" id="calcExpression">&nbsp;</div>
                <div class="calculator-result" id="calcResult">0</div>
            </div>
            <div class="calculator-buttons">
                <button class="calc-btn calc-btn-clear" onclick="calcClear()">AC</button>
                <button class="calc-btn" onclick="calcBackspace()">Del</button>
                <button class="calc-btn calc-btn-operator" onclick="calcAppend('^')">x^y</button>
                <button class="calc-btn calc-btn-operator" onclick="calcAppend('/')">÷</button>

                <button class="calc-btn" onclick="calcAppend('7')">7</button>
                <button class="calc-btn" onclick="calcAppend('8')">8</button>
                <button class="calc-btn" onclick="calcAppend('9')">9</button>
                <button class="calc-btn calc-btn-operator" onclick="calcAppend('*')">x</button>

                <button class="calc-btn" onclick="calcAppend('4')">4</button>
                <button class="calc-btn" onclick="calcAppend('5')">5</button>
                <button class="calc-btn" onclick="calcAppend('6')">6</button>
                <button class="calc-btn calc-btn-operator" onclick="calcAppend('-')">-</button>

                <button class="calc-btn" onclick="calcAppend('1')">1</button>
                <button class="calc-btn" onclick="calcAppend('2')">2</button>
                <button class="calc-btn" onclick="calcAppend('3')">3</button>
                <button class="calc-btn calc-btn-operator" onclick="calcAppend('+')">+</button>

                <button class="calc-btn" onclick="calcAppend('0')">0</button>
                <button class="calc-btn" onclick="calcAppend('.')">.</button>
                <button class="calc-btn" onclick="calcAppend('(')">(</button>
                <button class="calc-btn" onclick="calcAppend(')')">)</button>

                <button class="calc-btn calc-btn-equals" onclick="calcEquals()" style="grid-column: span 4;">=</button>
            </div>
        </div>
    </div>

    <script>
        // Calculator state
        let calcCurrentExpression = '';
        let calcCurrentResult = '0';
        let calculatorOpen = false;

        function toggleCalculator() {
            calculatorOpen = !calculatorOpen;
            const container = document.getElementById('calculatorContainer');
            if (calculatorOpen) {
                container.classList.add('active');
            } else {
                container.classList.remove('active');
            }
        }

        function closeCalculator() {
            if (calculatorOpen) {
                calculatorOpen = false;
                document.getElementById('calculatorContainer').classList.remove('active');
            }
        }

        // Close calculator when clicking outside
        document.addEventListener('click', (e) => {
            const toolbar = document.querySelector('.calculator-toolbar');
            const container = document.getElementById('calculatorContainer');

            // If click is outside the calculator toolbar and container, close it
            if (calculatorOpen && !toolbar.contains(e.target)) {
                closeCalculator();
            }
        });

        function calcAppend(value) {
            calcCurrentExpression += value;
            updateCalcDisplay();
        }

        function calcClear() {
            calcCurrentExpression = '';
            calcCurrentResult = '0';
            updateCalcDisplay();
        }

        function calcBackspace() {
            calcCurrentExpression = calcCurrentExpression.slice(0, -1);
            updateCalcDisplay();
        }

        function calcEquals() {
            if (!calcCurrentExpression) return;

            try {
                // Replace ^ with ** for JavaScript exponentiation
                let expression = calcCurrentExpression.replace(/\^/g, '**');

                // Evaluate the expression safely
                let result = Function('"use strict"; return (' + expression + ')')();

                // Round to 4 decimal places to avoid floating point issues
                if (typeof result === 'number') {
                    calcCurrentResult = Number(result.toFixed(4)).toString();
                } else {
                    calcCurrentResult = result.toString();
                }
            } catch (error) {
                calcCurrentResult = 'Error';
            }

            updateCalcDisplay();
        }

        function updateCalcDisplay() {
            document.getElementById('calcExpression').textContent = calcCurrentExpression || '\u00A0';
            document.getElementById('calcResult').textContent = calcCurrentResult;
        }

        // Allow keyboard input for calculator (only when calculator is open)
        document.addEventListener('keydown', (e) => {
            if (document.activeElement.id === 'answerInput') return; // Don't interfere with answer input
            if (!calculatorOpen) return; // Only work when calculator is open

            if (e.key >= '0' && e.key <= '9') {
                calcAppend(e.key);
            } else if (e.key === '.') {
                calcAppend('.');
            } else if (e.key === '+' || e.key === '-' || e.key === '*' || e.key === '/') {
                calcAppend(e.key);
            } else if (e.key === '^') {
                calcAppend('^');
            } else if (e.key === 'Enter' && calcCurrentExpression) {
                calcEquals();
            } else if (e.key === 'Backspace' && calcCurrentExpression) {
                e.preventDefault();
                calcBackspace();
            } else if (e.key === 'Escape') {
                calcClear();
            } else if (e.key === '(' || e.key === ')') {
                calcAppend(e.key);
            }
        });

        // Stock Valuation Problems based on Week 3 slides (with variations)
        let problems = [
            {
                "id": "stock_001",
                "topic": "One-Year Holding Period",
                "difficulty": "easy",
                "problem_text": "You are considering purchasing Apple stock and plan to hold it for one year. You expect the stock price to be $280 per share at the end of the year. Apple pays an annual dividend of approximately $1.04 per share (paid at year end). If similar investments offer an expected return of 9%, what is the maximum price you should pay for the stock today?",
                "given": {
                    "expected_price": 280,
                    "dividend": 1.04,
                    "required_return": 0.09
                },
                "formula": "P0 = (Div1 + P1) / (1 + rE)",
                "solution_steps": [
                    "Step 1: Identify the cash flows you'll receive: Div1 = $1.04, P1 = $280",
                    "Step 2: The required return is rE = 9% = 0.09",
                    "Step 3: Apply the one-year valuation formula: P0 = (Div1 + P1) / (1 + rE)",
                    "Step 4: Substitute values: P0 = (1.04 + 280) / 1.09",
                    "Step 5: Calculate: P0 = 281.04 / 1.09",
                    "Step 6: Final answer: P0 = $257.93"
                ],
                "correct_answer": 257.93,
                "hints": {
                    "level_1": "The stock price today equals the present value of all cash flows you'll receive (dividend plus future sale price)",
                    "level_2": "The formula is: P0 = (Div1 + P1) / (1 + rE)",
                    "level_3": "Plug in the numbers: (1.04 + 280) / 1.09 = 281.04 / 1.09"
                }
            },
            {
                "id": "stock_002",
                "topic": "Dividend Yield and Capital Gains",
                "difficulty": "easy",
                "problem_text": "Microsoft stock is currently trading at $420 per share and pays an annual dividend of $3.00. Calculate the dividend yield as a percentage.",
                "given": {
                    "current_price": 420,
                    "dividend": 3.00
                },
                "formula": "Dividend Yield = Div1 / P0",
                "solution_steps": [
                    "Step 1: Identify the variables: Div1 = $3.00, P0 = $420",
                    "Step 2: Apply the dividend yield formula: Dividend Yield = Div1 / P0",
                    "Step 3: Calculate: Dividend Yield = 3.00 / 420",
                    "Step 4: Dividend Yield = 0.00714",
                    "Step 5: Convert to percentage: 0.714%",
                    "Step 6: Final answer: Dividend Yield = 0.71%"
                ],
                "correct_answer": 0.71,
                "unit": "percent",
                "hints": {
                    "level_1": "Dividend yield measures what percentage of the stock price is returned as dividends each year",
                    "level_2": "The formula is: Dividend Yield = Annual Dividend / Current Price",
                    "level_3": "Calculate: 3.00 / 420 = 0.00714, then multiply by 100 to get percentage"
                }
            },
            {
                "id": "stock_003",
                "topic": "Gordon Growth Model",
                "difficulty": "easy",
                "problem_text": "Verizon expects to pay a dividend of $2.70 per share next year. Analysts forecast that dividends will grow at a constant rate of 2% per year indefinitely. If investors require a 7% return on Verizon stock, what should be the current stock price?",
                "given": {
                    "dividend_next_year": 2.70,
                    "growth_rate": 0.02,
                    "required_return": 0.07
                },
                "formula": "P0 = Div1 / (rE - g)",
                "solution_steps": [
                    "Step 1: Identify the variables: Div1 = $2.70, rE = 7% = 0.07, g = 2% = 0.02",
                    "Step 2: This is a constant growth dividend model (Gordon Growth Model)",
                    "Step 3: Apply the formula: P0 = Div1 / (rE - g)",
                    "Step 4: Substitute: P0 = 2.70 / (0.07 - 0.02)",
                    "Step 5: Calculate: P0 = 2.70 / 0.05",
                    "Step 6: Final answer: P0 = $54.00"
                ],
                "correct_answer": 54.00,
                "hints": {
                    "level_1": "When dividends grow at a constant rate forever, the stock is valued as a growing perpetuity",
                    "level_2": "Use the Gordon Growth Model: P0 = Div1 / (rE - g)",
                    "level_3": "Calculate: 2.70 / (0.07 - 0.02) = 2.70 / 0.05"
                }
            },
            {
                "id": "stock_004",
                "topic": "Earnings Growth Rate",
                "difficulty": "medium",
                "problem_text": "A technology company reinvests 60% of its earnings back into the business (retention rate = 60%). These reinvested earnings generate a return on investment of 18%. What is the expected growth rate of earnings (as a percentage)?",
                "given": {
                    "retention_rate": 0.60,
                    "return_on_investment": 0.18
                },
                "formula": "g = b × rROI",
                "solution_steps": [
                    "Step 1: Identify the variables: b (retention rate) = 60% = 0.60, rROI = 18% = 0.18",
                    "Step 2: Growth comes from reinvesting earnings at a positive return",
                    "Step 3: Apply the growth formula: g = b × rROI",
                    "Step 4: Calculate: g = 0.60 × 0.18",
                    "Step 5: g = 0.108",
                    "Step 6: Final answer: g = 10.8%"
                ],
                "correct_answer": 10.8,
                "unit": "percent",
                "hints": {
                    "level_1": "Earnings growth depends on how much is reinvested and the return earned on that investment",
                    "level_2": "The formula is: g = Retention Rate × Return on Investment",
                    "level_3": "Calculate: 0.60 × 0.18 = 0.108, then convert to 10.8%"
                }
            },
            {
                "id": "stock_005",
                "topic": "Dividend Policy and Growth",
                "difficulty": "medium",
                "problem_text": "Pacific Industries has earnings per share of $8.00 and currently pays out all earnings as dividends with no growth. The stock trades at $80. Management decides to retain 30% of earnings to invest in projects earning 15%. If the required return stays at 10%, what will be the new stock price?",
                "given": {
                    "eps": 8.00,
                    "new_retention_rate": 0.30,
                    "return_on_investment": 0.15,
                    "required_return": 0.10
                },
                "formula": "P0 = Div1 / (rE - g), where g = b × rROI",
                "solution_steps": [
                    "Step 1: Calculate new dividend: Div1 = EPS × (1 - retention) = 8.00 × 0.70 = $5.60",
                    "Step 2: Calculate growth rate: g = b × rROI = 0.30 × 0.15 = 0.045 = 4.5%",
                    "Step 3: Apply the Gordon Growth Model: P0 = Div1 / (rE - g)",
                    "Step 4: Substitute: P0 = 5.60 / (0.10 - 0.045)",
                    "Step 5: Calculate: P0 = 5.60 / 0.055",
                    "Step 6: Final answer: P0 = $101.82"
                ],
                "correct_answer": 101.82,
                "hints": {
                    "level_1": "First find the new dividend (70% of earnings), then calculate the growth rate from retained earnings",
                    "level_2": "New Div = $5.60, Growth rate = 30% × 15% = 4.5%",
                    "level_3": "Apply Gordon Growth: P0 = 5.60 / (0.10 - 0.045) = 5.60 / 0.055"
                }
            },
            {
                "id": "stock_006",
                "topic": "P/E Ratio Basics",
                "difficulty": "easy",
                "problem_text": "Johnson & Johnson has earnings per share of $10.50 and its stock currently trades at $157.50. The company distributes all earnings as dividends. What is the P/E ratio?",
                "given": {
                    "eps": 10.50,
                    "price": 157.50
                },
                "formula": "P/E = P0 / EPS",
                "solution_steps": [
                    "Step 1: Identify the variables: P0 = $157.50, EPS = $10.50",
                    "Step 2: The P/E ratio measures how much investors pay per dollar of earnings",
                    "Step 3: Apply the formula: P/E = P0 / EPS",
                    "Step 4: Calculate: P/E = 157.50 / 10.50",
                    "Step 5: Final answer: P/E = 15.0"
                ],
                "correct_answer": 15.0,
                "hints": {
                    "level_1": "The P/E ratio tells you how many dollars investors pay for each dollar of earnings",
                    "level_2": "Simply divide the stock price by earnings per share",
                    "level_3": "Calculate: 157.50 / 10.50"
                }
            },
            {
                "id": "stock_007",
                "topic": "P/E Ratio with Growth",
                "difficulty": "medium",
                "problem_text": "After Pacific Industries changes its dividend policy (retaining 30%, paying $5.60 dividend with 4.5% growth), the stock price rises to $101.82. With EPS still at $8.00, what is the new P/E ratio?",
                "given": {
                    "new_price": 101.82,
                    "eps": 8.00
                },
                "formula": "P/E = P0 / EPS",
                "solution_steps": [
                    "Step 1: Identify the variables: P0 = $101.82, EPS = $8.00",
                    "Step 2: Note that EPS hasn't changed, but the stock price has",
                    "Step 3: Apply the P/E formula: P/E = P0 / EPS",
                    "Step 4: Calculate: P/E = 101.82 / 8.00",
                    "Step 5: Final answer: P/E = 12.73"
                ],
                "correct_answer": 12.73,
                "hints": {
                    "level_1": "The P/E ratio calculation is the same regardless of growth - price divided by EPS",
                    "level_2": "Use the new price with the unchanged EPS",
                    "level_3": "Calculate: 101.82 / 8.00"
                }
            },
            {
                "id": "stock_008",
                "topic": "Multi-Stage Growth Model",
                "difficulty": "hard",
                "problem_text": "TechStart Inc. is a young company that will reinvest all earnings for the next 4 years (no dividends). Starting in Year 5, it will pay a dividend of $3.00 per share, and dividends will grow at 5% annually forever after that. If the required return is 12%, what is the stock price today?",
                "given": {
                    "first_dividend_year": 5,
                    "first_dividend": 3.00,
                    "perpetual_growth": 0.05,
                    "required_return": 0.12
                },
                "formula": "P0 = [Div5 / (rE - g)] / (1 + rE)^4",
                "solution_steps": [
                    "Step 1: First dividend of $3.00 is paid at end of Year 5, then grows at 5% forever",
                    "Step 2: Calculate the stock price at Year 4 (one year before first dividend)",
                    "Step 3: At Year 4, this becomes a growing perpetuity: P4 = Div5 / (rE - g)",
                    "Step 4: P4 = 3.00 / (0.12 - 0.05) = 3.00 / 0.07 = $42.86",
                    "Step 5: Discount P4 back to today: P0 = P4 / (1.12)^4",
                    "Step 6: Calculate: (1.12)^4 = 1.5735",
                    "Step 7: P0 = 42.86 / 1.5735 = $27.24"
                ],
                "correct_answer": 27.24,
                "hints": {
                    "level_1": "First find the value when dividends start, then discount back to today",
                    "level_2": "At Year 4, value the growing perpetuity: P4 = 3.00 / (0.12 - 0.05)",
                    "level_3": "Then discount: P0 = 42.86 / (1.12)^4"
                }
            },
            {
                "id": "stock_009",
                "topic": "Multi-Stage Growth - Complex",
                "difficulty": "hard",
                "problem_text": "GrowthCo has current earnings of $40 million. It will reinvest all earnings for 3 years at a 25% return, then distribute all earnings as dividends forever. The required return is 10%. Year 1 earnings = $40M, Year 2 = $50M, Year 3 = $62.5M, Year 4+ = $78.125M (constant). What is the firm value today (in millions)?",
                "given": {
                    "year1_earnings": 40,
                    "year2_earnings": 50,
                    "year3_earnings": 62.5,
                    "perpetual_earnings": 78.125,
                    "required_return": 0.10
                },
                "formula": "V0 = Div4/(rE) / (1+rE)^3",
                "solution_steps": [
                    "Step 1: No dividends in Years 1-3 (all reinvested)",
                    "Step 2: From Year 4 onwards, all earnings ($78.125M) paid as dividends",
                    "Step 3: This is a perpetuity starting Year 4: Value at Year 3 = Div4 / rE",
                    "Step 4: V3 = 78.125 / 0.10 = $781.25M",
                    "Step 5: Discount back to today: V0 = 781.25 / (1.10)^3",
                    "Step 6: Calculate: (1.10)^3 = 1.331",
                    "Step 7: V0 = 781.25 / 1.331 = $586.89M"
                ],
                "correct_answer": 586.89,
                "hints": {
                    "level_1": "No dividends until Year 4, then constant dividends forever (a perpetuity)",
                    "level_2": "Value at Year 3 = 78.125 / 0.10 = $781.25M",
                    "level_3": "Discount to today: 781.25 / (1.10)^3"
                }
            },
            {
                "id": "stock_010",
                "topic": "Comparable Firms Valuation",
                "difficulty": "medium",
                "problem_text": "You want to estimate the value of a private coffee chain. You identify two public comparables: Starbucks with a P/E of 28.5 and Dutch Bros with a P/E of 45.2. The private company has earnings of $2.50 per share. Using the average P/E multiple, what is the estimated share price?",
                "given": {
                    "starbucks_pe": 28.5,
                    "dutch_bros_pe": 45.2,
                    "target_eps": 2.50
                },
                "formula": "P0 = Average P/E × EPS",
                "solution_steps": [
                    "Step 1: Calculate the average P/E of comparable firms",
                    "Step 2: Average P/E = (28.5 + 45.2) / 2 = 36.85",
                    "Step 3: Apply to target company: P0 = Average P/E × EPS",
                    "Step 4: Calculate: P0 = 36.85 × 2.50",
                    "Step 5: Final answer: P0 = $92.13"
                ],
                "correct_answer": 92.13,
                "hints": {
                    "level_1": "Comparable valuation assumes similar firms should trade at similar multiples",
                    "level_2": "First calculate the average P/E: (28.5 + 45.2) / 2",
                    "level_3": "Then multiply by target EPS: 36.85 × 2.50"
                }
            }
        ];

        let currentProblemIndex = 0;
        let attemptCount = 0;
        let completedProblems = new Set();

        // Load problems on page load
        function loadProblems() {
            displayProblem();
        }

        function displayProblem() {
            if (problems.length === 0) return;

            const problem = problems[currentProblemIndex];
            attemptCount = 0;

            // Update progress
            const progress = ((currentProblemIndex) / problems.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressText').textContent =
                `Problem ${currentProblemIndex + 1} of ${problems.length}`;

            // Update difficulty badge
            const difficultyBadge = document.getElementById('difficultyBadge');
            difficultyBadge.textContent = problem.difficulty.charAt(0).toUpperCase() + problem.difficulty.slice(1);
            difficultyBadge.className = 'badge badge-' + problem.difficulty;

            // Update topic badge
            document.getElementById('topicBadge').textContent = problem.topic;

            // Update problem text
            document.getElementById('problemText').textContent = problem.problem_text;

            // Update formula (but keep it hidden initially)
            document.getElementById('formulaText').textContent = problem.formula;
            document.getElementById('formulaBox').classList.add('hidden');

            // Clear answer input and feedback
            document.getElementById('answerInput').value = '';
            document.getElementById('feedbackBox').className = 'hidden';
            document.getElementById('submitBtn').disabled = false;

            // Render LaTeX
            renderMath();

            // Update navigation buttons
            document.getElementById('prevBtn').disabled = currentProblemIndex === 0;
            document.getElementById('nextBtn').textContent =
                currentProblemIndex === problems.length - 1 ? 'Finish' : 'Next Problem';
        }

        function checkAnswer() {
            const problem = problems[currentProblemIndex];
            const userAnswer = parseFloat(document.getElementById('answerInput').value);

            if (isNaN(userAnswer)) {
                showFeedback('Please enter a valid number', 'incorrect');
                return;
            }

            // Smart tolerance: 0.5% of correct answer OR $1 (or 0.05 for percentages), whichever is larger
            const percentTolerance = Math.abs(problem.correct_answer) * 0.005; // 0.5%
            const minTolerance = problem.unit === 'percent' ? 0.05 : 1; // $1 for dollars, 0.05 for percentages
            const tolerance = Math.max(percentTolerance, minTolerance);

            const isCorrect = Math.abs(userAnswer - problem.correct_answer) <= tolerance;

            attemptCount++;

            if (isCorrect) {
                completedProblems.add(currentProblemIndex);
                showCorrectFeedback();
            } else {
                showIncorrectFeedback();
            }
        }

        function formatAnswer(problem) {
            if (problem.unit === 'percent') {
                return problem.correct_answer.toFixed(2) + '%';
            } else if (problem.correct_answer >= 1000) {
                return '$' + problem.correct_answer.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            } else {
                return '$' + problem.correct_answer.toFixed(2);
            }
        }

        function showCorrectFeedback() {
            const problem = problems[currentProblemIndex];
            const feedbackBox = document.getElementById('feedbackBox');

            let html = `
                <div class="feedback-title">
                    Correct!
                </div>
                <div class="feedback-content">
                    Great job! The correct answer is ${formatAnswer(problem)}.
                </div>
            `;

            feedbackBox.className = 'feedback-box feedback-correct';
            feedbackBox.innerHTML = html;

            document.getElementById('submitBtn').disabled = true;
        }

        function showIncorrectFeedback() {
            const problem = problems[currentProblemIndex];
            const feedbackBox = document.getElementById('feedbackBox');

            let html = `
                <div class="feedback-title">
                    Not quite right
                </div>
            `;

            // Adaptive feedback based on attempt count
            if (attemptCount === 1) {
                html += `
                    <div class="hint-box">
                        <strong>Hint:</strong> ${problem.hints.level_1}
                    </div>
                `;
            } else if (attemptCount === 2) {
                // Show formula on second attempt
                document.getElementById('formulaBox').classList.remove('hidden');
                html += `
                    <div class="hint-box">
                        <strong>Formula revealed above.</strong> ${problem.hints.level_2}
                    </div>
                `;
            } else if (attemptCount === 3) {
                // Keep formula visible
                document.getElementById('formulaBox').classList.remove('hidden');
                html += `
                    <div class="hint-box">
                        <strong>Detailed hint:</strong> ${problem.hints.level_3}
                    </div>
                    <div style="margin-top: 1rem;">
                        <button class="btn-secondary" onclick="showFullSolution()">Show Full Solution</button>
                    </div>
                `;
            } else {
                // After 3 attempts, show full solution automatically
                showFullSolution();
                return;
            }

            feedbackBox.className = 'feedback-box feedback-incorrect';
            feedbackBox.innerHTML = html;
        }

        function showFullSolution() {
            const problem = problems[currentProblemIndex];
            const feedbackBox = document.getElementById('feedbackBox');

            let html = `
                <div class="feedback-title">
                    Solution
                </div>
                <div class="solution-steps">
            `;

            problem.solution_steps.forEach((step, index) => {
                html += `
                    <div class="solution-step">
                        ${step}
                    </div>
                `;
            });

            html += `
                </div>
                <div class="feedback-content" style="margin-top: 1rem; padding-top: 1rem; border-top: 2px solid #E2E8F0;">
                    <strong>Final Answer:</strong> ${formatAnswer(problem)}
                </div>
            `;

            feedbackBox.className = 'feedback-box feedback-correct';
            feedbackBox.innerHTML = html;

            document.getElementById('submitBtn').disabled = true;
            renderMath();
        }

        function nextProblem() {
            if (currentProblemIndex < problems.length - 1) {
                currentProblemIndex++;
                displayProblem();
            } else {
                showSummary();
            }
        }

        function previousProblem() {
            if (currentProblemIndex > 0) {
                currentProblemIndex--;
                displayProblem();
            }
        }

        function showSummary() {
            const problemCard = document.getElementById('problemCard');
            const completed = completedProblems.size;
            const total = problems.length;
            const percentage = Math.round((completed / total) * 100);

            problemCard.innerHTML = `
                <div style="text-align: center; padding: 3rem;">
                    <h2 style="font-size: 2rem; margin-bottom: 1rem;">Practice Session Complete!</h2>
                    <div style="font-size: 3rem; font-weight: bold; color: #2C5282; margin: 2rem 0;">
                        ${completed} / ${total}
                    </div>
                    <div style="font-size: 1.25rem; color: #4A5568; margin-bottom: 2rem;">
                        You got ${percentage}% of problems correct on the first try!
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                        <button class="btn-primary" onclick="location.reload()">Practice Again</button>
                        <a href="index.html" class="btn-secondary" style="text-decoration: none; display: inline-block;">Back to Topics</a>
                    </div>
                </div>
            `;
        }

        function renderMath() {
            // Simple rendering - for more complex math, we'd use KaTeX's auto-render
            setTimeout(() => {
                const elements = document.querySelectorAll('.problem-text, .formula-box, .solution-step, .hint-box');
                elements.forEach(element => {
                    // Replace common LaTeX patterns with rendered math
                    // This is a simplified version - full KaTeX auto-render would be more robust
                });
            }, 100);
        }

        // Allow Enter key to submit
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('answerInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !document.getElementById('submitBtn').disabled) {
                    checkAnswer();
                }
            });
            loadProblems();
        });
    </script>
</body>
</html>
