<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Practice Tool - The Cost of Capital</title>

    <!-- KaTeX for LaTeX rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #ffffff;
            color: #1a1a1a;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            background-color: #2C5282;
            color: white;
            padding: 2rem;
            margin-bottom: 2rem;
            border-radius: 8px;
        }

        .header-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .back-link {
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .back-link:hover {
            color: white;
        }

        h1 {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }

        .progress-bar {
            background-color: #E2E8F0;
            height: 8px;
            border-radius: 4px;
            margin: 1.5rem 0;
            overflow: hidden;
        }

        .progress-fill {
            background-color: #48BB78;
            height: 100%;
            transition: width 0.3s ease;
        }

        .problem-card {
            background: white;
            border: 2px solid #E2E8F0;
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .problem-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #E2E8F0;
        }

        .problem-meta {
            display: flex;
            gap: 1rem;
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .badge-easy { background-color: #C6F6D5; color: #22543D; }
        .badge-medium { background-color: #FEF3C7; color: #78350F; }
        .badge-hard { background-color: #FED7D7; color: #742A2A; }

        .problem-number {
            font-size: 0.875rem;
            color: #718096;
            font-weight: 500;
        }

        .problem-text {
            font-size: 1.125rem;
            line-height: 1.8;
            margin-bottom: 2rem;
            color: #2D3748;
        }

        .formula-box {
            background-color: #F7FAFC;
            border-left: 4px solid #2C5282;
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            border-radius: 4px;
        }

        .formula-label {
            font-size: 0.875rem;
            color: #4A5568;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .answer-section {
            margin: 2rem 0;
        }

        .input-group {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        label {
            font-weight: 500;
            color: #2D3748;
        }

        input[type="number"] {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 2px solid #CBD5E0;
            border-radius: 6px;
            font-size: 1.125rem;
            transition: border-color 0.2s;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #2C5282;
        }

        button {
            padding: 0.75rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: #2C5282;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2A4365;
        }

        .btn-primary:disabled {
            background-color: #CBD5E0;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: #E2E8F0;
            color: #2D3748;
        }

        .btn-secondary:hover {
            background-color: #CBD5E0;
        }

        .feedback-box {
            margin-top: 1.5rem;
            padding: 1.5rem;
            border-radius: 8px;
            border: 2px solid;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .feedback-correct {
            background-color: #F0FFF4;
            border-color: #48BB78;
            color: #22543D;
        }

        .feedback-incorrect {
            background-color: #FFF5F5;
            border-color: #F56565;
            color: #742A2A;
        }

        .feedback-title {
            font-weight: 600;
            font-size: 1.125rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .feedback-content {
            margin-top: 1rem;
            line-height: 1.8;
        }

        .hint-box {
            background-color: #EBF8FF;
            border-left: 4px solid #3182CE;
            padding: 1rem 1.5rem;
            margin-top: 1rem;
            border-radius: 4px;
        }

        .solution-steps {
            margin-top: 1rem;
        }

        .solution-step {
            padding: 0.75rem 0;
            border-bottom: 1px solid #E2E8F0;
        }

        .solution-step:last-child {
            border-bottom: none;
        }

        .step-number {
            font-weight: 600;
            color: #2C5282;
        }

        .navigation {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .navigation button {
            flex: 1;
        }

        .hidden {
            display: none;
        }

        /* Calculator Styles */
        .calculator-toolbar {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .calculator-toggle-btn {
            background-color: #2C5282;
            color: white;
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 50px;
            font-size: 1.125rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .calculator-toggle-btn:hover {
            background-color: #2A4365;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }

        .calculator-container {
            position: absolute;
            bottom: 70px;
            right: 0;
            width: 320px;
            background-color: #F7FAFC;
            border: 2px solid #E2E8F0;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            padding: 1rem;
            display: none;
        }

        .calculator-container.active {
            display: block;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .calculator-display {
            background-color: #2D3748;
            color: #48BB78;
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            font-family: 'Courier New', monospace;
            font-size: 1.25rem;
            text-align: right;
            min-height: 50px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .calculator-expression {
            font-size: 0.875rem;
            color: #CBD5E0;
            margin-bottom: 0.25rem;
        }

        .calculator-result {
            font-size: 1.25rem;
            color: #48BB78;
            font-weight: 600;
        }

        .calculator-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
        }

        .calc-btn {
            padding: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            border: 1px solid #CBD5E0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            background-color: white;
            color: #2D3748;
        }

        .calc-btn:hover {
            background-color: #EDF2F7;
            transform: translateY(-1px);
        }

        .calc-btn:active {
            transform: translateY(0);
        }

        .calc-btn-operator {
            background-color: #2C5282;
            color: white;
            border-color: #2C5282;
        }

        .calc-btn-operator:hover {
            background-color: #2A4365;
        }

        .calc-btn-equals {
            background-color: #48BB78;
            color: white;
            border-color: #48BB78;
        }

        .calc-btn-equals:hover {
            background-color: #38A169;
        }

        .calc-btn-clear {
            background-color: #F56565;
            color: white;
            border-color: #F56565;
        }

        .calc-btn-clear:hover {
            background-color: #E53E3E;
        }


        /* Worked Example Toggle Styles */
        .worked-example-toggle {
            background: linear-gradient(135deg, #EBF8FF 0%, #E6FFFA 100%);
            border: 2px solid #3182CE;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .worked-example-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .worked-example-header:hover {
            background-color: rgba(49, 130, 206, 0.1);
        }

        .worked-example-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
            color: #2C5282;
        }

        .worked-example-title .icon {
            font-size: 1.25rem;
        }

        .worked-example-subtitle {
            font-size: 0.85rem;
            color: #4A5568;
            font-weight: 400;
        }

        .toggle-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #3182CE;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .toggle-arrow {
            transition: transform 0.3s ease;
            font-size: 1.25rem;
        }

        .worked-example-toggle.expanded .toggle-arrow {
            transform: rotate(180deg);
        }

        .worked-example-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, padding 0.4s ease;
            background-color: #F7FAFC;
        }

        .worked-example-toggle.expanded .worked-example-content {
            max-height: 2000px;
            padding: 1.5rem;
            border-top: 1px solid #BEE3F8;
        }

        .example-problem {
            background: white;
            border-radius: 6px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            border-left: 4px solid #3182CE;
        }

        .example-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #3182CE;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .example-text {
            color: #2D3748;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .example-solution {
            background: white;
            border-radius: 6px;
            padding: 1.25rem;
        }

        .example-step {
            display: flex;
            gap: 1rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid #E2E8F0;
        }

        .example-step:last-child {
            border-bottom: none;
        }

        .example-step-number {
            background-color: #3182CE;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .example-step-content {
            flex: 1;
        }

        .example-step-explanation {
            color: #4A5568;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .example-step-calculation {
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            background-color: #EDF2F7;
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            font-size: 0.9rem;
            color: #2D3748;
        }

        .example-final-answer {
            background: linear-gradient(135deg, #48BB78 0%, #38A169 100%);
            color: white;
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
            text-align: center;
        }

        .example-final-answer-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            opacity: 0.9;
        }

        .example-final-answer-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .now-try-badge {
            background-color: #48BB78;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        /* Multiple choice styles */
        .choices-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin: 1.5rem 0;
        }

        .choice-btn {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem 1.25rem;
            border: 2px solid #CBD5E0;
            border-radius: 8px;
            background-color: #F7FAFC;
            cursor: pointer;
            text-align: left;
            font-size: 1rem;
            line-height: 1.5;
            transition: all 0.2s;
        }

        .choice-btn:hover {
            border-color: #2C5282;
            background-color: #EBF8FF;
        }

        .choice-btn.selected {
            border-color: #2C5282;
            background-color: #EBF8FF;
            font-weight: 500;
        }

        .choice-number {
            background-color: #2C5282;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .choice-btn.selected .choice-number {
            background-color: #2C5282;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            h1 {
                font-size: 1.5rem;
            }

            .problem-card {
                padding: 1.5rem;
            }

            .input-group {
                flex-direction: column;
                align-items: stretch;
            }

            .navigation {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-nav">
                <a href="index.html" class="back-link">&larr; Back to Topics</a>
            </div>
            <h1>The Cost of Capital</h1>
            <div class="subtitle">Week 8 - MGMT 408</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: 0%"></div>
            </div>
            <div class="problem-number" id="progressText">Problem 1 of 10</div>
        </header>

        <div class="problem-card" id="problemCard">
            <div class="problem-header">
                <div class="problem-meta">
                    <span class="badge" id="difficultyBadge">Easy</span>
                    <span class="badge" style="background-color: #EBF8FF; color: #2C5282;" id="topicBadge">Topic</span>
                </div>
            </div>

            <!-- Worked Example Toggle -->
            <div class="worked-example-toggle" id="workedExampleToggle">
                <div class="worked-example-header" onclick="toggleWorkedExample()">
                    <div class="worked-example-title">
                        <span class="icon">üìñ</span>
                        <span>
                            See Worked Example
                            <div class="worked-example-subtitle">Similar problem with step-by-step solution</div>
                        </span>
                    </div>
                    <div class="toggle-indicator">
                        <span class="toggle-text" id="toggleText">Show</span>
                        <span class="toggle-arrow">‚ñº</span>
                    </div>
                </div>
                <div class="worked-example-content" id="workedExampleContent">
                    <!-- Content populated by JavaScript -->
                </div>
            </div>

            <div class="now-try-badge">‚úèÔ∏è Now You Try</div>

            <div class="problem-text" id="problemText">
                Loading problem...
            </div>

            <div class="formula-box hidden" id="formulaBox">
                <div class="formula-label">Formula:</div>
                <div id="formulaText"></div>
            </div>

            <div class="answer-section" id="answerSection">
                <div class="input-group">
                    <label for="answerInput">Your Answer:</label>
                    <input type="number" id="answerInput" step="0.01" placeholder="Enter your answer">
                    <button class="btn-primary" id="submitBtn" onclick="checkAnswer()">Submit</button>
                </div>
            </div>

            <div id="feedbackBox" class="hidden"></div>

            <div class="navigation">
                <button class="btn-secondary" id="prevBtn" onclick="previousProblem()">Previous</button>
                <button class="btn-secondary" id="nextBtn" onclick="nextProblem()">Next Problem</button>
            </div>
        </div>
    </div>

    <!-- Calculator Toolbar -->
    <div class="calculator-toolbar">
        <button class="calculator-toggle-btn" onclick="toggleCalculator()">
            Calculator
        </button>
        <div class="calculator-container" id="calculatorContainer">
            <div class="calculator-display">
                <div class="calculator-expression" id="calcExpression">&nbsp;</div>
                <div class="calculator-result" id="calcResult">0</div>
            </div>
            <div class="calculator-buttons">
                <button class="calc-btn calc-btn-clear" onclick="calcClear()">AC</button>
                <button class="calc-btn" onclick="calcBackspace()">Del</button>
                <button class="calc-btn calc-btn-operator" onclick="calcAppend('^')">x^y</button>
                <button class="calc-btn calc-btn-operator" onclick="calcAppend('/')">√∑</button>

                <button class="calc-btn" onclick="calcAppend('7')">7</button>
                <button class="calc-btn" onclick="calcAppend('8')">8</button>
                <button class="calc-btn" onclick="calcAppend('9')">9</button>
                <button class="calc-btn calc-btn-operator" onclick="calcAppend('*')">x</button>

                <button class="calc-btn" onclick="calcAppend('4')">4</button>
                <button class="calc-btn" onclick="calcAppend('5')">5</button>
                <button class="calc-btn" onclick="calcAppend('6')">6</button>
                <button class="calc-btn calc-btn-operator" onclick="calcAppend('-')">-</button>

                <button class="calc-btn" onclick="calcAppend('1')">1</button>
                <button class="calc-btn" onclick="calcAppend('2')">2</button>
                <button class="calc-btn" onclick="calcAppend('3')">3</button>
                <button class="calc-btn calc-btn-operator" onclick="calcAppend('+')">+</button>

                <button class="calc-btn" onclick="calcAppend('0')">0</button>
                <button class="calc-btn" onclick="calcAppend('.')">.</button>
                <button class="calc-btn" onclick="calcAppend('(')">(</button>
                <button class="calc-btn" onclick="calcAppend(')')">)</button>

                <button class="calc-btn calc-btn-equals" onclick="calcEquals()" style="grid-column: span 4;">=</button>
            </div>
        </div>
    </div>

    <script>
        // Calculator state
        let calcCurrentExpression = '';
        let calcCurrentResult = '0';
        let calculatorOpen = false;

        function toggleCalculator() {
            calculatorOpen = !calculatorOpen;
            const container = document.getElementById('calculatorContainer');
            if (calculatorOpen) {
                container.classList.add('active');
            } else {
                container.classList.remove('active');
            }
        }

        function closeCalculator() {
            if (calculatorOpen) {
                calculatorOpen = false;
                document.getElementById('calculatorContainer').classList.remove('active');
            }
        }

        // Close calculator when clicking outside
        document.addEventListener('click', (e) => {
            const toolbar = document.querySelector('.calculator-toolbar');
            const container = document.getElementById('calculatorContainer');

            // If click is outside the calculator toolbar and container, close it
            if (calculatorOpen && !toolbar.contains(e.target)) {
                closeCalculator();
            }
        });

        function calcAppend(value) {
            calcCurrentExpression += value;
            updateCalcDisplay();
        }

        function calcClear() {
            calcCurrentExpression = '';
            calcCurrentResult = '0';
            updateCalcDisplay();
        }

        function calcBackspace() {
            calcCurrentExpression = calcCurrentExpression.slice(0, -1);
            updateCalcDisplay();
        }

        function calcEquals() {
            if (!calcCurrentExpression) return;

            try {
                // Replace ^ with ** for JavaScript exponentiation
                let expression = calcCurrentExpression.replace(/\^/g, '**');

                // Evaluate the expression safely
                let result = Function('"use strict"; return (' + expression + ')')();

                // Round to 4 decimal places to avoid floating point issues
                if (typeof result === 'number') {
                    calcCurrentResult = Number(result.toFixed(4)).toString();
                } else {
                    calcCurrentResult = result.toString();
                }
            } catch (error) {
                calcCurrentResult = 'Error';
            }

            updateCalcDisplay();
        }

        function updateCalcDisplay() {
            document.getElementById('calcExpression').textContent = calcCurrentExpression || '\u00A0';
            document.getElementById('calcResult').textContent = calcCurrentResult;
        }

        // Allow keyboard input for calculator (only when calculator is open)
        document.addEventListener('keydown', (e) => {
            if (document.activeElement.id === 'answerInput') return; // Don't interfere with answer input
            if (!calculatorOpen) return; // Only work when calculator is open

            if (e.key >= '0' && e.key <= '9') {
                calcAppend(e.key);
            } else if (e.key === '.') {
                calcAppend('.');
            } else if (e.key === '+' || e.key === '-' || e.key === '*' || e.key === '/') {
                calcAppend(e.key);
            } else if (e.key === '^') {
                calcAppend('^');
            } else if (e.key === 'Enter' && calcCurrentExpression) {
                calcEquals();
            } else if (e.key === 'Backspace' && calcCurrentExpression) {
                e.preventDefault();
                calcBackspace();
            } else if (e.key === 'Escape') {
                calcClear();
            } else if (e.key === '(' || e.key === ')') {
                calcAppend(e.key);
            }
        });

        // Format answer based on unit type
        function formatAnswer(value, unit) {
            if (unit === 'dollars') return '$' + value.toLocaleString();
            if (unit === 'percent') return value + '%';
            if (unit === 'choice') return 'Option ' + value;
            return value.toString();
        }

        // Worked examples for each problem type
        const workedExamples = {
            "coc_001": {
                problem: "A firm has equity value E=$400M and debt D=$600M. What fraction of the firm's value is equity (as a percentage)?",
                steps: [
                    { explanation: "Identify the values:", calculation: "\\(E = \\$400M\\), \\(D = \\$600M\\)" },
                    { explanation: "Calculate total firm value:", calculation: "\\(V = E + D = 400 + 600 = \\$1{,}000M\\)" },
                    { explanation: "Calculate equity fraction:", calculation: "\\(E/V = 400 / 1{,}000 = 0.40\\)" },
                    { explanation: "Convert to percentage:", calculation: "\\(0.40 \\times 100 = 40.00\\%\\)" }
                ],
                answer: "40.00%"
            },
            "coc_002": {
                problem: "WidgetCo has equity market cap $300M, debt $700M, cost of equity 12%, cost of debt 5%. Calculate the unlevered cost of capital.",
                steps: [
                    { explanation: "Identify the values:", calculation: "\\(E = \\$300M\\), \\(D = \\$700M\\), \\(r_E = 12\\%\\), \\(r_D = 5\\%\\)" },
                    { explanation: "Calculate total firm value:", calculation: "\\(V = E + D = 300 + 700 = \\$1{,}000M\\)" },
                    { explanation: "Calculate equity weight:", calculation: "\\(E/V = 300/1{,}000 = 0.30\\)" },
                    { explanation: "Calculate debt weight:", calculation: "\\(D/V = 700/1{,}000 = 0.70\\)" },
                    { explanation: "Apply unlevered cost of capital formula:", calculation: "\\(r_U = (E/V) \\times r_E + (D/V) \\times r_D = 0.30 \\times 12\\% + 0.70 \\times 5\\%\\)" },
                    { explanation: "Calculate:", calculation: "\\(r_U = 3.60\\% + 3.50\\% = 7.10\\%\\)" }
                ],
                answer: "7.10%"
            },
            "coc_003": {
                problem: "WidgetCo has E=$300M, D=$700M, r_E=12%, r_D=5%, and tax rate=35%. Calculate the WACC.",
                steps: [
                    { explanation: "Identify the values:", calculation: "\\(E = \\$300M\\), \\(D = \\$700M\\), \\(r_E = 12\\%\\), \\(r_D = 5\\%\\), \\(T_c = 35\\%\\)" },
                    { explanation: "Calculate weights:", calculation: "\\(E/V = 300/1{,}000 = 0.30\\), \\(D/V = 700/1{,}000 = 0.70\\)" },
                    { explanation: "Apply WACC formula:", calculation: "\\(WACC = (E/V) \\times r_E + (D/V) \\times r_D \\times (1 - T_c)\\)" },
                    { explanation: "Plug in values:", calculation: "\\(WACC = 0.30 \\times 12\\% + 0.70 \\times 5\\% \\times (1 - 0.35)\\)" },
                    { explanation: "Calculate each term:", calculation: "\\(= 3.60\\% + 0.70 \\times 5\\% \\times 0.65 = 3.60\\% + 2.275\\%\\)" },
                    { explanation: "Final answer:", calculation: "\\(WACC = 5.88\\%\\)" }
                ],
                answer: "5.88%"
            },
            "coc_004": {
                problem: "Using CAPM: risk-free rate=2%, equity beta=0.8, market risk premium=6%. What is the cost of equity capital?",
                steps: [
                    { explanation: "Identify the variables:", calculation: "\\(r_f = 2\\%\\), \\(\\beta_E = 0.8\\), \\(MRP = 6\\%\\)" },
                    { explanation: "Write the CAPM formula:", calculation: "\\(r_E = r_f + \\beta_E \\times (MRP)\\)" },
                    { explanation: "Plug in values:", calculation: "\\(r_E = 2\\% + 0.8 \\times 6\\%\\)" },
                    { explanation: "Calculate:", calculation: "\\(r_E = 2\\% + 4.8\\% = 6.8\\%\\)" }
                ],
                answer: "6.8%"
            },
            "coc_005": {
                problem: "Cost of debt using credit spreads: risk-free rate=2%, bond spread for A-rated 10-year debt=125bps. What is the cost of debt capital?",
                steps: [
                    { explanation: "Identify the variables:", calculation: "\\(r_f = 2\\%\\), \\(\\text{credit spread} = 125 \\text{ bps}\\)" },
                    { explanation: "Convert basis points to percentage:", calculation: "\\(125 \\text{ bps} = 1.25\\%\\)" },
                    { explanation: "Apply credit spread method:", calculation: "\\(r_D = r_f + \\text{credit spread}\\)" },
                    { explanation: "Calculate:", calculation: "\\(r_D = 2\\% + 1.25\\% = 3.25\\%\\)" }
                ],
                answer: "3.25%"
            },
            "coc_006": {
                problem: "Apex Corp: equity=$300M, debt=$500M, r_E=8%, r_D=4%, tax rate=30%. Calculate the WACC.",
                steps: [
                    { explanation: "Identify the values:", calculation: "\\(E = \\$300M\\), \\(D = \\$500M\\), \\(r_E = 8\\%\\), \\(r_D = 4\\%\\), \\(T_c = 30\\%\\)" },
                    { explanation: "Calculate total firm value:", calculation: "\\(V = 300 + 500 = \\$800M\\)" },
                    { explanation: "Calculate weights:", calculation: "\\(E/V = 300/800 = 0.375\\), \\(D/V = 500/800 = 0.625\\)" },
                    { explanation: "Apply WACC formula:", calculation: "\\(WACC = (E/V) \\times r_E + (D/V) \\times r_D \\times (1 - T_c)\\)" },
                    { explanation: "Plug in:", calculation: "\\(WACC = 0.375 \\times 8\\% + 0.625 \\times 4\\% \\times (1 - 0.30)\\)" },
                    { explanation: "Calculate:", calculation: "\\(WACC = 3.00\\% + 0.625 \\times 4\\% \\times 0.70 = 3.00\\% + 1.75\\% = 4.75\\%\\)" }
                ],
                answer: "4.75%"
            },
            "coc_007": {
                problem: "A firm has equity beta of 1.60 and debt-to-value ratio D/V=0.40. Debt beta=0.30. What is the unlevered (asset) beta?",
                steps: [
                    { explanation: "Identify the values:", calculation: "\\(\\beta_E = 1.60\\), \\(D/V = 0.40\\), \\(\\beta_D = 0.30\\)" },
                    { explanation: "Calculate E/V:", calculation: "\\(E/V = 1 - D/V = 1 - 0.40 = 0.60\\)" },
                    { explanation: "Apply the unlevered beta formula:", calculation: "\\(\\beta_U = (E/V) \\times \\beta_E + (D/V) \\times \\beta_D\\)" },
                    { explanation: "Plug in values:", calculation: "\\(\\beta_U = 0.60 \\times 1.60 + 0.40 \\times 0.30\\)" },
                    { explanation: "Calculate:", calculation: "\\(\\beta_U = 0.96 + 0.12 = 1.08\\)" }
                ],
                answer: "1.08"
            },
            "coc_008": {
                problem: "A firm has equity beta=1.30, D/V=0.30, debt beta=0.15. Calculate the unlevered beta.",
                steps: [
                    { explanation: "Identify the values:", calculation: "\\(\\beta_E = 1.30\\), \\(D/V = 0.30\\), \\(\\beta_D = 0.15\\)" },
                    { explanation: "Calculate E/V:", calculation: "\\(E/V = 1 - D/V = 1 - 0.30 = 0.70\\)" },
                    { explanation: "Apply unlevered beta formula:", calculation: "\\(\\beta_U = (E/V) \\times \\beta_E + (D/V) \\times \\beta_D\\)" },
                    { explanation: "Plug in values:", calculation: "\\(\\beta_U = 0.70 \\times 1.30 + 0.30 \\times 0.15\\)" },
                    { explanation: "Calculate:", calculation: "\\(\\beta_U = 0.91 + 0.045 = 0.955 \\approx 0.96\\)" }
                ],
                answer: "0.96"
            },
            "coc_009": {
                problem: "A conglomerate has a chemicals division (low risk) and a biotech division (high risk). The firm's overall WACC is 9%. The chemicals division has a cost of capital of 7% and the biotech division has a cost of capital of 13%. Should the firm use 9% to evaluate all projects?",
                steps: [
                    { explanation: "Consider what happens if we use the firm-wide 9% WACC:", calculation: "Chemicals projects need 7% return; Biotech projects need 13% return" },
                    { explanation: "Using 9% for chemicals division:", calculation: "Would reject good chemicals projects that earn 7-9% (too high a hurdle)" },
                    { explanation: "Using 9% for biotech division:", calculation: "Would accept bad biotech projects that earn 9-13% (too low a hurdle)" },
                    { explanation: "Conclusion:", calculation: "The firm should NOT use a single rate when divisions have different risk profiles" }
                ],
                answer: "Option 2"
            },
            "coc_010": {
                problem: "TechStartup Inc. is a private company considering entering the cloud storage market. Why might they look at comparable public companies like Dropbox or Box to estimate their cost of capital?",
                steps: [
                    { explanation: "Consider why direct estimation is difficult:", calculation: "Private companies have no publicly traded stock, so beta cannot be observed directly" },
                    { explanation: "Consider the project context:", calculation: "Even if the firm were public, a new project may have different risk than existing operations" },
                    { explanation: "The comparable firm approach:", calculation: "Use betas from similar public firms, unlever them, then relever for the target capital structure" },
                    { explanation: "Conclusion:", calculation: "Comparable firms provide observable market data when direct estimation is impossible" }
                ],
                answer: "Option 3"
            }
        };

        // Problems data embedded directly to avoid CORS issues
        let problems = [
            {
                "id": "coc_001",
                "topic": "Capital Structure Weights",
                "difficulty": "easy",
                "problem_text": "A firm has equity value E=$200M and debt D=$600M. What fraction of the firm's value is equity (as a percentage)?",
                "given": {
                    "equity": 200,
                    "debt": 600
                },
                "formula": "\\(E/V = E / (E + D)\\)",
                "solution_steps": [
                    "Step 1: Identify the values: \\(E = \\$200M\\), \\(D = \\$600M\\)",
                    "Step 2: Calculate total firm value: \\(V = E + D = 200 + 600 = \\$800M\\)",
                    "Step 3: Calculate equity fraction: \\(E/V = 200 / 800 = 0.25\\)",
                    "Step 4: Convert to percentage: \\(0.25 \\times 100 = 25\\%\\)"
                ],
                "correct_answer": 25,
                "tolerance": 0.5,
                "unit": "percent",
                "hints": {
                    "level_1": "First calculate total firm value \\(V = E + D\\), then divide \\(E\\) by \\(V\\)",
                    "level_2": "\\(V = 200 + 600 = 800\\). Now divide \\(E\\) by \\(V\\) and multiply by 100",
                    "level_3": "\\(E/V = 200/800 = 0.25 \\rightarrow 25\\%\\)"
                }
            },
            {
                "id": "coc_002",
                "topic": "Unlevered Cost of Capital",
                "difficulty": "medium",
                "problem_text": "Ridgeline Corp has equity market cap $200M, debt $600M, cost of equity 12%, cost of debt 5%. Calculate the unlevered cost of capital (as a percentage).",
                "given": {
                    "equity": 200,
                    "debt": 600,
                    "cost_of_equity": 0.12,
                    "cost_of_debt": 0.05
                },
                "formula": "\\(r_U = (E/V) \\times r_E + (D/V) \\times r_D\\)",
                "solution_steps": [
                    "Step 1: Identify: \\(E = \\$200M\\), \\(D = \\$600M\\), \\(r_E = 12\\%\\), \\(r_D = 5\\%\\)",
                    "Step 2: Calculate \\(V = E + D = 200 + 600 = \\$800M\\)",
                    "Step 3: Calculate weights: \\(E/V = 200/800 = 0.25\\), \\(D/V = 600/800 = 0.75\\)",
                    "Step 4: Apply formula: \\(r_U = 0.25 \\times 12\\% + 0.75 \\times 5\\%\\)",
                    "Step 5: Calculate: \\(r_U = 3.00\\% + 3.75\\% = 6.75\\%\\)"
                ],
                "correct_answer": 6.75,
                "tolerance": 0.1,
                "unit": "percent",
                "hints": {
                    "level_1": "The unlevered cost of capital is the weighted average of equity and debt costs, using market value weights",
                    "level_2": "First find \\(V = E + D = 800\\). Then \\(r_U = (E/V) \\times r_E + (D/V) \\times r_D\\)",
                    "level_3": "\\(r_U = (200/800) \\times 12\\% + (600/800) \\times 5\\% = 3.00\\% + 3.75\\%\\)"
                }
            },
            {
                "id": "coc_003",
                "topic": "WACC",
                "difficulty": "medium",
                "problem_text": "Using the same Ridgeline data (E=$200M, D=$600M, r_E=12%, r_D=5%) and a corporate tax rate of 25%, calculate the WACC (as a percentage).",
                "given": {
                    "equity": 200,
                    "debt": 600,
                    "cost_of_equity": 0.12,
                    "cost_of_debt": 0.05,
                    "tax_rate": 0.25
                },
                "formula": "\\(WACC = (E/V) \\times r_E + (D/V) \\times r_D \\times (1 - T_c)\\)",
                "solution_steps": [
                    "Step 1: Identify: \\(E = \\$200M\\), \\(D = \\$600M\\), \\(r_E = 12\\%\\), \\(r_D = 5\\%\\), \\(T_c = 25\\%\\)",
                    "Step 2: Calculate \\(V = 200 + 600 = \\$800M\\)",
                    "Step 3: Weights: \\(E/V = 200/800 = 0.25\\), \\(D/V = 600/800 = 0.75\\)",
                    "Step 4: Apply WACC formula: \\(WACC = 0.25 \\times 12\\% + 0.75 \\times 5\\% \\times (1 - 0.25)\\)",
                    "Step 5: Calculate: \\(WACC = 3.00\\% + 0.75 \\times 5\\% \\times 0.75\\)",
                    "Step 6: \\(WACC = 3.00\\% + 2.8125\\% = 5.81\\%\\)"
                ],
                "correct_answer": 5.81,
                "tolerance": 0.1,
                "unit": "percent",
                "hints": {
                    "level_1": "WACC is like the unlevered cost of capital, but the debt term gets multiplied by \\((1 - \\text{tax rate})\\) to account for the interest tax shield",
                    "level_2": "\\(WACC = (E/V) \\times r_E + (D/V) \\times r_D \\times (1 - T_c)\\). Remember \\((1 - 0.25) = 0.75\\) only applies to the debt cost term",
                    "level_3": "\\(WACC = (200/800) \\times 12\\% + (600/800) \\times 5\\% \\times 0.75 = 3.00\\% + 2.8125\\%\\)"
                }
            },
            {
                "id": "coc_004",
                "topic": "CAPM - Cost of Equity",
                "difficulty": "medium",
                "problem_text": "Using CAPM: risk-free rate=2%, equity beta=0.6, market risk premium=6%. What is the cost of equity capital (as a percentage)?",
                "given": {
                    "risk_free_rate": 0.02,
                    "beta": 0.6,
                    "market_risk_premium": 0.06
                },
                "formula": "\\(r_E = r_f + \\beta_E \\times (\\text{Market Risk Premium})\\)",
                "solution_steps": [
                    "Step 1: Identify: \\(r_f = 2\\%\\), \\(\\beta_E = 0.6\\), \\(MRP = 6\\%\\)",
                    "Step 2: Apply CAPM: \\(r_E = r_f + \\beta_E \\times MRP\\)",
                    "Step 3: Plug in: \\(r_E = 2\\% + 0.6 \\times 6\\%\\)",
                    "Step 4: Calculate: \\(r_E = 2\\% + 3.6\\% = 5.6\\%\\)"
                ],
                "correct_answer": 5.6,
                "tolerance": 0.1,
                "unit": "percent",
                "hints": {
                    "level_1": "CAPM says the cost of equity equals the risk-free rate plus a risk premium based on the firm's beta",
                    "level_2": "\\(r_E = r_f + \\beta \\times (\\text{Market Risk Premium})\\). Just plug in the three given values",
                    "level_3": "\\(r_E = 2\\% + 0.6 \\times 6\\% = 2\\% + 3.6\\% = 5.6\\%\\)"
                }
            },
            {
                "id": "coc_005",
                "topic": "Cost of Debt - Credit Spreads",
                "difficulty": "medium",
                "problem_text": "Cost of debt using credit spreads: risk-free rate=2%, bond spread for A-rated 5-year debt=150bps. What is the cost of debt capital (as a percentage)?",
                "given": {
                    "risk_free_rate": 0.02,
                    "credit_spread_bps": 150
                },
                "formula": "\\(r_D = r_f + \\text{credit spread}\\)",
                "solution_steps": [
                    "Step 1: Identify: \\(r_f = 2\\%\\), \\(\\text{credit spread} = 150 \\text{ bps}\\)",
                    "Step 2: Convert basis points to percentage: \\(150 \\text{ bps} = 1.5\\%\\)",
                    "Step 3: Apply formula: \\(r_D = r_f + \\text{credit spread}\\)",
                    "Step 4: Calculate: \\(r_D = 2\\% + 1.5\\% = 3.5\\%\\)"
                ],
                "correct_answer": 3.5,
                "tolerance": 0.1,
                "unit": "percent",
                "hints": {
                    "level_1": "The cost of debt is estimated by adding the credit spread to the risk-free rate. Remember: \\(100 \\text{ bps} = 1\\%\\)",
                    "level_2": "\\(r_D = r_f + \\text{credit spread}\\). Convert \\(150 \\text{ bps}\\) to \\(1.5\\%\\) first",
                    "level_3": "\\(r_D = 2\\% + 1.5\\% = 3.5\\%\\)"
                }
            },
            {
                "id": "coc_006",
                "topic": "WACC Calculation",
                "difficulty": "hard",
                "problem_text": "Beacon Corp: equity=$150M, debt=$350M, r_E=5.6%, r_D=3.5%, tax rate=20%. Calculate the WACC (as a percentage).",
                "given": {
                    "equity": 150,
                    "debt": 350,
                    "cost_of_equity": 0.056,
                    "cost_of_debt": 0.035,
                    "tax_rate": 0.20
                },
                "formula": "\\(WACC = (E/V) \\times r_E + (D/V) \\times r_D \\times (1 - T_c)\\)",
                "solution_steps": [
                    "Step 1: Identify: \\(E = \\$150M\\), \\(D = \\$350M\\), \\(r_E = 5.6\\%\\), \\(r_D = 3.5\\%\\), \\(T_c = 20\\%\\)",
                    "Step 2: Calculate \\(V = 150 + 350 = \\$500M\\)",
                    "Step 3: Weights: \\(E/V = 150/500 = 0.30\\), \\(D/V = 350/500 = 0.70\\)",
                    "Step 4: Apply WACC: \\(WACC = 0.30 \\times 5.6\\% + 0.70 \\times 3.5\\% \\times (1 - 0.20)\\)",
                    "Step 5: Calculate: \\(WACC = 1.68\\% + 0.70 \\times 3.5\\% \\times 0.80\\)",
                    "Step 6: \\(WACC = 1.68\\% + 1.96\\% = 3.64\\%\\)"
                ],
                "correct_answer": 3.64,
                "tolerance": 0.1,
                "unit": "percent",
                "hints": {
                    "level_1": "Use the WACC formula with tax adjustment on the debt cost component",
                    "level_2": "\\(WACC = (E/V) \\times r_E + (D/V) \\times r_D \\times (1 - T_c)\\). \\(V = E + D = \\$500M\\)",
                    "level_3": "\\(WACC = (150/500) \\times 5.6\\% + (350/500) \\times 3.5\\% \\times 0.80 = 1.68\\% + 1.96\\%\\)"
                }
            },
            {
                "id": "coc_007",
                "topic": "Unlevered Beta",
                "difficulty": "hard",
                "problem_text": "A firm has equity beta of 2.00 and debt-to-value ratio D/V=0.50. Debt beta=0.20. What is the unlevered (asset) beta? (Enter as a decimal, e.g. 1.10)",
                "given": {
                    "equity_beta": 2.00,
                    "d_over_v": 0.50,
                    "debt_beta": 0.20
                },
                "formula": "\\(\\beta_U = (E/V) \\times \\beta_E + (D/V) \\times \\beta_D\\)",
                "solution_steps": [
                    "Step 1: Identify: \\(\\beta_E = 2.00\\), \\(D/V = 0.50\\), \\(\\beta_D = 0.20\\)",
                    "Step 2: Calculate \\(E/V = 1 - D/V = 1 - 0.50 = 0.50\\)",
                    "Step 3: Apply unlevered beta formula: \\(\\beta_U = (E/V) \\times \\beta_E + (D/V) \\times \\beta_D\\)",
                    "Step 4: Plug in: \\(\\beta_U = 0.50 \\times 2.00 + 0.50 \\times 0.20\\)",
                    "Step 5: Calculate: \\(\\beta_U = 1.00 + 0.10 = 1.10\\)"
                ],
                "correct_answer": 1.10,
                "tolerance": 0.05,
                "unit": "decimal",
                "hints": {
                    "level_1": "The unlevered beta is a weighted average of equity beta and debt beta, using value weights",
                    "level_2": "First find \\(E/V = 1 - D/V = 1 - 0.50 = 0.50\\). Then \\(\\beta_U = (E/V) \\times \\beta_E + (D/V) \\times \\beta_D\\)",
                    "level_3": "\\(\\beta_U = 0.50 \\times 2.00 + 0.50 \\times 0.20 = 1.00 + 0.10 = 1.10\\)"
                }
            },
            {
                "id": "coc_008",
                "topic": "Unlevered Beta",
                "difficulty": "medium",
                "problem_text": "A firm has equity beta=1.50, D/V=0.40, debt beta=0.10. Calculate the unlevered beta. (Enter as a decimal, e.g. 0.94)",
                "given": {
                    "equity_beta": 1.50,
                    "d_over_v": 0.40,
                    "debt_beta": 0.10
                },
                "formula": "\\(\\beta_U = (E/V) \\times \\beta_E + (D/V) \\times \\beta_D\\)",
                "solution_steps": [
                    "Step 1: Identify: \\(\\beta_E = 1.50\\), \\(D/V = 0.40\\), \\(\\beta_D = 0.10\\)",
                    "Step 2: Calculate \\(E/V = 1 - D/V = 1 - 0.40 = 0.60\\)",
                    "Step 3: Apply formula: \\(\\beta_U = (E/V) \\times \\beta_E + (D/V) \\times \\beta_D\\)",
                    "Step 4: Plug in: \\(\\beta_U = 0.60 \\times 1.50 + 0.40 \\times 0.10\\)",
                    "Step 5: Calculate: \\(\\beta_U = 0.90 + 0.04 = 0.94\\)"
                ],
                "correct_answer": 0.94,
                "tolerance": 0.05,
                "unit": "decimal",
                "hints": {
                    "level_1": "Use the same unlevered beta formula: \\(\\beta_U = (E/V) \\times \\beta_E + (D/V) \\times \\beta_D\\)",
                    "level_2": "\\(E/V = 1 - 0.40 = 0.60\\). Then calculate the weighted average of the two betas",
                    "level_3": "\\(\\beta_U = 0.60 \\times 1.50 + 0.40 \\times 0.10 = 0.90 + 0.04 = 0.94\\)"
                }
            },
            {
                "id": "coc_009",
                "topic": "Company-Wide Discount Rate",
                "difficulty": "medium",
                "type": "choice",
                "problem_text": "When should you NOT use a single company-wide discount rate to evaluate projects?",
                "choices": [
                    "When all projects have the same risk",
                    "When the firm has multiple divisions with different risk profiles",
                    "When the firm only has equity financing",
                    "When the risk-free rate is very low"
                ],
                "formula": "Different projects/divisions may have different risk, requiring different discount rates",
                "solution_steps": [
                    "Step 1: A single company-wide WACC assumes all projects have similar risk to the firm as a whole",
                    "Step 2: If the firm has multiple divisions with different risk profiles, using one rate leads to errors",
                    "Step 3: Low-risk divisions would have too high a hurdle rate (rejecting good projects)",
                    "Step 4: High-risk divisions would have too low a hurdle rate (accepting bad projects)",
                    "Step 5: Answer: When the firm has multiple divisions with different risk profiles"
                ],
                "correct_answer": 2,
                "tolerance": 0,
                "unit": "choice",
                "hints": {
                    "level_1": "Think about what happens when different parts of a company face very different levels of risk",
                    "level_2": "If a conglomerate uses one discount rate, what happens to projects in its safe division vs. its risky division?",
                    "level_3": "A single rate overpenalizes safe projects and underpenalizes risky ones when divisions differ"
                }
            },
            {
                "id": "coc_010",
                "topic": "Comparable Firms",
                "difficulty": "medium",
                "type": "choice",
                "problem_text": "Why do firms use comparable firms to estimate cost of capital?",
                "choices": [
                    "Comparable firms always have the same stock price",
                    "It's legally required by the SEC",
                    "The firm may be private or the project may differ from the firm's overall business, making direct estimation impossible",
                    "Comparable firms have lower costs of capital"
                ],
                "formula": "Comparable firms provide observable betas and capital structure data for estimation",
                "solution_steps": [
                    "Step 1: Private firms do not have publicly traded equity, so their beta cannot be directly observed",
                    "Step 2: Even for public firms, a new project may have very different risk than the firm's existing operations",
                    "Step 3: Comparable firms in the same industry provide observable betas and market data",
                    "Step 4: The process: find comps, unlever their betas, then relever for the target capital structure",
                    "Step 5: Answer: The firm may be private or the project may differ from the firm's overall business"
                ],
                "correct_answer": 3,
                "tolerance": 0,
                "unit": "choice",
                "hints": {
                    "level_1": "Think about what data you need to estimate cost of capital and when that data might not be available",
                    "level_2": "How would a private company estimate its equity beta if it has no publicly traded stock?",
                    "level_3": "Comparable firms provide market-based data (betas, capital structure) when direct observation is impossible"
                }
            }
        ];

        let currentProblemIndex = 0;
        let attemptCount = 0;
        let completedProblems = new Set();
        let selectedChoice = null;

        // Spaced repetition tracking
        const TOPIC_KEY = 'costofcapital'; // Unique key for this topic
        const MISSED_PROBLEMS_KEY = 'finance_missed_costofcapital';
        const MASTERED_PROBLEMS_KEY = 'finance_mastered_costofcapital';

        // Check if we're in review mode (URL parameter)
        const urlParams = new URLSearchParams(window.location.search);
        const reviewMode = urlParams.get('review') === 'true';

        function getMissedProblems() {
            const stored = localStorage.getItem(MISSED_PROBLEMS_KEY);
            return stored ? JSON.parse(stored) : {};
        }

        function getMasteredProblems() {
            const stored = localStorage.getItem(MASTERED_PROBLEMS_KEY);
            return stored ? JSON.parse(stored) : {};
        }

        function saveMissedProblem(problemId) {
            const missed = getMissedProblems();
            missed[problemId] = {
                count: (missed[problemId]?.count || 0) + 1,
                lastMissed: new Date().toISOString()
            };
            localStorage.setItem(MISSED_PROBLEMS_KEY, JSON.stringify(missed));
        }

        function markProblemMastered(problemId) {
            // Remove from missed
            const missed = getMissedProblems();
            delete missed[problemId];
            localStorage.setItem(MISSED_PROBLEMS_KEY, JSON.stringify(missed));

            // Add to mastered
            const mastered = getMasteredProblems();
            mastered[problemId] = {
                masteredOn: new Date().toISOString()
            };
            localStorage.setItem(MASTERED_PROBLEMS_KEY, JSON.stringify(mastered));
        }

        function filterProblemsForReview() {
            if (!reviewMode) return problems;

            const missed = getMissedProblems();
            const missedIds = Object.keys(missed);

            if (missedIds.length === 0) {
                return []; // No problems to review
            }

            return problems.filter(p => missedIds.includes(p.id));
        }

        // Load problems on page load
        function loadProblems() {
            // Filter problems if in review mode
            if (reviewMode) {
                const reviewProblems = filterProblemsForReview();
                if (reviewProblems.length === 0) {
                    showNoProblemsToReview();
                    return;
                }
                problems = reviewProblems;
                // Update header to show review mode
                document.querySelector('h1').textContent = 'The Cost of Capital - Review';
                document.querySelector('.subtitle').textContent = 'Reviewing missed problems';
            }
            displayProblem();
        }

        function showNoProblemsToReview() {
            const problemCard = document.getElementById('problemCard');
            problemCard.innerHTML = `
                <div style="text-align: center; padding: 3rem;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">üéâ</div>
                    <h2 style="font-size: 1.75rem; margin-bottom: 1rem; color: #2D3748;">No Problems to Review!</h2>
                    <p style="font-size: 1.1rem; color: #4A5568; margin-bottom: 2rem;">
                        You've mastered all the problems you previously missed. Great work!
                    </p>
                    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                        <a href="week8-costofcapital.html" class="btn-primary" style="text-decoration: none; display: inline-block; padding: 0.75rem 2rem;">Practice All Problems</a>
                        <a href="index.html" class="btn-secondary" style="text-decoration: none; display: inline-block; padding: 0.75rem 2rem;">Back to Topics</a>
                    </div>
                </div>
            `;
        }

        // Toggle worked example visibility
        function toggleWorkedExample() {
            const toggle = document.getElementById('workedExampleToggle');
            const toggleText = document.getElementById('toggleText');
            toggle.classList.toggle('expanded');
            toggleText.textContent = toggle.classList.contains('expanded') ? 'Hide' : 'Show';
        }

        // Populate worked example content
        function displayWorkedExample(problemId) {
            const example = workedExamples[problemId];
            const container = document.getElementById('workedExampleContent');
            const toggle = document.getElementById('workedExampleToggle');

            // Reset to collapsed state
            toggle.classList.remove('expanded');
            document.getElementById('toggleText').textContent = 'Show';

            if (!example) {
                toggle.style.display = 'none';
                return;
            }

            toggle.style.display = 'block';

            let stepsHtml = example.steps.map((step, index) => `
                <div class="example-step">
                    <span class="example-step-number">${index + 1}</span>
                    <div class="example-step-content">
                        <div class="example-step-explanation">${step.explanation}</div>
                        <div class="example-step-calculation">${step.calculation}</div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = `
                <div class="example-problem">
                    <div class="example-label">Example Problem</div>
                    <div class="example-text">${example.problem}</div>
                </div>
                <div class="example-solution">
                    <div class="example-label">Step-by-Step Solution</div>
                    ${stepsHtml}
                    <div class="example-final-answer">
                        <div class="example-final-answer-label">Final Answer</div>
                        <div class="example-final-answer-value">${example.answer}</div>
                    </div>
                </div>
            `;
        }

        function displayProblem() {
            if (problems.length === 0) return;

            const problem = problems[currentProblemIndex];
            attemptCount = 0;
            selectedChoice = null;

            // Update progress
            const progress = ((currentProblemIndex) / problems.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressText').textContent =
                `Problem ${currentProblemIndex + 1} of ${problems.length}`;

            // Update difficulty badge
            const difficultyBadge = document.getElementById('difficultyBadge');
            difficultyBadge.textContent = problem.difficulty.charAt(0).toUpperCase() + problem.difficulty.slice(1);
            difficultyBadge.className = 'badge badge-' + problem.difficulty;

            // Update topic badge
            document.getElementById('topicBadge').textContent = problem.topic;

            // Display worked example for this problem
            displayWorkedExample(problem.id);

            // Update problem text
            document.getElementById('problemText').textContent = problem.problem_text;

            // Update formula (but keep it hidden initially)
            document.getElementById('formulaText').textContent = problem.formula;
            document.getElementById('formulaBox').classList.add('hidden');

            // Handle answer section based on problem type
            const answerSection = document.getElementById('answerSection');
            if (problem.type === 'choice') {
                // Render multiple choice
                let choicesHtml = '<div class="choices-container">';
                problem.choices.forEach((choice, index) => {
                    choicesHtml += `
                        <button class="choice-btn" onclick="selectChoice(${index + 1})" id="choice-${index + 1}">
                            <span class="choice-number">${index + 1}</span>
                            <span>${choice}</span>
                        </button>
                    `;
                });
                choicesHtml += '</div>';
                choicesHtml += '<button class="btn-primary" id="submitBtn" onclick="checkAnswer()" style="margin-top: 1rem;">Submit</button>';
                answerSection.innerHTML = choicesHtml;
            } else {
                // Render numerical input
                answerSection.innerHTML = `
                    <div class="input-group">
                        <label for="answerInput">Your Answer:</label>
                        <input type="number" id="answerInput" step="0.01" placeholder="Enter your answer">
                        <button class="btn-primary" id="submitBtn" onclick="checkAnswer()">Submit</button>
                    </div>
                `;
                // Re-attach enter key listener
                document.getElementById('answerInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !document.getElementById('submitBtn').disabled) {
                        checkAnswer();
                    }
                });
            }

            // Clear feedback
            document.getElementById('feedbackBox').className = 'hidden';

            // Render LaTeX
            renderMath();

            // Update navigation buttons
            document.getElementById('prevBtn').disabled = currentProblemIndex === 0;
            document.getElementById('nextBtn').textContent =
                currentProblemIndex === problems.length - 1 ? 'Finish' : 'Next Problem';
        }

        function selectChoice(choiceNumber) {
            selectedChoice = choiceNumber;
            // Update visual selection
            document.querySelectorAll('.choice-btn').forEach(btn => btn.classList.remove('selected'));
            document.getElementById('choice-' + choiceNumber).classList.add('selected');
        }

        function checkAnswer() {
            const problem = problems[currentProblemIndex];
            let userAnswer;

            if (problem.type === 'choice') {
                if (selectedChoice === null) {
                    showFeedback('Please select an answer', 'incorrect');
                    return;
                }
                userAnswer = selectedChoice;
            } else {
                userAnswer = parseFloat(document.getElementById('answerInput').value);
                if (isNaN(userAnswer)) {
                    showFeedback('Please enter a valid number', 'incorrect');
                    return;
                }
            }

            // Smart tolerance: allow for rounding errors from intermediate calculations
            const percentTolerance = Math.abs(problem.correct_answer) * 0.005; // 0.5%
            const minTolerance = problem.unit === 'percent' ? 0.05 : (problem.unit === 'choice' ? 0 : 1);
            const calculatedTolerance = Math.max(percentTolerance, minTolerance);

            // Use problem-specific tolerance if provided, otherwise use calculated tolerance
            const tolerance = problem.tolerance !== undefined ? problem.tolerance : calculatedTolerance;

            const isCorrect = Math.abs(userAnswer - problem.correct_answer) <= tolerance;

            attemptCount++;

            if (isCorrect) {
                completedProblems.add(currentProblemIndex);
                // If correct on first attempt, mark as mastered
                if (attemptCount === 1) {
                    markProblemMastered(problem.id);
                }
                showCorrectFeedback();
            } else {
                // Track this as a missed problem
                saveMissedProblem(problem.id);
                showIncorrectFeedback();
            }
        }

        function showFeedback(message, type) {
            const feedbackBox = document.getElementById('feedbackBox');
            feedbackBox.className = 'feedback-box feedback-' + type;
            feedbackBox.innerHTML = `<div class="feedback-title">${message}</div>`;
        }

        function showCorrectFeedback() {
            const problem = problems[currentProblemIndex];
            const feedbackBox = document.getElementById('feedbackBox');

            let html = `
                <div class="feedback-title">
                    Correct!
                </div>
                <div class="feedback-content">
                    Great job! The correct answer is ${formatAnswer(problem.correct_answer, problem.unit || 'dollars')}.
                </div>
            `;

            feedbackBox.className = 'feedback-box feedback-correct';
            feedbackBox.innerHTML = html;

            document.getElementById('submitBtn').disabled = true;
            renderMath();
        }

        function showIncorrectFeedback() {
            const problem = problems[currentProblemIndex];
            const feedbackBox = document.getElementById('feedbackBox');

            let html = `
                <div class="feedback-title">
                    Not quite right
                </div>
            `;

            // Adaptive feedback based on attempt count
            if (attemptCount === 1) {
                html += `
                    <div class="hint-box">
                        <strong>Hint:</strong> ${problem.hints.level_1}
                    </div>
                `;
            } else if (attemptCount === 2) {
                // Show formula on second attempt
                document.getElementById('formulaBox').classList.remove('hidden');
                html += `
                    <div class="hint-box">
                        <strong>Formula revealed above.</strong> ${problem.hints.level_2}
                    </div>
                `;
            } else if (attemptCount === 3) {
                // Keep formula visible
                document.getElementById('formulaBox').classList.remove('hidden');
                html += `
                    <div class="hint-box">
                        <strong>Detailed hint:</strong> ${problem.hints.level_3}
                    </div>
                    <div style="margin-top: 1rem;">
                        <button class="btn-secondary" onclick="showFullSolution()">Show Full Solution</button>
                    </div>
                `;
            } else {
                // After 3 attempts, show full solution automatically
                showFullSolution();
                return;
            }

            feedbackBox.className = 'feedback-box feedback-incorrect';
            feedbackBox.innerHTML = html;
            renderMath();
        }

        function showFullSolution() {
            const problem = problems[currentProblemIndex];
            const feedbackBox = document.getElementById('feedbackBox');

            let html = `
                <div class="feedback-title">
                    Solution
                </div>
                <div class="solution-steps">
            `;

            problem.solution_steps.forEach((step, index) => {
                html += `
                    <div class="solution-step">
                        <span class="step-number">Step ${index + 1}:</span> ${step}
                    </div>
                `;
            });

            html += `
                </div>
                <div class="feedback-content" style="margin-top: 1rem; padding-top: 1rem; border-top: 2px solid #E2E8F0;">
                    <strong>Final Answer:</strong> ${formatAnswer(problem.correct_answer, problem.unit || 'dollars')}
                </div>
            `;

            feedbackBox.className = 'feedback-box feedback-correct';
            feedbackBox.innerHTML = html;

            document.getElementById('submitBtn').disabled = true;
            renderMath();
        }

        function nextProblem() {
            if (currentProblemIndex < problems.length - 1) {
                currentProblemIndex++;
                displayProblem();
            } else {
                showSummary();
            }
        }

        function previousProblem() {
            if (currentProblemIndex > 0) {
                currentProblemIndex--;
                displayProblem();
            }
        }

        function showSummary() {
            const problemCard = document.getElementById('problemCard');
            const completed = completedProblems.size;
            const total = problems.length;
            const percentage = Math.round((completed / total) * 100);

            // Check how many problems are in the missed queue
            const missed = getMissedProblems();
            const missedCount = Object.keys(missed).length;

            let reviewButton = '';
            if (missedCount > 0 && !reviewMode) {
                reviewButton = `
                    <a href="week8-costofcapital.html?review=true" class="btn-primary" style="text-decoration: none; display: inline-block; background-color: #DD6B20;">
                        Review ${missedCount} Missed Problem${missedCount > 1 ? 's' : ''}
                    </a>
                `;
            }

            let celebrationMessage = '';
            if (reviewMode && completed === total) {
                celebrationMessage = `
                    <div style="background-color: #C6F6D5; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        <strong>Excellent!</strong> You've mastered these previously missed problems!
                    </div>
                `;
            }

            problemCard.innerHTML = `
                <div style="text-align: center; padding: 3rem;">
                    <h2 style="font-size: 2rem; margin-bottom: 1rem;">${reviewMode ? 'Review Session Complete!' : 'Practice Session Complete!'}</h2>
                    ${celebrationMessage}
                    <div style="font-size: 3rem; font-weight: bold; color: #2C5282; margin: 2rem 0;">
                        ${completed} / ${total}
                    </div>
                    <div style="font-size: 1.25rem; color: #4A5568; margin-bottom: 2rem;">
                        You got ${percentage}% of problems correct on the first try!
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                        ${reviewButton}
                        <button class="btn-primary" onclick="location.href='week8-costofcapital.html'">Practice All</button>
                        <a href="index.html" class="btn-secondary" style="text-decoration: none; display: inline-block;">Back to Topics</a>
                    </div>
                </div>
            `;
        }

        function renderMath() {
            setTimeout(() => {
                if (typeof renderMathInElement === 'function') {
                    renderMathInElement(document.body, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '\\(', right: '\\)', display: false}
                        ],
                        throwOnError: false
                    });
                }
            }, 100);
        }

        // Allow Enter key to submit
        document.addEventListener('DOMContentLoaded', () => {
            const answerInput = document.getElementById('answerInput');
            if (answerInput) {
                answerInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !document.getElementById('submitBtn').disabled) {
                        checkAnswer();
                    }
                });
            }
            loadProblems();
        });
    </script>
</body>
</html>
