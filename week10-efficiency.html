<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Practice Tool - Investing &amp; Market Efficiency</title>

    <!-- KaTeX for LaTeX rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #ffffff;
            color: #1a1a1a;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            background-color: #2C5282;
            color: white;
            padding: 2rem;
            margin-bottom: 2rem;
            border-radius: 8px;
        }

        .header-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .back-link {
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .back-link:hover {
            color: white;
        }

        h1 {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }

        .progress-bar {
            background-color: #E2E8F0;
            height: 8px;
            border-radius: 4px;
            margin: 1.5rem 0;
            overflow: hidden;
        }

        .progress-fill {
            background-color: #48BB78;
            height: 100%;
            transition: width 0.3s ease;
        }

        .problem-card {
            background: white;
            border: 2px solid #E2E8F0;
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .problem-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #E2E8F0;
        }

        .problem-meta {
            display: flex;
            gap: 1rem;
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .badge-easy { background-color: #C6F6D5; color: #22543D; }
        .badge-medium { background-color: #FEF3C7; color: #78350F; }
        .badge-hard { background-color: #FED7D7; color: #742A2A; }

        .problem-number {
            font-size: 0.875rem;
            color: #718096;
            font-weight: 500;
        }

        .problem-text {
            font-size: 1.125rem;
            line-height: 1.8;
            margin-bottom: 2rem;
            color: #2D3748;
        }

        .formula-box {
            background-color: #F7FAFC;
            border-left: 4px solid #2C5282;
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            border-radius: 4px;
        }

        .formula-label {
            font-size: 0.875rem;
            color: #4A5568;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .answer-section {
            margin: 2rem 0;
        }

        .input-group {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        label {
            font-weight: 500;
            color: #2D3748;
        }

        input[type="number"] {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 2px solid #CBD5E0;
            border-radius: 6px;
            font-size: 1.125rem;
            transition: border-color 0.2s;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #2C5282;
        }

        button {
            padding: 0.75rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: #2C5282;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2A4365;
        }

        .btn-primary:disabled {
            background-color: #CBD5E0;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: #E2E8F0;
            color: #2D3748;
        }

        .btn-secondary:hover {
            background-color: #CBD5E0;
        }

        .feedback-box {
            margin-top: 1.5rem;
            padding: 1.5rem;
            border-radius: 8px;
            border: 2px solid;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .feedback-correct {
            background-color: #F0FFF4;
            border-color: #48BB78;
            color: #22543D;
        }

        .feedback-incorrect {
            background-color: #FFF5F5;
            border-color: #F56565;
            color: #742A2A;
        }

        .feedback-title {
            font-weight: 600;
            font-size: 1.125rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .feedback-content {
            margin-top: 1rem;
            line-height: 1.8;
        }

        .hint-box {
            background-color: #EBF8FF;
            border-left: 4px solid #3182CE;
            padding: 1rem 1.5rem;
            margin-top: 1rem;
            border-radius: 4px;
        }

        .solution-steps {
            margin-top: 1rem;
        }

        .solution-step {
            padding: 0.75rem 0;
            border-bottom: 1px solid #E2E8F0;
        }

        .solution-step:last-child {
            border-bottom: none;
        }

        .step-number {
            font-weight: 600;
            color: #2C5282;
        }

        .navigation {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .navigation button {
            flex: 1;
        }

        .hidden {
            display: none;
        }

        /* Calculator Styles */
        .calculator-toolbar {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .calculator-toggle-btn {
            background-color: #2C5282;
            color: white;
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 50px;
            font-size: 1.125rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .calculator-toggle-btn:hover {
            background-color: #2A4365;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }

        .calculator-container {
            position: absolute;
            bottom: 70px;
            right: 0;
            width: 320px;
            background-color: #F7FAFC;
            border: 2px solid #E2E8F0;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            padding: 1rem;
            display: none;
        }

        .calculator-container.active {
            display: block;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .calculator-display {
            background-color: #2D3748;
            color: #48BB78;
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            font-family: 'Courier New', monospace;
            font-size: 1.25rem;
            text-align: right;
            min-height: 50px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .calculator-expression {
            font-size: 0.875rem;
            color: #CBD5E0;
            margin-bottom: 0.25rem;
        }

        .calculator-result {
            font-size: 1.25rem;
            color: #48BB78;
            font-weight: 600;
        }

        .calculator-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
        }

        .calc-btn {
            padding: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            border: 1px solid #CBD5E0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            background-color: white;
            color: #2D3748;
        }

        .calc-btn:hover {
            background-color: #EDF2F7;
            transform: translateY(-1px);
        }

        .calc-btn:active {
            transform: translateY(0);
        }

        .calc-btn-operator {
            background-color: #2C5282;
            color: white;
            border-color: #2C5282;
        }

        .calc-btn-operator:hover {
            background-color: #2A4365;
        }

        .calc-btn-equals {
            background-color: #48BB78;
            color: white;
            border-color: #48BB78;
        }

        .calc-btn-equals:hover {
            background-color: #38A169;
        }

        .calc-btn-clear {
            background-color: #F56565;
            color: white;
            border-color: #F56565;
        }

        .calc-btn-clear:hover {
            background-color: #E53E3E;
        }


        /* Worked Example Toggle Styles */
        .worked-example-toggle {
            background: linear-gradient(135deg, #EBF8FF 0%, #E6FFFA 100%);
            border: 2px solid #3182CE;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .worked-example-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .worked-example-header:hover {
            background-color: rgba(49, 130, 206, 0.1);
        }

        .worked-example-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
            color: #2C5282;
        }

        .worked-example-title .icon {
            font-size: 1.25rem;
        }

        .worked-example-subtitle {
            font-size: 0.85rem;
            color: #4A5568;
            font-weight: 400;
        }

        .toggle-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #3182CE;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .toggle-arrow {
            transition: transform 0.3s ease;
            font-size: 1.25rem;
        }

        .worked-example-toggle.expanded .toggle-arrow {
            transform: rotate(180deg);
        }

        .worked-example-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, padding 0.4s ease;
            background-color: #F7FAFC;
        }

        .worked-example-toggle.expanded .worked-example-content {
            max-height: 2000px;
            padding: 1.5rem;
            border-top: 1px solid #BEE3F8;
        }

        .example-problem {
            background: white;
            border-radius: 6px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            border-left: 4px solid #3182CE;
        }

        .example-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #3182CE;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .example-text {
            color: #2D3748;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .example-solution {
            background: white;
            border-radius: 6px;
            padding: 1.25rem;
        }

        .example-step {
            display: flex;
            gap: 1rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid #E2E8F0;
        }

        .example-step:last-child {
            border-bottom: none;
        }

        .example-step-number {
            background-color: #3182CE;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .example-step-content {
            flex: 1;
        }

        .example-step-explanation {
            color: #4A5568;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .example-step-calculation {
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            background-color: #EDF2F7;
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            font-size: 0.9rem;
            color: #2D3748;
        }

        .example-final-answer {
            background: linear-gradient(135deg, #48BB78 0%, #38A169 100%);
            color: white;
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
            text-align: center;
        }

        .example-final-answer-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            opacity: 0.9;
        }

        .example-final-answer-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .now-try-badge {
            background-color: #48BB78;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            h1 {
                font-size: 1.5rem;
            }

            .problem-card {
                padding: 1.5rem;
            }

            .input-group {
                flex-direction: column;
                align-items: stretch;
            }

            .navigation {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-nav">
                <a href="index.html" class="back-link">&larr; Back to Topics</a>
            </div>
            <h1>Investing &amp; Market Efficiency</h1>
            <div class="subtitle">Week 10 - MGMT 408</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: 0%"></div>
            </div>
            <div class="problem-number" id="progressText">Problem 1 of 10</div>
        </header>

        <div class="problem-card" id="problemCard">
            <div class="problem-header">
                <div class="problem-meta">
                    <span class="badge" id="difficultyBadge">Easy</span>
                    <span class="badge" style="background-color: #EBF8FF; color: #2C5282;" id="topicBadge">Topic</span>
                </div>
            </div>

            <!-- Worked Example Toggle -->
            <div class="worked-example-toggle" id="workedExampleToggle">
                <div class="worked-example-header" onclick="toggleWorkedExample()">
                    <div class="worked-example-title">
                        <span class="icon">&#x1F4D6;</span>
                        <span>
                            See Worked Example
                            <div class="worked-example-subtitle">Similar problem with step-by-step solution</div>
                        </span>
                    </div>
                    <div class="toggle-indicator">
                        <span class="toggle-text" id="toggleText">Show</span>
                        <span class="toggle-arrow">&#x25BC;</span>
                    </div>
                </div>
                <div class="worked-example-content" id="workedExampleContent">
                    <!-- Content populated by JavaScript -->
                </div>
            </div>

            <div class="now-try-badge">&#x270F;&#xFE0F; Now You Try</div>

            <div class="problem-text" id="problemText">
                Loading problem...
            </div>

            <div class="formula-box hidden" id="formulaBox">
                <div class="formula-label">Formula:</div>
                <div id="formulaText"></div>
            </div>

            <div class="answer-section">
                <div class="input-group">
                    <label for="answerInput">Your Answer:</label>
                    <input type="number" id="answerInput" step="0.01" placeholder="Enter your answer">
                    <button class="btn-primary" id="submitBtn" onclick="checkAnswer()">Submit</button>
                </div>
            </div>

            <div id="feedbackBox" class="hidden"></div>

            <div class="navigation">
                <button class="btn-secondary" id="prevBtn" onclick="previousProblem()">Previous</button>
                <button class="btn-secondary" id="nextBtn" onclick="nextProblem()">Next Problem</button>
            </div>
        </div>
    </div>

    <!-- Calculator Toolbar -->
    <div class="calculator-toolbar">
        <button class="calculator-toggle-btn" onclick="toggleCalculator()">
            Calculator
        </button>
        <div class="calculator-container" id="calculatorContainer">
            <div class="calculator-display">
                <div class="calculator-expression" id="calcExpression">&nbsp;</div>
                <div class="calculator-result" id="calcResult">0</div>
            </div>
            <div class="calculator-buttons">
                <button class="calc-btn calc-btn-clear" onclick="calcClear()">AC</button>
                <button class="calc-btn" onclick="calcBackspace()">Del</button>
                <button class="calc-btn calc-btn-operator" onclick="calcAppend('^')">x^y</button>
                <button class="calc-btn calc-btn-operator" onclick="calcAppend('/')">&#xF7;</button>

                <button class="calc-btn" onclick="calcAppend('7')">7</button>
                <button class="calc-btn" onclick="calcAppend('8')">8</button>
                <button class="calc-btn" onclick="calcAppend('9')">9</button>
                <button class="calc-btn calc-btn-operator" onclick="calcAppend('*')">x</button>

                <button class="calc-btn" onclick="calcAppend('4')">4</button>
                <button class="calc-btn" onclick="calcAppend('5')">5</button>
                <button class="calc-btn" onclick="calcAppend('6')">6</button>
                <button class="calc-btn calc-btn-operator" onclick="calcAppend('-')">-</button>

                <button class="calc-btn" onclick="calcAppend('1')">1</button>
                <button class="calc-btn" onclick="calcAppend('2')">2</button>
                <button class="calc-btn" onclick="calcAppend('3')">3</button>
                <button class="calc-btn calc-btn-operator" onclick="calcAppend('+')">+</button>

                <button class="calc-btn" onclick="calcAppend('0')">0</button>
                <button class="calc-btn" onclick="calcAppend('.')">.</button>
                <button class="calc-btn" onclick="calcAppend('(')">(</button>
                <button class="calc-btn" onclick="calcAppend(')')">)</button>

                <button class="calc-btn calc-btn-equals" onclick="calcEquals()" style="grid-column: span 4;">=</button>
            </div>
        </div>
    </div>

    <script>
        // Calculator state
        let calcCurrentExpression = '';
        let calcCurrentResult = '0';
        let calculatorOpen = false;

        function toggleCalculator() {
            calculatorOpen = !calculatorOpen;
            const container = document.getElementById('calculatorContainer');
            if (calculatorOpen) {
                container.classList.add('active');
            } else {
                container.classList.remove('active');
            }
        }

        function closeCalculator() {
            if (calculatorOpen) {
                calculatorOpen = false;
                document.getElementById('calculatorContainer').classList.remove('active');
            }
        }

        // Close calculator when clicking outside
        document.addEventListener('click', (e) => {
            const toolbar = document.querySelector('.calculator-toolbar');
            const container = document.getElementById('calculatorContainer');

            // If click is outside the calculator toolbar and container, close it
            if (calculatorOpen && !toolbar.contains(e.target)) {
                closeCalculator();
            }
        });

        function calcAppend(value) {
            calcCurrentExpression += value;
            updateCalcDisplay();
        }

        function calcClear() {
            calcCurrentExpression = '';
            calcCurrentResult = '0';
            updateCalcDisplay();
        }

        function calcBackspace() {
            calcCurrentExpression = calcCurrentExpression.slice(0, -1);
            updateCalcDisplay();
        }

        function calcEquals() {
            if (!calcCurrentExpression) return;

            try {
                // Replace ^ with ** for JavaScript exponentiation
                let expression = calcCurrentExpression.replace(/\^/g, '**');

                // Evaluate the expression safely
                let result = Function('"use strict"; return (' + expression + ')')();

                // Round to 4 decimal places to avoid floating point issues
                if (typeof result === 'number') {
                    calcCurrentResult = Number(result.toFixed(4)).toString();
                } else {
                    calcCurrentResult = result.toString();
                }
            } catch (error) {
                calcCurrentResult = 'Error';
            }

            updateCalcDisplay();
        }

        function updateCalcDisplay() {
            document.getElementById('calcExpression').textContent = calcCurrentExpression || '\u00A0';
            document.getElementById('calcResult').textContent = calcCurrentResult;
        }

        // Allow keyboard input for calculator (only when calculator is open)
        document.addEventListener('keydown', (e) => {
            if (document.activeElement.id === 'answerInput') return; // Don't interfere with answer input
            if (!calculatorOpen) return; // Only work when calculator is open

            if (e.key >= '0' && e.key <= '9') {
                calcAppend(e.key);
            } else if (e.key === '.') {
                calcAppend('.');
            } else if (e.key === '+' || e.key === '-' || e.key === '*' || e.key === '/') {
                calcAppend(e.key);
            } else if (e.key === '^') {
                calcAppend('^');
            } else if (e.key === 'Enter' && calcCurrentExpression) {
                calcEquals();
            } else if (e.key === 'Backspace' && calcCurrentExpression) {
                e.preventDefault();
                calcBackspace();
            } else if (e.key === 'Escape') {
                calcClear();
            } else if (e.key === '(' || e.key === ')') {
                calcAppend(e.key);
            }
        });

        // Format answer based on unit type
        function formatAnswer(value, unit) {
            if (unit === 'dollars') return '$' + value.toLocaleString();
            if (unit === 'percent') return value + '%';
            if (unit === 'choice') return 'Option ' + value;
            return value.toString();
        }

        // Worked examples for each problem type
        const workedExamples = {
            "efficiency_001": {
                problem: "According to the Efficient Markets Hypothesis, which of the following investment strategies should consistently generate abnormal returns? (1) Buying stocks with low P/E ratios (2) Buying after stock prices rise (3) None of the above - no strategy should consistently beat the market (4) Buying stocks mentioned on social media",
                steps: [
                    { explanation: "Recall the core idea of EMH:", calculation: "EMH states that security prices fully reflect available information" },
                    { explanation: "What this means for investors:", calculation: "If prices already reflect information, you cannot use that information to earn abnormal returns" },
                    { explanation: "Evaluate the options:", calculation: "Low P/E, momentum, and social media signals are all publicly available information" },
                    { explanation: "Under EMH, public info is already in prices:", calculation: "No strategy based on public information should consistently beat the market" }
                ],
                answer: "Option 3"
            },
            "efficiency_002": {
                problem: "A technical analyst claims she can predict stock price movements by studying chart patterns. Which form of market efficiency would her strategy violate? (1) Weak-form efficiency (2) Semi-strong-form efficiency (3) Strong-form efficiency (4) None of the above",
                steps: [
                    { explanation: "Recall the three forms of market efficiency:", calculation: "Weak: prices reflect past prices. Semi-strong: prices reflect all public info. Strong: prices reflect all info including private." },
                    { explanation: "Technical analysis uses past price data (charts, patterns):", calculation: "This is exactly the information set described by weak-form efficiency" },
                    { explanation: "If weak-form efficiency holds:", calculation: "Past price patterns cannot predict future price movements" },
                    { explanation: "Therefore, a profitable technical strategy would violate:", calculation: "Weak-form efficiency (the least restrictive form)" }
                ],
                answer: "Option 1"
            },
            "efficiency_003": {
                problem: "A hedge fund reads SEC filings immediately after they are published and trades on the information. Under which form of efficiency would this strategy fail to earn abnormal returns? (1) Weak-form only (2) Semi-strong-form efficiency (3) Strong-form only (4) No form of efficiency",
                steps: [
                    { explanation: "Identify what type of information SEC filings are:", calculation: "SEC filings are publicly available information once published" },
                    { explanation: "Recall what semi-strong efficiency says:", calculation: "Prices reflect ALL publicly available information, not just past prices" },
                    { explanation: "If semi-strong efficiency holds:", calculation: "Stock prices adjust immediately to new public information (like SEC filings)" },
                    { explanation: "Therefore trading on public filings would fail under:", calculation: "Semi-strong-form efficiency (prices already incorporate this info)" }
                ],
                answer: "Option 2"
            },
            "efficiency_004": {
                problem: "You form a leveraged portfolio: 150% invested in the market portfolio and -50% borrowed at the risk-free rate. If the market expected return is 12% and risk-free rate is 4%, what is the portfolio's expected return?",
                steps: [
                    { explanation: "Identify the portfolio weights:", calculation: "\\(w_{\\text{market}} = 1.5\\) (150%), \\(w_{rf} = -0.5\\) (-50% borrowed)" },
                    { explanation: "Write the portfolio expected return formula:", calculation: "\\(E[R_P] = w_{\\text{market}} \\times E[R_m] + w_{rf} \\times R_f\\)" },
                    { explanation: "Plug in values:", calculation: "\\(E[R_P] = 1.5 \\times 12\\% + (-0.5) \\times 4\\%\\)" },
                    { explanation: "Calculate each term:", calculation: "\\(= 18\\% - 2\\% = 16\\%\\)" }
                ],
                answer: "16%"
            },
            "efficiency_005": {
                problem: "A portfolio is 150% invested in the market and -50% in the risk-free asset. What is the portfolio's beta?",
                steps: [
                    { explanation: "Recall that beta is the weighted sum of component betas:", calculation: "\\(\\beta_P = w_{\\text{market}} \\times \\beta_{\\text{market}} + w_{rf} \\times \\beta_{rf}\\)" },
                    { explanation: "Recall key beta values:", calculation: "\\(\\beta_{\\text{market}} = 1\\), \\(\\beta_{rf} = 0\\) (risk-free has zero market risk)" },
                    { explanation: "Plug in portfolio weights:", calculation: "\\(\\beta_P = 1.5 \\times 1 + (-0.5) \\times 0\\)" },
                    { explanation: "Simplify:", calculation: "\\(\\beta_P = 1.5 + 0 = 1.5\\)" }
                ],
                answer: "1.5"
            },
            "efficiency_006": {
                problem: "A stock has an expected return of 16%. The CAPM predicts its return should be 12% (given \\(r_f=2\\%\\), \\(\\beta=1.25\\), market premium = 8%). What is the stock's alpha?",
                steps: [
                    { explanation: "Recall the definition of alpha:", calculation: "\\(\\alpha\\) = Actual (or expected) return - CAPM predicted return" },
                    { explanation: "Verify the CAPM prediction:", calculation: "\\(E[R] = r_f + \\beta \\times (E[R_m] - r_f) = 2\\% + 1.25 \\times 8\\% = 2\\% + 10\\% = 12\\%\\)" },
                    { explanation: "Calculate alpha:", calculation: "\\(\\alpha = 16\\% - 12\\% = 4\\%\\)" },
                    { explanation: "Interpretation:", calculation: "Positive \\(\\alpha\\) means the stock is expected to outperform its CAPM benchmark by 4%" }
                ],
                answer: "4%"
            },
            "efficiency_007": {
                problem: "The 'value premium' anomaly refers to: (1) Growth stocks consistently outperform value stocks (2) Stocks with high book-to-market ratios tend to earn higher average returns (3) All stocks converge to the same value over time (4) Dividends predict future stock returns",
                steps: [
                    { explanation: "Recall the definition of value stocks:", calculation: "Value stocks have high book-to-market ratios (low price relative to book value)" },
                    { explanation: "The empirical finding:", calculation: "Fama and French documented that value stocks (high B/M) historically earn higher returns than growth stocks (low B/M)" },
                    { explanation: "This is called the 'value premium':", calculation: "It is captured by the HML (High Minus Low) factor in the Fama-French model" },
                    { explanation: "Evaluate the options:", calculation: "Option 2 correctly describes the value premium anomaly" }
                ],
                answer: "Option 2"
            },
            "efficiency_008": {
                problem: "What does the evidence say about the performance of individual stock-pickers (day traders)? (1) Most consistently beat the market (2) About half beat the market consistently (3) The vast majority underperform after trading costs (4) Performance is random and unpredictable",
                steps: [
                    { explanation: "Consider the academic evidence on individual traders:", calculation: "Studies by Barber and Odean show most individual traders underperform" },
                    { explanation: "Key finding:", calculation: "Active individual traders earn lower returns than passive investors, primarily due to transaction costs and poor timing" },
                    { explanation: "The more you trade, the worse you tend to do:", calculation: "Overconfidence leads to excessive trading, which erodes returns through fees and bid-ask spreads" },
                    { explanation: "This is consistent with market efficiency:", calculation: "If markets are efficient, active trading costs reduce returns below market benchmarks" }
                ],
                answer: "Option 3"
            },
            "efficiency_009": {
                problem: "Which of the following best describes the Fama-French 5-factor model? (1) CAPM plus size, value, profitability, and investment factors (2) CAPM plus momentum, liquidity, and two volatility factors (3) Five separate measures of market beta (4) A model that only applies to bonds",
                steps: [
                    { explanation: "Start with the original CAPM:", calculation: "CAPM: \\(E[R] = r_f + \\beta \\times (E[R_m] - r_f)\\) -- one factor: market risk" },
                    { explanation: "Fama-French 3-factor model adds:", calculation: "SMB (Small Minus Big = size) and HML (High Minus Low = value)" },
                    { explanation: "Fama-French 5-factor model further adds:", calculation: "RMW (Robust Minus Weak = profitability) and CMA (Conservative Minus Aggressive = investment)" },
                    { explanation: "So the 5-factor model is:", calculation: "Market + Size + Value + Profitability + Investment = Option 1" }
                ],
                answer: "Option 1"
            },
            "efficiency_010": {
                problem: "Suppose researchers discover a new anomaly that earns 8% alpha per year. After the paper is published, how much alpha would you expect based on McLean and Pontiff's findings? (1) About 8% (2) About 3.2% (3) About 12% (4) About 0%",
                steps: [
                    { explanation: "Recall McLean and Pontiff's key finding:", calculation: "After publication, anomaly returns decline by approximately 58% (roughly 60%)" },
                    { explanation: "This happens because:", calculation: "Once investors learn about an anomaly, they trade on it, which reduces the mispricing" },
                    { explanation: "Apply the 60% decline to 8% alpha:", calculation: "Post-publication \\(\\alpha = 8\\% \\times (1 - 0.60) = 8\\% \\times 0.40 = 3.2\\%\\)" },
                    { explanation: "Therefore:", calculation: "You would expect about 3.2% \\(\\alpha\\) after publication, which matches Option 2" }
                ],
                answer: "Option 2 (about 3.2%)"
            }
        };

        // Problems data embedded directly to avoid CORS issues
        let problems = [
            {
                "id": "efficiency_001",
                "topic": "Efficient Markets Hypothesis",
                "difficulty": "easy",
                "problem_text": "The Efficient Markets Hypothesis states that:\n\n(1) All investors earn the same return\n(2) Stock prices are always too high\n(3) All securities are fairly priced given publicly available information\n(4) Markets never crash",
                "given": {},
                "formula": "EMH: Prices reflect available information",
                "solution_steps": [
                    "Step 1: The EMH is about information being reflected in prices.",
                    "Step 2: Option (1) is wrong -- investors can earn different returns based on risk.",
                    "Step 3: Option (2) is wrong -- EMH says prices are 'fair,' not 'too high.'",
                    "Step 4: Option (4) is wrong -- EMH does not say markets cannot crash; crashes can reflect new information.",
                    "Step 5: Option (3) is correct -- EMH states securities are fairly priced given available information."
                ],
                "correct_answer": 3,
                "tolerance": 0,
                "unit": "choice",
                "hints": {
                    "level_1": "EMH is about information and pricing, not about preventing crashes or equalizing returns.",
                    "level_2": "Think about what 'efficient' means: prices quickly incorporate available information.",
                    "level_3": "The answer is the option about prices being fair given publicly available information."
                }
            },
            {
                "id": "efficiency_002",
                "topic": "Forms of Market Efficiency",
                "difficulty": "easy",
                "problem_text": "Which form of market efficiency states that prices reflect all information contained in past prices?\n\n(1) Strong-form efficiency\n(2) Semi-strong-form efficiency\n(3) Weak-form efficiency\n(4) Ultra-weak efficiency",
                "given": {},
                "formula": "Weak < Semi-Strong < Strong (increasing information sets)",
                "solution_steps": [
                    "Step 1: There are three forms of market efficiency: weak, semi-strong, and strong.",
                    "Step 2: Weak-form: prices reflect all past price and trading data.",
                    "Step 3: Semi-strong-form: prices reflect all publicly available information.",
                    "Step 4: Strong-form: prices reflect all information, including private/insider info.",
                    "Step 5: Option (4) 'Ultra-weak efficiency' is not a real category.",
                    "Step 6: The answer is (3) Weak-form efficiency."
                ],
                "correct_answer": 3,
                "tolerance": 0,
                "unit": "choice",
                "hints": {
                    "level_1": "The three forms are ordered by how much information prices reflect: past prices, all public info, or all info.",
                    "level_2": "The weakest form says prices only reflect past price history -- making technical analysis useless.",
                    "level_3": "Weak-form efficiency = past prices already in current prices. Answer is option 3."
                }
            },
            {
                "id": "efficiency_003",
                "topic": "Semi-Strong Efficiency",
                "difficulty": "medium",
                "problem_text": "Semi-strong-form efficiency means that:\n\n(1) Only insider information can generate alpha\n(2) Prices reflect all publicly available information\n(3) Prices only reflect past price data\n(4) Technical analysis can generate alpha",
                "given": {},
                "formula": "Semi-strong: Prices reflect all public information",
                "solution_steps": [
                    "Step 1: Semi-strong-form efficiency says prices reflect ALL publicly available information.",
                    "Step 2: This includes past prices, financial statements, news, analyst reports, etc.",
                    "Step 3: Option (3) is wrong -- that describes weak-form efficiency only.",
                    "Step 4: Option (4) is wrong -- if prices reflect all public info, technical analysis (which uses public price data) cannot generate alpha.",
                    "Step 5: Option (1) is a consequence: if all public info is priced in, only non-public (insider) info could generate alpha.",
                    "Step 6: But the question asks what semi-strong efficiency MEANS, not its consequence. The answer is (2)."
                ],
                "correct_answer": 2,
                "tolerance": 0,
                "unit": "choice",
                "hints": {
                    "level_1": "Semi-strong is the middle level -- more than just past prices, but not insider info.",
                    "level_2": "Semi-strong says all publicly available information is reflected in prices.",
                    "level_3": "The definition is option (2): prices reflect all publicly available information."
                }
            },
            {
                "id": "efficiency_004",
                "topic": "Leveraged Portfolios",
                "difficulty": "medium",
                "problem_text": "You form a leveraged portfolio: 150% invested in the market portfolio and -50% borrowed at the risk-free rate. If the market expected return is 12% and the risk-free rate is 2%, what is the portfolio's expected return? (Enter as a percentage, e.g., 17 for 17%)",
                "given": {
                    "w_market": 1.5,
                    "w_rf": -0.5,
                    "E_Rm": 0.12,
                    "Rf": 0.02
                },
                "formula": "\\(E[R_P] = w_{\\text{market}} \\times E[R_m] + w_{rf} \\times R_f\\)",
                "solution_steps": [
                    "Step 1: Identify portfolio weights: \\(w_{\\text{market}} = 1.5\\) (150%), \\(w_{rf} = -0.5\\) (-50% borrowed).",
                    "Step 2: Note that weights sum to 1: \\(1.5 + (-0.5) = 1.0\\).",
                    "Step 3: Apply the portfolio return formula: \\(E[R_P] = w_{\\text{market}} \\times E[R_m] + w_{rf} \\times R_f\\).",
                    "Step 4: \\(E[R_P] = 1.5 \\times 12\\% + (-0.5) \\times 2\\%\\).",
                    "Step 5: \\(E[R_P] = 18\\% - 1\\% = 17\\%\\)."
                ],
                "correct_answer": 17,
                "tolerance": 0.5,
                "unit": "percent",
                "hints": {
                    "level_1": "A leveraged portfolio borrows at the risk-free rate to invest more in the market.",
                    "level_2": "\\(E[R_P] = w_{\\text{market}} \\times E[R_m] + w_{rf} \\times R_f\\). The weights must sum to 1.",
                    "level_3": "Calculate: \\(1.5 \\times 12\\% + (-0.5) \\times 2\\% = 18\\% - 1\\% = 17\\%\\)."
                }
            },
            {
                "id": "efficiency_005",
                "topic": "Portfolio Beta",
                "difficulty": "medium",
                "problem_text": "Using the same leveraged portfolio (150% in the market portfolio, -50% in the risk-free asset), what is the portfolio's beta? (Enter as a number, e.g., 1.5 for beta = 1.5)",
                "given": {
                    "w_market": 1.5,
                    "w_rf": -0.5,
                    "beta_market": 1.0,
                    "beta_rf": 0.0
                },
                "formula": "\\(\\beta_P = w_{\\text{market}} \\times \\beta_{\\text{market}} + w_{rf} \\times \\beta_{rf}\\)",
                "solution_steps": [
                    "Step 1: Portfolio beta is the weighted average of component betas.",
                    "Step 2: \\(\\beta_{\\text{market}} = 1.0\\) (by definition), \\(\\beta_{rf} = 0\\) (risk-free has zero systematic risk).",
                    "Step 3: \\(\\beta_P = 1.5 \\times 1.0 + (-0.5) \\times 0\\).",
                    "Step 4: \\(\\beta_P = 1.5 + 0 = 1.5\\)."
                ],
                "correct_answer": 1.5,
                "tolerance": 0.01,
                "unit": "decimal",
                "hints": {
                    "level_1": "Beta of a portfolio is the weighted average of individual betas.",
                    "level_2": "The market portfolio has \\(\\beta = 1\\), and the risk-free asset has \\(\\beta = 0\\).",
                    "level_3": "\\(\\beta_P = 1.5 \\times 1 + (-0.5) \\times 0 = 1.5\\)."
                }
            },
            {
                "id": "efficiency_006",
                "topic": "Alpha (CAPM)",
                "difficulty": "medium",
                "problem_text": "A stock has an expected return of 15%. The CAPM predicts its return should be 12% (given r_f = 2%, beta = 1.25, market risk premium = 8%). What is the stock's alpha? (Enter as a percentage, e.g., 3 for 3%)",
                "given": {
                    "expected_return": 0.15,
                    "capm_return": 0.12,
                    "rf": 0.02,
                    "beta": 1.25,
                    "market_premium": 0.08
                },
                "formula": "\\(\\alpha = E[R] - [r_f + \\beta \\times (E[R_m] - r_f)]\\)",
                "solution_steps": [
                    "Step 1: Verify the CAPM prediction: \\(E[R] = r_f + \\beta \\times \\text{market premium} = 2\\% + 1.25 \\times 8\\% = 12\\%\\).",
                    "Step 2: \\(\\alpha\\) = Actual expected return - CAPM predicted return.",
                    "Step 3: \\(\\alpha = 15\\% - 12\\% = 3\\%\\).",
                    "Step 4: A positive \\(\\alpha\\) of 3% means the stock is expected to outperform its risk-adjusted benchmark."
                ],
                "correct_answer": 3,
                "tolerance": 0.1,
                "unit": "percent",
                "hints": {
                    "level_1": "Alpha measures how much a stock's expected return exceeds its CAPM benchmark.",
                    "level_2": "\\(\\alpha\\) = Expected return - CAPM predicted return.",
                    "level_3": "\\(\\alpha = 15\\% - 12\\% = 3\\%\\)."
                }
            },
            {
                "id": "efficiency_007",
                "topic": "Market Anomalies",
                "difficulty": "medium",
                "problem_text": "The 'momentum' anomaly refers to:\n\n(1) Stocks that have gone up recently tend to continue going up over the next 6-12 months\n(2) All stocks eventually return to their average price\n(3) Large-cap stocks always outperform small-cap stocks\n(4) Bond yields predict stock returns",
                "given": {},
                "formula": "Momentum: Past winners continue to win, past losers continue to lose (6-12 month horizon)",
                "solution_steps": [
                    "Step 1: Momentum is one of the most well-documented anomalies in finance.",
                    "Step 2: It refers to the tendency for recent price trends to continue over a medium-term horizon.",
                    "Step 3: Option (2) describes 'mean reversion,' which is different from momentum.",
                    "Step 4: Option (3) is incorrect -- the size effect actually says small-cap stocks tend to outperform.",
                    "Step 5: Option (4) describes a different relationship entirely.",
                    "Step 6: The answer is (1): stocks that have gone up recently tend to continue going up over 6-12 months."
                ],
                "correct_answer": 1,
                "tolerance": 0,
                "unit": "choice",
                "hints": {
                    "level_1": "Momentum is about trends continuing, not reversing.",
                    "level_2": "Think 'winners keep winning' over a 6-12 month horizon.",
                    "level_3": "The answer is option (1): recent winners continue to outperform over 6-12 months."
                }
            },
            {
                "id": "efficiency_008",
                "topic": "Active vs. Passive Management",
                "difficulty": "medium",
                "problem_text": "According to the evidence, actively managed mutual funds on average:\n\n(1) Significantly outperform the market after fees\n(2) Roughly match or underperform the market after fees\n(3) Always beat index funds\n(4) Have zero risk",
                "given": {},
                "formula": "\\(\\text{Net return} = \\text{Gross return} - \\text{Management fees} - \\text{Trading costs}\\)",
                "solution_steps": [
                    "Step 1: Decades of research consistently show that actively managed funds struggle to beat the market.",
                    "Step 2: Before fees, the average active fund roughly matches the market (since they ARE the market in aggregate).",
                    "Step 3: After fees (typically 0.5% to 1.5% per year), most active funds underperform index funds.",
                    "Step 4: Option (1) is wrong -- the evidence shows the opposite.",
                    "Step 5: Option (3) is wrong -- most do not beat index funds, especially over long periods.",
                    "Step 6: Option (4) is wrong -- all equity funds have risk.",
                    "Step 7: The answer is (2): active funds on average roughly match or underperform the market after fees."
                ],
                "correct_answer": 2,
                "tolerance": 0,
                "unit": "choice",
                "hints": {
                    "level_1": "Think about what happens when you subtract management fees from market-average returns.",
                    "level_2": "Active managers in aggregate ARE the market, so before fees they match it. After fees...",
                    "level_3": "The answer is option (2): active funds roughly match or underperform after fees."
                }
            },
            {
                "id": "efficiency_009",
                "topic": "Fama-French Model",
                "difficulty": "hard",
                "problem_text": "The Fama-French 3-factor model extends the CAPM by adding which factors?\n\n(1) Inflation and GDP growth\n(2) Size (SMB) and value (HML)\n(3) Momentum and liquidity\n(4) Interest rates and exchange rates",
                "given": {},
                "formula": "\\(E[R] = r_f + \\beta_m(R_m - r_f) + \\beta_s \\cdot SMB + \\beta_v \\cdot HML\\)",
                "solution_steps": [
                    "Step 1: The CAPM has one factor: market risk (beta).",
                    "Step 2: Fama and French (1993) added two additional factors to better explain stock returns.",
                    "Step 3: SMB (Small Minus Big) captures the size effect: small stocks tend to outperform large stocks.",
                    "Step 4: HML (High Minus Low book-to-market) captures the value effect: value stocks tend to outperform growth stocks.",
                    "Step 5: Option (1) is wrong -- these are macroeconomic variables, not Fama-French factors.",
                    "Step 6: Option (3) is wrong -- momentum was added later by Carhart (1997) as a 4th factor.",
                    "Step 7: The answer is (2): Size (SMB) and Value (HML)."
                ],
                "correct_answer": 2,
                "tolerance": 0,
                "unit": "choice",
                "hints": {
                    "level_1": "Fama and French found two patterns CAPM could not explain: one related to firm size and one related to value.",
                    "level_2": "SMB stands for 'Small Minus Big' and HML stands for 'High Minus Low' (book-to-market).",
                    "level_3": "The answer is option (2): Size (SMB) and Value (HML)."
                }
            },
            {
                "id": "efficiency_010",
                "topic": "Publication Effect on Anomalies",
                "difficulty": "hard",
                "problem_text": "McLean and Pontiff (2015) found that after an anomaly is published in academic research, its alpha:\n\n(1) Increases by about 60%\n(2) Remains unchanged\n(3) Falls by about 60% on average\n(4) Becomes negative for all investors",
                "given": {},
                "formula": "Post-publication alpha declines as investors trade on the anomaly",
                "solution_steps": [
                    "Step 1: McLean and Pontiff (2015) studied 97 anomalies documented in academic papers.",
                    "Step 2: They compared anomaly returns before and after publication.",
                    "Step 3: Key finding: after publication, anomaly returns declined by approximately 58% (roughly 60%).",
                    "Step 4: This suggests that once investors learn about an anomaly, they trade on it, reducing the mispricing.",
                    "Step 5: Option (1) is the opposite of what happens.",
                    "Step 6: Option (2) is wrong -- publication clearly has an effect.",
                    "Step 7: Option (4) is too extreme -- alpha falls but does not necessarily become negative.",
                    "Step 8: The answer is (3): alpha falls by about 60% on average."
                ],
                "correct_answer": 3,
                "tolerance": 0,
                "unit": "choice",
                "hints": {
                    "level_1": "Think about what happens when many investors learn about a profitable strategy at the same time.",
                    "level_2": "When investors trade on a published anomaly, they reduce the mispricing that caused the alpha.",
                    "level_3": "The answer is option (3): alpha falls by about 60% after publication."
                }
            }
        ];

        let currentProblemIndex = 0;
        let attemptCount = 0;
        let completedProblems = new Set();

        // Spaced repetition tracking
        const TOPIC_KEY = 'efficiency'; // Unique key for this topic
        const MISSED_PROBLEMS_KEY = 'finance_missed_efficiency';
        const MASTERED_PROBLEMS_KEY = 'finance_mastered_efficiency';

        // Check if we're in review mode (URL parameter)
        const urlParams = new URLSearchParams(window.location.search);
        const reviewMode = urlParams.get('review') === 'true';

        function getMissedProblems() {
            const stored = localStorage.getItem(MISSED_PROBLEMS_KEY);
            return stored ? JSON.parse(stored) : {};
        }

        function getMasteredProblems() {
            const stored = localStorage.getItem(MASTERED_PROBLEMS_KEY);
            return stored ? JSON.parse(stored) : {};
        }

        function saveMissedProblem(problemId) {
            const missed = getMissedProblems();
            missed[problemId] = {
                count: (missed[problemId]?.count || 0) + 1,
                lastMissed: new Date().toISOString()
            };
            localStorage.setItem(MISSED_PROBLEMS_KEY, JSON.stringify(missed));
        }

        function markProblemMastered(problemId) {
            // Remove from missed
            const missed = getMissedProblems();
            delete missed[problemId];
            localStorage.setItem(MISSED_PROBLEMS_KEY, JSON.stringify(missed));

            // Add to mastered
            const mastered = getMasteredProblems();
            mastered[problemId] = {
                masteredOn: new Date().toISOString()
            };
            localStorage.setItem(MASTERED_PROBLEMS_KEY, JSON.stringify(mastered));
        }

        function filterProblemsForReview() {
            if (!reviewMode) return problems;

            const missed = getMissedProblems();
            const missedIds = Object.keys(missed);

            if (missedIds.length === 0) {
                return []; // No problems to review
            }

            return problems.filter(p => missedIds.includes(p.id));
        }

        // Load problems on page load
        function loadProblems() {
            // Filter problems if in review mode
            if (reviewMode) {
                const reviewProblems = filterProblemsForReview();
                if (reviewProblems.length === 0) {
                    showNoProblemsToReview();
                    return;
                }
                problems = reviewProblems;
                // Update header to show review mode
                document.querySelector('h1').textContent = 'Investing & Market Efficiency - Review';
                document.querySelector('.subtitle').textContent = 'Reviewing missed problems';
            }
            displayProblem();
        }

        function showNoProblemsToReview() {
            const problemCard = document.getElementById('problemCard');
            problemCard.innerHTML = `
                <div style="text-align: center; padding: 3rem;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">&#x1F389;</div>
                    <h2 style="font-size: 1.75rem; margin-bottom: 1rem; color: #2D3748;">No Problems to Review!</h2>
                    <p style="font-size: 1.1rem; color: #4A5568; margin-bottom: 2rem;">
                        You've mastered all the problems you previously missed. Great work!
                    </p>
                    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                        <a href="week10-efficiency.html" class="btn-primary" style="text-decoration: none; display: inline-block; padding: 0.75rem 2rem;">Practice All Problems</a>
                        <a href="index.html" class="btn-secondary" style="text-decoration: none; display: inline-block; padding: 0.75rem 2rem;">Back to Topics</a>
                    </div>
                </div>
            `;
        }

        // Toggle worked example visibility
        function toggleWorkedExample() {
            const toggle = document.getElementById('workedExampleToggle');
            const toggleText = document.getElementById('toggleText');
            toggle.classList.toggle('expanded');
            toggleText.textContent = toggle.classList.contains('expanded') ? 'Hide' : 'Show';
        }

        // Populate worked example content
        function displayWorkedExample(problemId) {
            const example = workedExamples[problemId];
            const container = document.getElementById('workedExampleContent');
            const toggle = document.getElementById('workedExampleToggle');

            // Reset to collapsed state
            toggle.classList.remove('expanded');
            document.getElementById('toggleText').textContent = 'Show';

            if (!example) {
                toggle.style.display = 'none';
                return;
            }

            toggle.style.display = 'block';

            let stepsHtml = example.steps.map((step, index) => `
                <div class="example-step">
                    <span class="example-step-number">${index + 1}</span>
                    <div class="example-step-content">
                        <div class="example-step-explanation">${step.explanation}</div>
                        <div class="example-step-calculation">${step.calculation}</div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = `
                <div class="example-problem">
                    <div class="example-label">Example Problem</div>
                    <div class="example-text">${example.problem}</div>
                </div>
                <div class="example-solution">
                    <div class="example-label">Step-by-Step Solution</div>
                    ${stepsHtml}
                    <div class="example-final-answer">
                        <div class="example-final-answer-label">Final Answer</div>
                        <div class="example-final-answer-value">${example.answer}</div>
                    </div>
                </div>
            `;
        }

        function displayProblem() {
            if (problems.length === 0) return;

            const problem = problems[currentProblemIndex];
            attemptCount = 0;

            // Update progress
            const progress = ((currentProblemIndex) / problems.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressText').textContent =
                `Problem ${currentProblemIndex + 1} of ${problems.length}`;

            // Update difficulty badge
            const difficultyBadge = document.getElementById('difficultyBadge');
            difficultyBadge.textContent = problem.difficulty.charAt(0).toUpperCase() + problem.difficulty.slice(1);
            difficultyBadge.className = 'badge badge-' + problem.difficulty;

            // Update topic badge
            document.getElementById('topicBadge').textContent = problem.topic;

            // Display worked example for this problem
            displayWorkedExample(problem.id);

            // Update problem text
            document.getElementById('problemText').innerText = problem.problem_text;

            // Update formula (but keep it hidden initially)
            document.getElementById('formulaText').textContent = problem.formula;
            document.getElementById('formulaBox').classList.add('hidden');

            // Clear answer input and feedback
            document.getElementById('answerInput').value = '';
            document.getElementById('feedbackBox').className = 'hidden';
            document.getElementById('submitBtn').disabled = false;

            // Update placeholder based on unit type
            const input = document.getElementById('answerInput');
            if (problem.unit === 'choice') {
                input.placeholder = 'Enter option number (1, 2, 3, or 4)';
                input.step = '1';
            } else if (problem.unit === 'percent') {
                input.placeholder = 'Enter percentage (e.g., 17 for 17%)';
                input.step = '0.01';
            } else if (problem.unit === 'decimal') {
                input.placeholder = 'Enter your answer';
                input.step = '0.01';
            } else {
                input.placeholder = 'Enter your answer';
                input.step = '0.01';
            }

            // Render LaTeX
            renderMath();

            // Update navigation buttons
            document.getElementById('prevBtn').disabled = currentProblemIndex === 0;
            document.getElementById('nextBtn').textContent =
                currentProblemIndex === problems.length - 1 ? 'Finish' : 'Next Problem';
        }

        function checkAnswer() {
            const problem = problems[currentProblemIndex];
            const userAnswer = parseFloat(document.getElementById('answerInput').value);

            if (isNaN(userAnswer)) {
                showFeedback('Please enter a valid number', 'incorrect');
                return;
            }

            // Smart tolerance: allow for rounding errors from intermediate calculations
            // Use 0.5% of the correct answer or $1, whichever is larger
            // This handles cases where students round intermediate steps
            const percentTolerance = Math.abs(problem.correct_answer) * 0.005; // 0.5%
            const minTolerance = problem.unit === 'percent' ? 0.05 : (problem.unit === 'choice' ? 0 : 1);
            const calculatedTolerance = Math.max(percentTolerance, minTolerance);

            // Use problem-specific tolerance if provided, otherwise use calculated tolerance
            const tolerance = problem.tolerance !== undefined ? problem.tolerance : calculatedTolerance;

            const isCorrect = Math.abs(userAnswer - problem.correct_answer) <= tolerance;

            attemptCount++;

            if (isCorrect) {
                completedProblems.add(currentProblemIndex);
                // If correct on first attempt, mark as mastered
                if (attemptCount === 1) {
                    markProblemMastered(problem.id);
                }
                showCorrectFeedback();
            } else {
                // Track this as a missed problem
                saveMissedProblem(problem.id);
                showIncorrectFeedback();
            }
        }

        function showCorrectFeedback() {
            const problem = problems[currentProblemIndex];
            const feedbackBox = document.getElementById('feedbackBox');

            let html = `
                <div class="feedback-title">
                    Correct!
                </div>
                <div class="feedback-content">
                    Great job! The correct answer is ${formatAnswer(problem.correct_answer, problem.unit || 'dollars')}.
                </div>
            `;

            feedbackBox.className = 'feedback-box feedback-correct';
            feedbackBox.innerHTML = html;

            document.getElementById('submitBtn').disabled = true;
            renderMath();
        }

        function showIncorrectFeedback() {
            const problem = problems[currentProblemIndex];
            const feedbackBox = document.getElementById('feedbackBox');

            let html = `
                <div class="feedback-title">
                    Not quite right
                </div>
            `;

            // Adaptive feedback based on attempt count
            if (attemptCount === 1) {
                html += `
                    <div class="hint-box">
                        <strong>Hint:</strong> ${problem.hints.level_1}
                    </div>
                `;
            } else if (attemptCount === 2) {
                // Show formula on second attempt
                document.getElementById('formulaBox').classList.remove('hidden');
                html += `
                    <div class="hint-box">
                        <strong>Formula revealed above.</strong> ${problem.hints.level_2}
                    </div>
                `;
            } else if (attemptCount === 3) {
                // Keep formula visible
                document.getElementById('formulaBox').classList.remove('hidden');
                html += `
                    <div class="hint-box">
                        <strong>Detailed hint:</strong> ${problem.hints.level_3}
                    </div>
                    <div style="margin-top: 1rem;">
                        <button class="btn-secondary" onclick="showFullSolution()">Show Full Solution</button>
                    </div>
                `;
            } else {
                // After 3 attempts, show full solution automatically
                showFullSolution();
                return;
            }

            feedbackBox.className = 'feedback-box feedback-incorrect';
            feedbackBox.innerHTML = html;
            renderMath();
        }

        function showFullSolution() {
            const problem = problems[currentProblemIndex];
            const feedbackBox = document.getElementById('feedbackBox');

            let html = `
                <div class="feedback-title">
                    Solution
                </div>
                <div class="solution-steps">
            `;

            problem.solution_steps.forEach((step, index) => {
                html += `
                    <div class="solution-step">
                        <span class="step-number">Step ${index + 1}:</span> ${step}
                    </div>
                `;
            });

            html += `
                </div>
                <div class="feedback-content" style="margin-top: 1rem; padding-top: 1rem; border-top: 2px solid #E2E8F0;">
                    <strong>Final Answer:</strong> ${formatAnswer(problem.correct_answer, problem.unit || 'dollars')}
                </div>
            `;

            feedbackBox.className = 'feedback-box feedback-correct';
            feedbackBox.innerHTML = html;

            document.getElementById('submitBtn').disabled = true;
            renderMath();
        }

        function nextProblem() {
            if (currentProblemIndex < problems.length - 1) {
                currentProblemIndex++;
                displayProblem();
            } else {
                showSummary();
            }
        }

        function previousProblem() {
            if (currentProblemIndex > 0) {
                currentProblemIndex--;
                displayProblem();
            }
        }

        function showSummary() {
            const problemCard = document.getElementById('problemCard');
            const completed = completedProblems.size;
            const total = problems.length;
            const percentage = Math.round((completed / total) * 100);

            // Check how many problems are in the missed queue
            const missed = getMissedProblems();
            const missedCount = Object.keys(missed).length;

            let reviewButton = '';
            if (missedCount > 0 && !reviewMode) {
                reviewButton = `
                    <a href="week10-efficiency.html?review=true" class="btn-primary" style="text-decoration: none; display: inline-block; background-color: #DD6B20;">
                        Review ${missedCount} Missed Problem${missedCount > 1 ? 's' : ''}
                    </a>
                `;
            }

            let celebrationMessage = '';
            if (reviewMode && completed === total) {
                celebrationMessage = `
                    <div style="background-color: #C6F6D5; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        <strong>Excellent!</strong> You've mastered these previously missed problems!
                    </div>
                `;
            }

            problemCard.innerHTML = `
                <div style="text-align: center; padding: 3rem;">
                    <h2 style="font-size: 2rem; margin-bottom: 1rem;">${reviewMode ? 'Review Session Complete!' : 'Practice Session Complete!'}</h2>
                    ${celebrationMessage}
                    <div style="font-size: 3rem; font-weight: bold; color: #2C5282; margin: 2rem 0;">
                        ${completed} / ${total}
                    </div>
                    <div style="font-size: 1.25rem; color: #4A5568; margin-bottom: 2rem;">
                        You got ${percentage}% of problems correct on the first try!
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                        ${reviewButton}
                        <button class="btn-primary" onclick="location.href='week10-efficiency.html'">Practice All</button>
                        <a href="index.html" class="btn-secondary" style="text-decoration: none; display: inline-block;">Back to Topics</a>
                    </div>
                </div>
            `;
        }

        function renderMath() {
            setTimeout(() => {
                if (typeof renderMathInElement === 'function') {
                    renderMathInElement(document.body, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '\\(', right: '\\)', display: false}
                        ],
                        throwOnError: false
                    });
                }
            }, 100);
        }

        // Allow Enter key to submit
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('answerInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !document.getElementById('submitBtn').disabled) {
                    checkAnswer();
                }
            });
            loadProblems();
        });
    </script>
</body>
</html>
