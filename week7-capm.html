<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Practice Tool - Portfolio Analysis &amp; CAPM</title>

    <!-- KaTeX for LaTeX rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #ffffff;
            color: #1a1a1a;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            background-color: #2C5282;
            color: white;
            padding: 2rem;
            margin-bottom: 2rem;
            border-radius: 8px;
        }

        .header-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .back-link {
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .back-link:hover {
            color: white;
        }

        h1 {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }

        .progress-bar {
            background-color: #E2E8F0;
            height: 8px;
            border-radius: 4px;
            margin: 1.5rem 0;
            overflow: hidden;
        }

        .progress-fill {
            background-color: #48BB78;
            height: 100%;
            transition: width 0.3s ease;
        }

        .problem-card {
            background: white;
            border: 2px solid #E2E8F0;
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .problem-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #E2E8F0;
        }

        .problem-meta {
            display: flex;
            gap: 1rem;
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .badge-easy { background-color: #C6F6D5; color: #22543D; }
        .badge-medium { background-color: #FEF3C7; color: #78350F; }
        .badge-hard { background-color: #FED7D7; color: #742A2A; }

        .problem-number {
            font-size: 0.875rem;
            color: #718096;
            font-weight: 500;
        }

        .problem-text {
            font-size: 1.125rem;
            line-height: 1.8;
            margin-bottom: 2rem;
            color: #2D3748;
        }

        .formula-box {
            background-color: #F7FAFC;
            border-left: 4px solid #2C5282;
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            border-radius: 4px;
        }

        .formula-label {
            font-size: 0.875rem;
            color: #4A5568;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .answer-section {
            margin: 2rem 0;
        }

        .input-group {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        label {
            font-weight: 500;
            color: #2D3748;
        }

        input[type="number"] {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 2px solid #CBD5E0;
            border-radius: 6px;
            font-size: 1.125rem;
            transition: border-color 0.2s;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #2C5282;
        }

        button {
            padding: 0.75rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: #2C5282;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2A4365;
        }

        .btn-primary:disabled {
            background-color: #CBD5E0;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: #E2E8F0;
            color: #2D3748;
        }

        .btn-secondary:hover {
            background-color: #CBD5E0;
        }

        .feedback-box {
            margin-top: 1.5rem;
            padding: 1.5rem;
            border-radius: 8px;
            border: 2px solid;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .feedback-correct {
            background-color: #F0FFF4;
            border-color: #48BB78;
            color: #22543D;
        }

        .feedback-incorrect {
            background-color: #FFF5F5;
            border-color: #F56565;
            color: #742A2A;
        }

        .feedback-title {
            font-weight: 600;
            font-size: 1.125rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .feedback-content {
            margin-top: 1rem;
            line-height: 1.8;
        }

        .hint-box {
            background-color: #EBF8FF;
            border-left: 4px solid #3182CE;
            padding: 1rem 1.5rem;
            margin-top: 1rem;
            border-radius: 4px;
        }

        .solution-steps {
            margin-top: 1rem;
        }

        .solution-step {
            padding: 0.75rem 0;
            border-bottom: 1px solid #E2E8F0;
        }

        .solution-step:last-child {
            border-bottom: none;
        }

        .step-number {
            font-weight: 600;
            color: #2C5282;
        }

        .navigation {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .navigation button {
            flex: 1;
        }

        .hidden {
            display: none;
        }

        /* Calculator Styles */
        .calculator-toolbar {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .calculator-toggle-btn {
            background-color: #2C5282;
            color: white;
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 50px;
            font-size: 1.125rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .calculator-toggle-btn:hover {
            background-color: #2A4365;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }

        .calculator-container {
            position: absolute;
            bottom: 70px;
            right: 0;
            width: 320px;
            background-color: #F7FAFC;
            border: 2px solid #E2E8F0;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            padding: 1rem;
            display: none;
        }

        .calculator-container.active {
            display: block;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .calculator-display {
            background-color: #2D3748;
            color: #48BB78;
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            font-family: 'Courier New', monospace;
            font-size: 1.25rem;
            text-align: right;
            min-height: 50px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .calculator-expression {
            font-size: 0.875rem;
            color: #CBD5E0;
            margin-bottom: 0.25rem;
        }

        .calculator-result {
            font-size: 1.25rem;
            color: #48BB78;
            font-weight: 600;
        }

        .calculator-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
        }

        .calc-btn {
            padding: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            border: 1px solid #CBD5E0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            background-color: white;
            color: #2D3748;
        }

        .calc-btn:hover {
            background-color: #EDF2F7;
            transform: translateY(-1px);
        }

        .calc-btn:active {
            transform: translateY(0);
        }

        .calc-btn-operator {
            background-color: #2C5282;
            color: white;
            border-color: #2C5282;
        }

        .calc-btn-operator:hover {
            background-color: #2A4365;
        }

        .calc-btn-equals {
            background-color: #48BB78;
            color: white;
            border-color: #48BB78;
        }

        .calc-btn-equals:hover {
            background-color: #38A169;
        }

        .calc-btn-clear {
            background-color: #F56565;
            color: white;
            border-color: #F56565;
        }

        .calc-btn-clear:hover {
            background-color: #E53E3E;
        }


        /* Worked Example Toggle Styles */
        .worked-example-toggle {
            background: linear-gradient(135deg, #EBF8FF 0%, #E6FFFA 100%);
            border: 2px solid #3182CE;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .worked-example-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .worked-example-header:hover {
            background-color: rgba(49, 130, 206, 0.1);
        }

        .worked-example-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
            color: #2C5282;
        }

        .worked-example-title .icon {
            font-size: 1.25rem;
        }

        .worked-example-subtitle {
            font-size: 0.85rem;
            color: #4A5568;
            font-weight: 400;
        }

        .toggle-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #3182CE;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .toggle-arrow {
            transition: transform 0.3s ease;
            font-size: 1.25rem;
        }

        .worked-example-toggle.expanded .toggle-arrow {
            transform: rotate(180deg);
        }

        .worked-example-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, padding 0.4s ease;
            background-color: #F7FAFC;
        }

        .worked-example-toggle.expanded .worked-example-content {
            max-height: 2000px;
            padding: 1.5rem;
            border-top: 1px solid #BEE3F8;
        }

        .example-problem {
            background: white;
            border-radius: 6px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            border-left: 4px solid #3182CE;
        }

        .example-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #3182CE;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .example-text {
            color: #2D3748;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .example-solution {
            background: white;
            border-radius: 6px;
            padding: 1.25rem;
        }

        .example-step {
            display: flex;
            gap: 1rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid #E2E8F0;
        }

        .example-step:last-child {
            border-bottom: none;
        }

        .example-step-number {
            background-color: #3182CE;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .example-step-content {
            flex: 1;
        }

        .example-step-explanation {
            color: #4A5568;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .example-step-calculation {
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            background-color: #EDF2F7;
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            font-size: 0.9rem;
            color: #2D3748;
        }

        .example-final-answer {
            background: linear-gradient(135deg, #48BB78 0%, #38A169 100%);
            color: white;
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
            text-align: center;
        }

        .example-final-answer-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            opacity: 0.9;
        }

        .example-final-answer-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .now-try-badge {
            background-color: #48BB78;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        /* Multiple choice styles */
        .mc-options {
            list-style: none;
            padding: 0;
            margin: 1rem 0 1.5rem 0;
        }

        .mc-options li {
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            background-color: #F7FAFC;
            border: 2px solid #E2E8F0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
            color: #2D3748;
        }

        .mc-options li:hover {
            border-color: #2C5282;
            background-color: #EBF8FF;
        }

        .mc-options li.selected {
            border-color: #2C5282;
            background-color: #EBF8FF;
            font-weight: 600;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            h1 {
                font-size: 1.5rem;
            }

            .problem-card {
                padding: 1.5rem;
            }

            .input-group {
                flex-direction: column;
                align-items: stretch;
            }

            .navigation {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-nav">
                <a href="index.html" class="back-link">&larr; Back to Topics</a>
            </div>
            <h1>Portfolio Analysis &amp; CAPM</h1>
            <div class="subtitle">Week 7 - MGMT 408</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: 0%"></div>
            </div>
            <div class="problem-number" id="progressText">Problem 1 of 10</div>
        </header>

        <div class="problem-card" id="problemCard">
            <div class="problem-header">
                <div class="problem-meta">
                    <span class="badge" id="difficultyBadge">Easy</span>
                    <span class="badge" style="background-color: #EBF8FF; color: #2C5282;" id="topicBadge">Topic</span>
                </div>
            </div>

            <!-- Worked Example Toggle -->
            <div class="worked-example-toggle" id="workedExampleToggle">
                <div class="worked-example-header" onclick="toggleWorkedExample()">
                    <div class="worked-example-title">
                        <span class="icon">üìñ</span>
                        <span>
                            See Worked Example
                            <div class="worked-example-subtitle">Similar problem with step-by-step solution</div>
                        </span>
                    </div>
                    <div class="toggle-indicator">
                        <span class="toggle-text" id="toggleText">Show</span>
                        <span class="toggle-arrow">‚ñº</span>
                    </div>
                </div>
                <div class="worked-example-content" id="workedExampleContent">
                    <!-- Content populated by JavaScript -->
                </div>
            </div>

            <div class="now-try-badge">‚úèÔ∏è Now You Try</div>

            <div class="problem-text" id="problemText">
                Loading problem...
            </div>

            <div class="formula-box hidden" id="formulaBox">
                <div class="formula-label">Formula:</div>
                <div id="formulaText"></div>
            </div>

            <div class="answer-section">
                <div class="input-group">
                    <label for="answerInput">Your Answer:</label>
                    <input type="number" id="answerInput" step="0.01" placeholder="Enter your answer">
                    <button class="btn-primary" id="submitBtn" onclick="checkAnswer()">Submit</button>
                </div>
            </div>

            <div id="feedbackBox" class="hidden"></div>

            <div class="navigation">
                <button class="btn-secondary" id="prevBtn" onclick="previousProblem()">Previous</button>
                <button class="btn-secondary" id="nextBtn" onclick="nextProblem()">Next Problem</button>
            </div>
        </div>
    </div>

    <!-- Calculator Toolbar -->
    <div class="calculator-toolbar">
        <button class="calculator-toggle-btn" onclick="toggleCalculator()">
            Calculator
        </button>
        <div class="calculator-container" id="calculatorContainer">
            <div class="calculator-display">
                <div class="calculator-expression" id="calcExpression">&nbsp;</div>
                <div class="calculator-result" id="calcResult">0</div>
            </div>
            <div class="calculator-buttons">
                <button class="calc-btn calc-btn-clear" onclick="calcClear()">AC</button>
                <button class="calc-btn" onclick="calcBackspace()">Del</button>
                <button class="calc-btn calc-btn-operator" onclick="calcAppend('^')">x^y</button>
                <button class="calc-btn calc-btn-operator" onclick="calcAppend('/')">√∑</button>

                <button class="calc-btn" onclick="calcAppend('7')">7</button>
                <button class="calc-btn" onclick="calcAppend('8')">8</button>
                <button class="calc-btn" onclick="calcAppend('9')">9</button>
                <button class="calc-btn calc-btn-operator" onclick="calcAppend('*')">x</button>

                <button class="calc-btn" onclick="calcAppend('4')">4</button>
                <button class="calc-btn" onclick="calcAppend('5')">5</button>
                <button class="calc-btn" onclick="calcAppend('6')">6</button>
                <button class="calc-btn calc-btn-operator" onclick="calcAppend('-')">-</button>

                <button class="calc-btn" onclick="calcAppend('1')">1</button>
                <button class="calc-btn" onclick="calcAppend('2')">2</button>
                <button class="calc-btn" onclick="calcAppend('3')">3</button>
                <button class="calc-btn calc-btn-operator" onclick="calcAppend('+')">+</button>

                <button class="calc-btn" onclick="calcAppend('0')">0</button>
                <button class="calc-btn" onclick="calcAppend('.')">.</button>
                <button class="calc-btn" onclick="calcAppend('(')">(</button>
                <button class="calc-btn" onclick="calcAppend(')')">)</button>

                <button class="calc-btn calc-btn-equals" onclick="calcEquals()" style="grid-column: span 4;">=</button>
            </div>
        </div>
    </div>

    <script>
        // Calculator state
        let calcCurrentExpression = '';
        let calcCurrentResult = '0';
        let calculatorOpen = false;

        function toggleCalculator() {
            calculatorOpen = !calculatorOpen;
            const container = document.getElementById('calculatorContainer');
            if (calculatorOpen) {
                container.classList.add('active');
            } else {
                container.classList.remove('active');
            }
        }

        function closeCalculator() {
            if (calculatorOpen) {
                calculatorOpen = false;
                document.getElementById('calculatorContainer').classList.remove('active');
            }
        }

        // Close calculator when clicking outside
        document.addEventListener('click', (e) => {
            const toolbar = document.querySelector('.calculator-toolbar');
            const container = document.getElementById('calculatorContainer');

            // If click is outside the calculator toolbar and container, close it
            if (calculatorOpen && !toolbar.contains(e.target)) {
                closeCalculator();
            }
        });

        function calcAppend(value) {
            calcCurrentExpression += value;
            updateCalcDisplay();
        }

        function calcClear() {
            calcCurrentExpression = '';
            calcCurrentResult = '0';
            updateCalcDisplay();
        }

        function calcBackspace() {
            calcCurrentExpression = calcCurrentExpression.slice(0, -1);
            updateCalcDisplay();
        }

        function calcEquals() {
            if (!calcCurrentExpression) return;

            try {
                // Replace ^ with ** for JavaScript exponentiation
                let expression = calcCurrentExpression.replace(/\^/g, '**');

                // Evaluate the expression safely
                let result = Function('"use strict"; return (' + expression + ')')();

                // Round to 4 decimal places to avoid floating point issues
                if (typeof result === 'number') {
                    calcCurrentResult = Number(result.toFixed(4)).toString();
                } else {
                    calcCurrentResult = result.toString();
                }
            } catch (error) {
                calcCurrentResult = 'Error';
            }

            updateCalcDisplay();
        }

        function updateCalcDisplay() {
            document.getElementById('calcExpression').textContent = calcCurrentExpression || '\u00A0';
            document.getElementById('calcResult').textContent = calcCurrentResult;
        }

        // Allow keyboard input for calculator (only when calculator is open)
        document.addEventListener('keydown', (e) => {
            if (document.activeElement.id === 'answerInput') return; // Don't interfere with answer input
            if (!calculatorOpen) return; // Only work when calculator is open

            if (e.key >= '0' && e.key <= '9') {
                calcAppend(e.key);
            } else if (e.key === '.') {
                calcAppend('.');
            } else if (e.key === '+' || e.key === '-' || e.key === '*' || e.key === '/') {
                calcAppend(e.key);
            } else if (e.key === '^') {
                calcAppend('^');
            } else if (e.key === 'Enter' && calcCurrentExpression) {
                calcEquals();
            } else if (e.key === 'Backspace' && calcCurrentExpression) {
                e.preventDefault();
                calcBackspace();
            } else if (e.key === 'Escape') {
                calcClear();
            } else if (e.key === '(' || e.key === ')') {
                calcAppend(e.key);
            }
        });

        // Format answer based on unit type
        function formatAnswer(value, unit) {
            if (unit === 'dollars') return '$' + value.toLocaleString();
            if (unit === 'percent') return value + '%';
            if (unit === 'choice') return 'Option ' + value;
            return value.toString();
        }

        // Worked examples for each problem type
        const workedExamples = {
            "capm_001": {
                problem: "A mutual fund \"Alpha Growth\" has an expected return of 12% and a standard deviation of 30%. The risk-free rate is 2%. Calculate its Sharpe Ratio.",
                steps: [
                    { explanation: "Identify the variables:", calculation: "\\(E[R] = 12\\%,\\ SD = 30\\%,\\ r_f = 2\\%\\)" },
                    { explanation: "Write the Sharpe Ratio formula:", calculation: "\\(\\text{Sharpe Ratio} = \\frac{E[R] - r_f}{SD}\\)" },
                    { explanation: "Plug in the values:", calculation: "\\(\\text{Sharpe Ratio} = \\frac{12 - 2}{30}\\)" },
                    { explanation: "Calculate the numerator:", calculation: "\\(12 - 2 = 10\\)" },
                    { explanation: "Divide to get the final answer:", calculation: "\\(\\frac{10}{30} = 0.3333\\)" }
                ],
                answer: "0.33"
            },
            "capm_002": {
                problem: "A bond fund \"Steady Income\" has an expected return of 6% and a standard deviation of 8%. The risk-free rate is 2%. Calculate its Sharpe Ratio.",
                steps: [
                    { explanation: "Identify the variables:", calculation: "\\(E[R] = 6\\%,\\ SD = 8\\%,\\ r_f = 2\\%\\)" },
                    { explanation: "Write the Sharpe Ratio formula:", calculation: "\\(\\text{Sharpe Ratio} = \\frac{E[R] - r_f}{SD}\\)" },
                    { explanation: "Plug in the values:", calculation: "\\(\\text{Sharpe Ratio} = \\frac{6 - 2}{8}\\)" },
                    { explanation: "Calculate the numerator:", calculation: "\\(6 - 2 = 4\\)" },
                    { explanation: "Divide to get the final answer:", calculation: "\\(\\frac{4}{8} = 0.50\\)" }
                ],
                answer: "0.50"
            },
            "capm_003": {
                problem: "Fund A has a Sharpe Ratio of 0.45 and Fund B has a Sharpe Ratio of 0.35. You can borrow and lend at the risk-free rate. Which fund should you invest in? (1) Fund B because it has less volatility (2) Fund A because it has the higher Sharpe Ratio (3) Both funds equally (4) Neither fund",
                steps: [
                    { explanation: "Recall the key insight about the Sharpe Ratio:", calculation: "The Sharpe Ratio measures return per unit of risk (excess return / standard deviation)" },
                    { explanation: "Compare the two ratios:", calculation: "Fund A: \\(0.45\\) vs Fund B: \\(0.35\\)" },
                    { explanation: "Since we can borrow/lend at the risk-free rate:", calculation: "We can adjust any portfolio's risk level by leveraging or deleveraging" },
                    { explanation: "The fund with the higher Sharpe Ratio dominates:", calculation: "Fund A \\((0.45)\\) gives more return per unit of risk than Fund B \\((0.35)\\)" }
                ],
                answer: "Option 2"
            },
            "capm_004": {
                problem: "Nike has a market cap of $4 billion and Disney has a market cap of $6 billion. These are the only two stocks. What is Nike's weight in the market portfolio (in percent)?",
                steps: [
                    { explanation: "Identify the market caps:", calculation: "\\(\\text{Nike} = \\$4B,\\ \\text{Disney} = \\$6B\\)" },
                    { explanation: "Calculate total market cap:", calculation: "\\(\\text{Total} = \\$4B + \\$6B = \\$10B\\)" },
                    { explanation: "Calculate Nike's weight:", calculation: "\\(w = \\frac{\\$4B}{\\$10B}\\)" },
                    { explanation: "Convert to percentage:", calculation: "\\(w = 0.40 = 40\\%\\)" }
                ],
                answer: "40%"
            },
            "capm_005": {
                problem: "Using the CAPM: the risk-free rate is 3%, the expected market return is 10%. A stock has a beta of 0.8. What is its expected return?",
                steps: [
                    { explanation: "Identify the variables:", calculation: "\\(r_f = 3\\%,\\ E[R_m] = 10\\%,\\ \\beta = 0.8\\)" },
                    { explanation: "Write the CAPM formula:", calculation: "\\(E[R] = r_f + \\beta \\times (E[R_m] - r_f)\\)" },
                    { explanation: "Calculate the market risk premium:", calculation: "\\(E[R_m] - r_f = 10\\% - 3\\% = 7\\%\\)" },
                    { explanation: "Multiply by beta:", calculation: "\\(0.8 \\times 7\\% = 5.6\\%\\)" },
                    { explanation: "Add the risk-free rate:", calculation: "\\(E[R] = 3\\% + 5.6\\% = 8.6\\%\\)" }
                ],
                answer: "8.6%"
            },
            "capm_006": {
                problem: "Gold Corp has a beta of -0.10. The expected market return is 10% and the risk-free rate is 4%. What is Gold Corp's expected return according to the CAPM?",
                steps: [
                    { explanation: "Identify the variables:", calculation: "\\(r_f = 4\\%,\\ E[R_m] = 10\\%,\\ \\beta = -0.10\\)" },
                    { explanation: "Write the CAPM formula:", calculation: "\\(E[R] = r_f + \\beta \\times (E[R_m] - r_f)\\)" },
                    { explanation: "Calculate the market risk premium:", calculation: "\\(E[R_m] - r_f = 10\\% - 4\\% = 6\\%\\)" },
                    { explanation: "Multiply by beta (note the negative):", calculation: "\\(-0.10 \\times 6\\% = -0.6\\%\\)" },
                    { explanation: "Add the risk-free rate:", calculation: "\\(E[R] = 4\\% + (-0.6\\%) = 3.4\\%\\)" }
                ],
                answer: "3.4%"
            },
            "capm_007": {
                problem: "Stock A has beta 0.50 and Stock B has beta 1.50. Risk-free rate is 4%, expected market return is 10%. What is the expected return of a portfolio with 30% Stock A and 70% Stock B?",
                steps: [
                    { explanation: "Calculate the portfolio beta:", calculation: "\\(\\beta_P = 0.30 \\times 0.50 + 0.70 \\times 1.50\\)" },
                    { explanation: "Compute each term:", calculation: "\\(0.30 \\times 0.50 = 0.15\\) and \\(0.70 \\times 1.50 = 1.05\\)" },
                    { explanation: "Sum for portfolio beta:", calculation: "\\(\\beta_P = 0.15 + 1.05 = 1.20\\)" },
                    { explanation: "Apply CAPM:", calculation: "\\(E[R_P] = 4\\% + 1.20 \\times (10\\% - 4\\%)\\)" },
                    { explanation: "Calculate:", calculation: "\\(E[R_P] = 4\\% + 1.20 \\times 6\\% = 4\\% + 7.2\\% = 11.2\\%\\)" }
                ],
                answer: "11.2%"
            },
            "capm_008": {
                problem: "A stock has SD(R) = 30%, correlation with the market = 0.8, and the market has SD = 20%. What is the stock's beta?",
                steps: [
                    { explanation: "Identify the variables:", calculation: "\\(SD(R) = 30\\%,\\ \\text{Corr}(R, R_m) = 0.8,\\ SD(R_m) = 20\\%\\)" },
                    { explanation: "Write the beta formula using correlation:", calculation: "\\(\\beta = \\frac{SD(R) \\times \\text{Corr}(R, R_m)}{SD(R_m)}\\)" },
                    { explanation: "Plug in the values:", calculation: "\\(\\beta = \\frac{30 \\times 0.8}{20}\\)" },
                    { explanation: "Calculate the numerator:", calculation: "\\(30 \\times 0.8 = 24\\)" },
                    { explanation: "Divide to get beta:", calculation: "\\(\\beta = \\frac{24}{20} = 1.20\\)" }
                ],
                answer: "1.20"
            },
            "capm_009": {
                problem: "Jensen's alpha for a stock is calculated as alpha = actual return - CAPM predicted return. What does a positive alpha indicate? (1) The stock has high total risk (2) The stock outperformed its CAPM prediction (3) The stock has a high beta (4) The stock is negatively correlated with the market",
                steps: [
                    { explanation: "Recall the definition of Jensen's alpha:", calculation: "\\(\\alpha = R_{\\text{actual}} - [r_f + \\beta \\times (R_m - r_f)]\\)" },
                    { explanation: "A positive alpha means:", calculation: "The actual return exceeded the return predicted by CAPM" },
                    { explanation: "This tells us:", calculation: "The stock earned more than what was expected given its systematic risk (\\(\\beta\\))" },
                    { explanation: "Therefore:", calculation: "A positive alpha means the stock outperformed its CAPM prediction" }
                ],
                answer: "Option 2"
            },
            "capm_010": {
                problem: "In the CAPM framework, which type of risk is rewarded with higher expected returns? (1) Total risk (2) Idiosyncratic (firm-specific) risk (3) Systematic (market) risk (4) Both systematic and idiosyncratic risk equally",
                steps: [
                    { explanation: "Recall that total risk = systematic + idiosyncratic:", calculation: "\\(SD(R)^2 = \\beta^2 \\times SD(R_m)^2 + SD(\\epsilon)^2\\)" },
                    { explanation: "Idiosyncratic risk can be diversified away:", calculation: "By holding many stocks, firm-specific shocks cancel out" },
                    { explanation: "Since investors can eliminate idiosyncratic risk for free:", calculation: "The market does not compensate them for bearing it" },
                    { explanation: "Only systematic risk (measured by beta) earns a premium:", calculation: "\\(E[R] = r_f + \\beta \\times (E[R_m] - r_f)\\) -- only \\(\\beta\\) matters" }
                ],
                answer: "Option 3"
            }
        };

        // Problems data embedded directly to avoid CORS issues
        let problems = [
            {
                "id": "capm_001",
                "topic": "Sharpe Ratio",
                "difficulty": "easy",
                "problem_text": "A mutual fund called \"High Flyer Fund\" has an expected return of 14% and a standard deviation of 35%. The risk-free rate is 2%. Calculate the fund's Sharpe Ratio.",
                "formula": "\\(\\text{Sharpe Ratio} = \\frac{E[R] - r_f}{SD(R)}\\)",
                "solution_steps": [
                    "Step 1: Identify the variables: \\(E[R] = 14\\%,\\ SD = 35\\%,\\ r_f = 2\\%\\)",
                    "Step 2: \\(\\text{Sharpe} = \\frac{E[R] - r_f}{SD}\\)",
                    "Step 3: Calculate the excess return: \\(14 - 2 = 12\\)",
                    "Step 4: Divide by the standard deviation: \\(\\frac{12}{35} = 0.343\\)",
                    "Step 5: Final answer: \\(\\text{Sharpe Ratio} = 0.34\\)"
                ],
                "correct_answer": 0.34,
                "tolerance": 0.02,
                "unit": "decimal",
                "hints": {
                    "level_1": "The Sharpe Ratio measures excess return per unit of risk",
                    "level_2": "Use the formula: \\(\\text{Sharpe Ratio} = \\frac{E[R] - r_f}{SD}\\)",
                    "level_3": "Calculate: \\(\\frac{14 - 2}{35} = \\frac{12}{35}\\)"
                }
            },
            {
                "id": "capm_002",
                "topic": "Sharpe Ratio",
                "difficulty": "easy",
                "problem_text": "Another fund called \"Steady Income Fund\" has an expected return of 6% and a standard deviation of 15%. The risk-free rate is 2%. Calculate the fund's Sharpe Ratio.",
                "formula": "\\(\\text{Sharpe Ratio} = \\frac{E[R] - r_f}{SD(R)}\\)",
                "solution_steps": [
                    "Step 1: Identify the variables: \\(E[R] = 6\\%,\\ SD = 15\\%,\\ r_f = 2\\%\\)",
                    "Step 2: \\(\\text{Sharpe} = \\frac{E[R] - r_f}{SD}\\)",
                    "Step 3: Calculate the excess return: \\(6 - 2 = 4\\)",
                    "Step 4: Divide by the standard deviation: \\(\\frac{4}{15} = 0.267\\)",
                    "Step 5: Final answer: \\(\\text{Sharpe Ratio} = 0.27\\)"
                ],
                "correct_answer": 0.27,
                "tolerance": 0.02,
                "unit": "decimal",
                "hints": {
                    "level_1": "The Sharpe Ratio measures excess return per unit of risk",
                    "level_2": "Use the formula: \\(\\text{Sharpe Ratio} = \\frac{E[R] - r_f}{SD}\\)",
                    "level_3": "Calculate: \\(\\frac{6 - 2}{15} = \\frac{4}{15}\\)"
                }
            },
            {
                "id": "capm_003",
                "topic": "Sharpe Ratio - Fund Selection",
                "difficulty": "medium",
                "problem_text": "Based on the Sharpe Ratios of 0.34 for \"High Flyer Fund\" and 0.27 for \"Steady Income Fund\" (and you can borrow/lend at the risk-free rate), which fund should you choose?\n\n(1) Steady Income Fund because it has lower risk\n(2) High Flyer Fund because it has the higher Sharpe Ratio\n(3) Either fund since they have the same expected return\n(4) Neither fund - invest directly in the market",
                "formula": "Choose the portfolio with the highest Sharpe Ratio",
                "solution_steps": [
                    "Step 1: Compare the Sharpe Ratios: High Flyer Fund \\(= 0.34\\) vs Steady Income Fund \\(= 0.27\\)",
                    "Step 2: The Sharpe Ratio measures return per unit of risk",
                    "Step 3: Since we can borrow/lend at the risk-free rate, we can adjust risk levels",
                    "Step 4: The fund with the higher Sharpe Ratio gives the best risk-return tradeoff",
                    "Step 5: Answer: Option 2 - High Flyer Fund because it has the higher Sharpe Ratio"
                ],
                "correct_answer": 2,
                "tolerance": 0,
                "unit": "choice",
                "hints": {
                    "level_1": "The Sharpe Ratio measures the reward-to-risk ratio of an investment",
                    "level_2": "When you can borrow/lend at the risk-free rate, you can always adjust the risk level - so which metric matters most?",
                    "level_3": "A higher Sharpe Ratio means more return per unit of risk. Since you can lever up or down, you always prefer the highest Sharpe Ratio."
                }
            },
            {
                "id": "capm_004",
                "topic": "Market Portfolio Weights",
                "difficulty": "medium",
                "problem_text": "Apple has a market capitalization of $3 billion and Tesla has a market capitalization of $7 billion. These are the only two stocks in the market. What is Apple's weight in the market portfolio (in percent)?",
                "formula": "\\(w_i = \\frac{\\text{MarketCap}_i}{\\text{Total MarketCap}}\\)",
                "solution_steps": [
                    "Step 1: Identify the market caps: Apple \\(= \\$3B\\), Tesla \\(= \\$7B\\)",
                    "Step 2: Calculate total market cap: \\(\\$3B + \\$7B = \\$10B\\)",
                    "Step 3: Calculate Apple's weight: \\(\\frac{\\$3B}{\\$10B} = 0.30\\)",
                    "Step 4: Convert to percentage: \\(0.30 = 30\\%\\)",
                    "Step 5: Final answer: Apple's weight \\(= 30\\%\\)"
                ],
                "correct_answer": 30,
                "tolerance": 0.5,
                "unit": "percent",
                "hints": {
                    "level_1": "The market portfolio weights each stock by its market capitalization",
                    "level_2": "\\(w = \\frac{\\text{Stock's market cap}}{\\text{Total market cap}}\\)",
                    "level_3": "Calculate \\(\\frac{3}{3+7}\\) and convert to a percentage"
                }
            },
            {
                "id": "capm_005",
                "topic": "CAPM Expected Return",
                "difficulty": "medium",
                "problem_text": "Using the CAPM: the risk-free rate is 3%, the expected market return is 10%. A stock has a beta of 1.5. What is the stock's expected return (in percent)?",
                "formula": "\\(E[R_i] = r_f + \\beta_i \\times (E[R_m] - r_f)\\)",
                "solution_steps": [
                    "Step 1: Identify the variables: \\(r_f = 3\\%,\\ E[R_m] = 10\\%,\\ \\beta = 1.5\\)",
                    "Step 2: Apply the CAPM: \\(E[R] = r_f + \\beta \\times (E[R_m] - r_f)\\)",
                    "Step 3: Calculate the market risk premium: \\(10\\% - 3\\% = 7\\%\\)",
                    "Step 4: Multiply by beta: \\(1.5 \\times 7\\% = 10.5\\%\\)",
                    "Step 5: Add the risk-free rate: \\(3\\% + 10.5\\% = 13.5\\%\\)",
                    "Step 6: Final answer: \\(E[R] = 13.5\\%\\)"
                ],
                "correct_answer": 13.5,
                "tolerance": 0.1,
                "unit": "percent",
                "hints": {
                    "level_1": "The CAPM says expected return depends on the risk-free rate, beta, and the market risk premium",
                    "level_2": "Formula: \\(E[R] = r_f + \\beta \\times (E[R_m] - r_f)\\). First find the market risk premium.",
                    "level_3": "Market risk premium \\(= 10 - 3 = 7\\). Then \\(E[R] = 3 + 1.5 \\times 7\\)"
                }
            },
            {
                "id": "capm_006",
                "topic": "CAPM with Negative Beta",
                "difficulty": "medium",
                "problem_text": "SafeHaven Corp has a beta of -0.20. The expected market return is 10% and the risk-free rate is 2%. What is SafeHaven's expected return according to the CAPM (in percent)?",
                "formula": "\\(E[R_i] = r_f + \\beta_i \\times (E[R_m] - r_f)\\)",
                "solution_steps": [
                    "Step 1: Identify the variables: \\(r_f = 2\\%,\\ E[R_m] = 10\\%,\\ \\beta = -0.20\\)",
                    "Step 2: Apply the CAPM: \\(E[R] = r_f + \\beta \\times (E[R_m] - r_f)\\)",
                    "Step 3: Calculate the market risk premium: \\(10\\% - 2\\% = 8\\%\\)",
                    "Step 4: Multiply by beta: \\(-0.20 \\times 8\\% = -1.6\\%\\)",
                    "Step 5: Add the risk-free rate: \\(2\\% + (-1.6\\%) = 0.4\\%\\)",
                    "Step 6: Final answer: \\(E[R] = 0.4\\%\\)"
                ],
                "correct_answer": 0.4,
                "tolerance": 0.1,
                "unit": "percent",
                "hints": {
                    "level_1": "A negative beta means the stock moves opposite to the market - it's like insurance",
                    "level_2": "The CAPM still applies the same way: \\(E[R] = r_f + \\beta \\times (E[R_m] - r_f)\\), but beta is negative",
                    "level_3": "\\(E[R] = 2 + (-0.20) \\times (10 - 2) = 2 + (-0.20 \\times 8) = 2 - 1.6\\)"
                }
            },
            {
                "id": "capm_007",
                "topic": "Portfolio Expected Return via CAPM",
                "difficulty": "hard",
                "problem_text": "Stock X has a beta of 0.80 and Stock Y has a beta of 1.60. The risk-free rate is 3% and the expected market return is 11%. What is the expected return of a portfolio with 50% in X and 50% in Y (in percent)?",
                "formula": "\\(\\beta_P = w_1 \\beta_1 + w_2 \\beta_2\\), then \\(E[R_P] = r_f + \\beta_P \\times (E[R_m] - r_f)\\)",
                "solution_steps": [
                    "Step 1: Calculate the portfolio beta: \\(\\beta_P = 0.50 \\times 0.80 + 0.50 \\times 1.60\\)",
                    "Step 2: Compute each term: \\(0.50 \\times 0.80 = 0.40\\) and \\(0.50 \\times 1.60 = 0.80\\)",
                    "Step 3: Sum for portfolio beta: \\(\\beta_P = 0.40 + 0.80 = 1.20\\)",
                    "Step 4: Apply CAPM: \\(E[R_P] = 3 + 1.20 \\times (11 - 3)\\)",
                    "Step 5: Calculate: \\(E[R_P] = 3 + 1.20 \\times 8 = 3 + 9.60\\)",
                    "Step 6: Final answer: \\(E[R_P] = 12.60\\%\\)"
                ],
                "correct_answer": 12.60,
                "tolerance": 0.2,
                "unit": "percent",
                "hints": {
                    "level_1": "First find the portfolio beta as the weighted average of the individual betas",
                    "level_2": "\\(\\beta_P = w_X \\beta_X + w_Y \\beta_Y\\). Then apply the CAPM.",
                    "level_3": "\\(\\beta_P = 0.50 \\times 0.80 + 0.50 \\times 1.60 = 1.20\\). Then \\(E[R_P] = 3 + 1.20 \\times (11-3)\\)"
                }
            },
            {
                "id": "capm_008",
                "topic": "Beta from Correlation",
                "difficulty": "medium",
                "problem_text": "A stock has a standard deviation of 50%, its correlation with the market is 0.5, and the market's standard deviation is 25%. What is the stock's beta?",
                "formula": "\\(\\beta = \\frac{SD(R_i) \\times \\text{Corr}(R_i, R_m)}{SD(R_m)}\\)",
                "solution_steps": [
                    "Step 1: Identify the variables: \\(SD(R) = 50\\%,\\ \\text{Corr}(R, R_m) = 0.5,\\ SD(R_m) = 25\\%\\)",
                    "Step 2: Apply the beta formula: \\(\\beta = \\frac{SD(R) \\times \\text{Corr}(R, R_m)}{SD(R_m)}\\)",
                    "Step 3: Calculate the numerator: \\(50 \\times 0.5 = 25\\)",
                    "Step 4: Divide by market SD: \\(\\frac{25}{25} = 1.00\\)",
                    "Step 5: Final answer: \\(\\beta = 1.00\\)"
                ],
                "correct_answer": 1.00,
                "tolerance": 0.05,
                "unit": "decimal",
                "hints": {
                    "level_1": "Beta can be calculated from the stock's volatility, its correlation with the market, and the market's volatility",
                    "level_2": "Formula: \\(\\beta = \\frac{SD(\\text{stock}) \\times \\text{Corr}(\\text{stock}, \\text{market})}{SD(\\text{market})}\\)",
                    "level_3": "Calculate: \\(\\frac{50 \\times 0.5}{25} = \\frac{25}{25}\\)"
                }
            },
            {
                "id": "capm_009",
                "topic": "Jensen's Alpha",
                "difficulty": "medium",
                "problem_text": "Jensen's alpha measures:\n\n(1) The total return of a stock\n(2) How much a stock's return exceeds the CAPM prediction\n(3) The stock's exposure to market risk\n(4) The stock's idiosyncratic risk",
                "formula": "\\(\\alpha = R_{\\text{actual}} - [r_f + \\beta \\times (R_m - r_f)]\\)",
                "solution_steps": [
                    "Step 1: Jensen's alpha = Actual Return - CAPM Predicted Return",
                    "Step 2: \\(\\alpha = R_{\\text{actual}} - [r_f + \\beta \\times (R_m - r_f)]\\)",
                    "Step 3: It measures how much the stock's actual return exceeded (or fell short of) what CAPM predicts",
                    "Step 4: This is different from total return (Option 1), beta/market risk exposure (Option 3), or idiosyncratic risk (Option 4)",
                    "Step 5: Answer: Option 2 - How much a stock's return exceeds the CAPM prediction"
                ],
                "correct_answer": 2,
                "tolerance": 0,
                "unit": "choice",
                "hints": {
                    "level_1": "Think about what alpha represents relative to the Security Market Line",
                    "level_2": "\\(\\alpha\\) = Actual return minus the return predicted by CAPM. What does this difference tell you?",
                    "level_3": "\\(\\alpha\\) measures outperformance (or underperformance) relative to what CAPM says the stock should earn given its \\(\\beta\\)."
                }
            },
            {
                "id": "capm_010",
                "topic": "Idiosyncratic Risk",
                "difficulty": "hard",
                "problem_text": "According to the CAPM, why doesn't idiosyncratic risk earn a risk premium?\n\n(1) Idiosyncratic risk doesn't exist in well-managed companies\n(2) Idiosyncratic risk can be diversified away, so investors don't need compensation for bearing it\n(3) The government insures investors against idiosyncratic risk\n(4) Idiosyncratic risk is always smaller than systematic risk",
                "formula": "\\(\\text{Total Risk} = \\text{Systematic Risk} + \\text{Idiosyncratic Risk}\\)",
                "solution_steps": [
                    "Step 1: Total risk has two components: systematic (market) risk and idiosyncratic (firm-specific) risk",
                    "Step 2: Idiosyncratic risk is specific to individual firms (e.g., a CEO leaving, a product recall)",
                    "Step 3: By holding a diversified portfolio, idiosyncratic risks of different stocks cancel each other out",
                    "Step 4: Since investors can eliminate this risk for free through diversification, the market doesn't reward them for bearing it",
                    "Step 5: Only systematic risk (\\(\\beta\\)) earns a risk premium in the CAPM",
                    "Step 6: Answer: Option 2 - Idiosyncratic risk can be diversified away"
                ],
                "correct_answer": 2,
                "tolerance": 0,
                "unit": "choice",
                "hints": {
                    "level_1": "Think about what happens to firm-specific risk when you hold many stocks in a portfolio",
                    "level_2": "If a risk can be eliminated for free, would the market pay you extra for taking it?",
                    "level_3": "Diversification eliminates idiosyncratic risk. Since it's free to diversify, investors aren't compensated for bearing risk they could have avoided."
                }
            }
        ];

        let currentProblemIndex = 0;
        let attemptCount = 0;
        let completedProblems = new Set();
        let selectedChoice = null;

        // Spaced repetition tracking
        const TOPIC_KEY = 'capm'; // Unique key for this topic
        const MISSED_PROBLEMS_KEY = 'finance_missed_capm';
        const MASTERED_PROBLEMS_KEY = 'finance_mastered_capm';

        // Check if we're in review mode (URL parameter)
        const urlParams = new URLSearchParams(window.location.search);
        const reviewMode = urlParams.get('review') === 'true';

        function getMissedProblems() {
            const stored = localStorage.getItem(MISSED_PROBLEMS_KEY);
            return stored ? JSON.parse(stored) : {};
        }

        function getMasteredProblems() {
            const stored = localStorage.getItem(MASTERED_PROBLEMS_KEY);
            return stored ? JSON.parse(stored) : {};
        }

        function saveMissedProblem(problemId) {
            const missed = getMissedProblems();
            missed[problemId] = {
                count: (missed[problemId]?.count || 0) + 1,
                lastMissed: new Date().toISOString()
            };
            localStorage.setItem(MISSED_PROBLEMS_KEY, JSON.stringify(missed));
        }

        function markProblemMastered(problemId) {
            // Remove from missed
            const missed = getMissedProblems();
            delete missed[problemId];
            localStorage.setItem(MISSED_PROBLEMS_KEY, JSON.stringify(missed));

            // Add to mastered
            const mastered = getMasteredProblems();
            mastered[problemId] = {
                masteredOn: new Date().toISOString()
            };
            localStorage.setItem(MASTERED_PROBLEMS_KEY, JSON.stringify(mastered));
        }

        function filterProblemsForReview() {
            if (!reviewMode) return problems;

            const missed = getMissedProblems();
            const missedIds = Object.keys(missed);

            if (missedIds.length === 0) {
                return []; // No problems to review
            }

            return problems.filter(p => missedIds.includes(p.id));
        }

        // Load problems on page load
        function loadProblems() {
            // Filter problems if in review mode
            if (reviewMode) {
                const reviewProblems = filterProblemsForReview();
                if (reviewProblems.length === 0) {
                    showNoProblemsToReview();
                    return;
                }
                problems = reviewProblems;
                // Update header to show review mode
                document.querySelector('h1').textContent = 'Portfolio Analysis & CAPM - Review';
                document.querySelector('.subtitle').textContent = 'Reviewing missed problems';
            }
            displayProblem();
        }

        function showNoProblemsToReview() {
            const problemCard = document.getElementById('problemCard');
            problemCard.innerHTML = `
                <div style="text-align: center; padding: 3rem;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">üéâ</div>
                    <h2 style="font-size: 1.75rem; margin-bottom: 1rem; color: #2D3748;">No Problems to Review!</h2>
                    <p style="font-size: 1.1rem; color: #4A5568; margin-bottom: 2rem;">
                        You've mastered all the problems you previously missed. Great work!
                    </p>
                    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                        <a href="week7-capm.html" class="btn-primary" style="text-decoration: none; display: inline-block; padding: 0.75rem 2rem;">Practice All Problems</a>
                        <a href="index.html" class="btn-secondary" style="text-decoration: none; display: inline-block; padding: 0.75rem 2rem;">Back to Topics</a>
                    </div>
                </div>
            `;
        }

        // Toggle worked example visibility
        function toggleWorkedExample() {
            const toggle = document.getElementById('workedExampleToggle');
            const toggleText = document.getElementById('toggleText');
            toggle.classList.toggle('expanded');
            toggleText.textContent = toggle.classList.contains('expanded') ? 'Hide' : 'Show';
        }

        // Populate worked example content
        function displayWorkedExample(problemId) {
            const example = workedExamples[problemId];
            const container = document.getElementById('workedExampleContent');
            const toggle = document.getElementById('workedExampleToggle');

            // Reset to collapsed state
            toggle.classList.remove('expanded');
            document.getElementById('toggleText').textContent = 'Show';

            if (!example) {
                toggle.style.display = 'none';
                return;
            }

            toggle.style.display = 'block';

            let stepsHtml = example.steps.map((step, index) => `
                <div class="example-step">
                    <span class="example-step-number">${index + 1}</span>
                    <div class="example-step-content">
                        <div class="example-step-explanation">${step.explanation}</div>
                        <div class="example-step-calculation">${step.calculation}</div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = `
                <div class="example-problem">
                    <div class="example-label">Example Problem</div>
                    <div class="example-text">${example.problem}</div>
                </div>
                <div class="example-solution">
                    <div class="example-label">Step-by-Step Solution</div>
                    ${stepsHtml}
                    <div class="example-final-answer">
                        <div class="example-final-answer-label">Final Answer</div>
                        <div class="example-final-answer-value">${example.answer}</div>
                    </div>
                </div>
            `;
        }

        function displayProblem() {
            if (problems.length === 0) return;

            const problem = problems[currentProblemIndex];
            attemptCount = 0;
            selectedChoice = null;

            // Update progress
            const progress = ((currentProblemIndex) / problems.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressText').textContent =
                `Problem ${currentProblemIndex + 1} of ${problems.length}`;

            // Update difficulty badge
            const difficultyBadge = document.getElementById('difficultyBadge');
            difficultyBadge.textContent = problem.difficulty.charAt(0).toUpperCase() + problem.difficulty.slice(1);
            difficultyBadge.className = 'badge badge-' + problem.difficulty;

            // Update topic badge
            document.getElementById('topicBadge').textContent = problem.topic;

            // Display worked example for this problem
            displayWorkedExample(problem.id);

            // Update problem text
            if (problem.unit === 'choice') {
                // For multiple choice, split problem text at the options
                const lines = problem.problem_text.split('\n').filter(l => l.trim() !== '');
                const questionText = lines[0];
                const options = lines.slice(1);

                let problemHtml = questionText;
                if (options.length > 0) {
                    problemHtml += '<ul class="mc-options" id="mcOptions">';
                    options.forEach((opt, idx) => {
                        const optText = opt.trim();
                        problemHtml += `<li onclick="selectChoice(${idx + 1})" data-choice="${idx + 1}">${optText}</li>`;
                    });
                    problemHtml += '</ul>';
                }
                document.getElementById('problemText').innerHTML = problemHtml;

                // Hide the number input, show a hidden input for choice
                document.getElementById('answerInput').style.display = 'none';
                document.querySelector('label[for="answerInput"]').style.display = 'none';
            } else {
                document.getElementById('problemText').textContent = problem.problem_text;
                document.getElementById('answerInput').style.display = '';
                document.querySelector('label[for="answerInput"]').style.display = '';
            }

            // Update formula (but keep it hidden initially)
            document.getElementById('formulaText').textContent = problem.formula;
            document.getElementById('formulaBox').classList.add('hidden');

            // Clear answer input and feedback
            document.getElementById('answerInput').value = '';
            document.getElementById('feedbackBox').className = 'hidden';
            document.getElementById('submitBtn').disabled = false;

            // Render LaTeX
            renderMath();

            // Update navigation buttons
            document.getElementById('prevBtn').disabled = currentProblemIndex === 0;
            document.getElementById('nextBtn').textContent =
                currentProblemIndex === problems.length - 1 ? 'Finish' : 'Next Problem';
        }

        function selectChoice(choiceNum) {
            selectedChoice = choiceNum;
            // Update visual selection
            const options = document.querySelectorAll('#mcOptions li');
            options.forEach(li => {
                li.classList.remove('selected');
                if (parseInt(li.getAttribute('data-choice')) === choiceNum) {
                    li.classList.add('selected');
                }
            });
        }

        function checkAnswer() {
            const problem = problems[currentProblemIndex];
            let userAnswer;

            if (problem.unit === 'choice') {
                if (selectedChoice === null) {
                    showFeedback('Please select an option', 'incorrect');
                    return;
                }
                userAnswer = selectedChoice;
            } else {
                userAnswer = parseFloat(document.getElementById('answerInput').value);
                if (isNaN(userAnswer)) {
                    showFeedback('Please enter a valid number', 'incorrect');
                    return;
                }
            }

            // Smart tolerance: allow for rounding errors from intermediate calculations
            const percentTolerance = Math.abs(problem.correct_answer) * 0.005; // 0.5%
            const minTolerance = problem.unit === 'percent' ? 0.05 : (problem.unit === 'choice' ? 0 : 0.01);
            const calculatedTolerance = Math.max(percentTolerance, minTolerance);

            // Use problem-specific tolerance if provided, otherwise use calculated tolerance
            const tolerance = problem.tolerance !== undefined ? problem.tolerance : calculatedTolerance;

            const isCorrect = Math.abs(userAnswer - problem.correct_answer) <= tolerance;

            attemptCount++;

            if (isCorrect) {
                completedProblems.add(currentProblemIndex);
                // If correct on first attempt, mark as mastered
                if (attemptCount === 1) {
                    markProblemMastered(problem.id);
                }
                showCorrectFeedback();
            } else {
                // Track this as a missed problem
                saveMissedProblem(problem.id);
                showIncorrectFeedback();
            }
        }

        function showFeedback(message, type) {
            const feedbackBox = document.getElementById('feedbackBox');
            feedbackBox.className = 'feedback-box feedback-' + type;
            feedbackBox.innerHTML = `<div class="feedback-title">${message}</div>`;
        }

        function showCorrectFeedback() {
            const problem = problems[currentProblemIndex];
            const feedbackBox = document.getElementById('feedbackBox');

            let html = `
                <div class="feedback-title">
                    Correct!
                </div>
                <div class="feedback-content">
                    Great job! The correct answer is ${formatAnswer(problem.correct_answer, problem.unit)}.
                </div>
            `;

            feedbackBox.className = 'feedback-box feedback-correct';
            feedbackBox.innerHTML = html;

            document.getElementById('submitBtn').disabled = true;
            renderMath();
        }

        function showIncorrectFeedback() {
            const problem = problems[currentProblemIndex];
            const feedbackBox = document.getElementById('feedbackBox');

            let html = `
                <div class="feedback-title">
                    Not quite right
                </div>
            `;

            // Adaptive feedback based on attempt count
            if (attemptCount === 1) {
                html += `
                    <div class="hint-box">
                        <strong>Hint:</strong> ${problem.hints.level_1}
                    </div>
                `;
            } else if (attemptCount === 2) {
                // Show formula on second attempt
                document.getElementById('formulaBox').classList.remove('hidden');
                html += `
                    <div class="hint-box">
                        <strong>Formula revealed above.</strong> ${problem.hints.level_2}
                    </div>
                `;
            } else if (attemptCount === 3) {
                // Keep formula visible
                document.getElementById('formulaBox').classList.remove('hidden');
                html += `
                    <div class="hint-box">
                        <strong>Detailed hint:</strong> ${problem.hints.level_3}
                    </div>
                    <div style="margin-top: 1rem;">
                        <button class="btn-secondary" onclick="showFullSolution()">Show Full Solution</button>
                    </div>
                `;
            } else {
                // After 3 attempts, show full solution automatically
                showFullSolution();
                return;
            }

            feedbackBox.className = 'feedback-box feedback-incorrect';
            feedbackBox.innerHTML = html;
            renderMath();
        }

        function showFullSolution() {
            const problem = problems[currentProblemIndex];
            const feedbackBox = document.getElementById('feedbackBox');

            let html = `
                <div class="feedback-title">
                    Solution
                </div>
                <div class="solution-steps">
            `;

            problem.solution_steps.forEach((step, index) => {
                html += `
                    <div class="solution-step">
                        <span class="step-number">Step ${index + 1}:</span> ${step}
                    </div>
                `;
            });

            html += `
                </div>
                <div class="feedback-content" style="margin-top: 1rem; padding-top: 1rem; border-top: 2px solid #E2E8F0;">
                    <strong>Final Answer:</strong> ${formatAnswer(problem.correct_answer, problem.unit)}
                </div>
            `;

            feedbackBox.className = 'feedback-box feedback-correct';
            feedbackBox.innerHTML = html;

            document.getElementById('submitBtn').disabled = true;
            renderMath();
        }

        function nextProblem() {
            if (currentProblemIndex < problems.length - 1) {
                currentProblemIndex++;
                displayProblem();
            } else {
                showSummary();
            }
        }

        function previousProblem() {
            if (currentProblemIndex > 0) {
                currentProblemIndex--;
                displayProblem();
            }
        }

        function showSummary() {
            const problemCard = document.getElementById('problemCard');
            const completed = completedProblems.size;
            const total = problems.length;
            const percentage = Math.round((completed / total) * 100);

            // Check how many problems are in the missed queue
            const missed = getMissedProblems();
            const missedCount = Object.keys(missed).length;

            let reviewButton = '';
            if (missedCount > 0 && !reviewMode) {
                reviewButton = `
                    <a href="week7-capm.html?review=true" class="btn-primary" style="text-decoration: none; display: inline-block; background-color: #DD6B20;">
                        Review ${missedCount} Missed Problem${missedCount > 1 ? 's' : ''}
                    </a>
                `;
            }

            let celebrationMessage = '';
            if (reviewMode && completed === total) {
                celebrationMessage = `
                    <div style="background-color: #C6F6D5; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        <strong>Excellent!</strong> You've mastered these previously missed problems!
                    </div>
                `;
            }

            problemCard.innerHTML = `
                <div style="text-align: center; padding: 3rem;">
                    <h2 style="font-size: 2rem; margin-bottom: 1rem;">${reviewMode ? 'Review Session Complete!' : 'Practice Session Complete!'}</h2>
                    ${celebrationMessage}
                    <div style="font-size: 3rem; font-weight: bold; color: #2C5282; margin: 2rem 0;">
                        ${completed} / ${total}
                    </div>
                    <div style="font-size: 1.25rem; color: #4A5568; margin-bottom: 2rem;">
                        You got ${percentage}% of problems correct on the first try!
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                        ${reviewButton}
                        <button class="btn-primary" onclick="location.href='week7-capm.html'">Practice All</button>
                        <a href="index.html" class="btn-secondary" style="text-decoration: none; display: inline-block;">Back to Topics</a>
                    </div>
                </div>
            `;
        }

        function renderMath() {
            setTimeout(() => {
                if (typeof renderMathInElement === 'function') {
                    renderMathInElement(document.body, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '\\(', right: '\\)', display: false}
                        ],
                        throwOnError: false
                    });
                }
            }, 100);
        }

        // Allow Enter key to submit
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('answerInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !document.getElementById('submitBtn').disabled) {
                    checkAnswer();
                }
            });
            loadProblems();
        });
    </script>
</body>
</html>
