<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Practice Tool - Options</title>

    <!-- KaTeX for LaTeX rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #ffffff;
            color: #1a1a1a;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            background-color: #2C5282;
            color: white;
            padding: 2rem;
            margin-bottom: 2rem;
            border-radius: 8px;
        }

        .header-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .back-link {
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .back-link:hover {
            color: white;
        }

        h1 {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }

        .progress-bar {
            background-color: #E2E8F0;
            height: 8px;
            border-radius: 4px;
            margin: 1.5rem 0;
            overflow: hidden;
        }

        .progress-fill {
            background-color: #48BB78;
            height: 100%;
            transition: width 0.3s ease;
        }

        .problem-card {
            background: white;
            border: 2px solid #E2E8F0;
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .problem-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #E2E8F0;
        }

        .problem-meta {
            display: flex;
            gap: 1rem;
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .badge-easy { background-color: #C6F6D5; color: #22543D; }
        .badge-medium { background-color: #FEF3C7; color: #78350F; }
        .badge-hard { background-color: #FED7D7; color: #742A2A; }

        .problem-number {
            font-size: 0.875rem;
            color: #718096;
            font-weight: 500;
        }

        .problem-text {
            font-size: 1.125rem;
            line-height: 1.8;
            margin-bottom: 2rem;
            color: #2D3748;
        }

        .formula-box {
            background-color: #F7FAFC;
            border-left: 4px solid #2C5282;
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            border-radius: 4px;
        }

        .formula-label {
            font-size: 0.875rem;
            color: #4A5568;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .answer-section {
            margin: 2rem 0;
        }

        .input-group {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        label {
            font-weight: 500;
            color: #2D3748;
        }

        input[type="number"] {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 2px solid #CBD5E0;
            border-radius: 6px;
            font-size: 1.125rem;
            transition: border-color 0.2s;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #2C5282;
        }

        button {
            padding: 0.75rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: #2C5282;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2A4365;
        }

        .btn-primary:disabled {
            background-color: #CBD5E0;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: #E2E8F0;
            color: #2D3748;
        }

        .btn-secondary:hover {
            background-color: #CBD5E0;
        }

        .feedback-box {
            margin-top: 1.5rem;
            padding: 1.5rem;
            border-radius: 8px;
            border: 2px solid;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .feedback-correct {
            background-color: #F0FFF4;
            border-color: #48BB78;
            color: #22543D;
        }

        .feedback-incorrect {
            background-color: #FFF5F5;
            border-color: #F56565;
            color: #742A2A;
        }

        .feedback-title {
            font-weight: 600;
            font-size: 1.125rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .feedback-content {
            margin-top: 1rem;
            line-height: 1.8;
        }

        .hint-box {
            background-color: #EBF8FF;
            border-left: 4px solid #3182CE;
            padding: 1rem 1.5rem;
            margin-top: 1rem;
            border-radius: 4px;
        }

        .solution-steps {
            margin-top: 1rem;
        }

        .solution-step {
            padding: 0.75rem 0;
            border-bottom: 1px solid #E2E8F0;
        }

        .solution-step:last-child {
            border-bottom: none;
        }

        .step-number {
            font-weight: 600;
            color: #2C5282;
        }

        .navigation {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .navigation button {
            flex: 1;
        }

        .hidden {
            display: none;
        }

        /* Calculator Styles */
        .calculator-toolbar {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .calculator-toggle-btn {
            background-color: #2C5282;
            color: white;
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 50px;
            font-size: 1.125rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .calculator-toggle-btn:hover {
            background-color: #2A4365;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }

        .calculator-container {
            position: absolute;
            bottom: 70px;
            right: 0;
            width: 320px;
            background-color: #F7FAFC;
            border: 2px solid #E2E8F0;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            padding: 1rem;
            display: none;
        }

        .calculator-container.active {
            display: block;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .calculator-display {
            background-color: #2D3748;
            color: #48BB78;
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            font-family: 'Courier New', monospace;
            font-size: 1.25rem;
            text-align: right;
            min-height: 50px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .calculator-expression {
            font-size: 0.875rem;
            color: #CBD5E0;
            margin-bottom: 0.25rem;
        }

        .calculator-result {
            font-size: 1.25rem;
            color: #48BB78;
            font-weight: 600;
        }

        .calculator-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
        }

        .calc-btn {
            padding: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            border: 1px solid #CBD5E0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            background-color: white;
            color: #2D3748;
        }

        .calc-btn:hover {
            background-color: #EDF2F7;
            transform: translateY(-1px);
        }

        .calc-btn:active {
            transform: translateY(0);
        }

        .calc-btn-operator {
            background-color: #2C5282;
            color: white;
            border-color: #2C5282;
        }

        .calc-btn-operator:hover {
            background-color: #2A4365;
        }

        .calc-btn-equals {
            background-color: #48BB78;
            color: white;
            border-color: #48BB78;
        }

        .calc-btn-equals:hover {
            background-color: #38A169;
        }

        .calc-btn-clear {
            background-color: #F56565;
            color: white;
            border-color: #F56565;
        }

        .calc-btn-clear:hover {
            background-color: #E53E3E;
        }


        /* Worked Example Toggle Styles */
        .worked-example-toggle {
            background: linear-gradient(135deg, #EBF8FF 0%, #E6FFFA 100%);
            border: 2px solid #3182CE;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .worked-example-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .worked-example-header:hover {
            background-color: rgba(49, 130, 206, 0.1);
        }

        .worked-example-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
            color: #2C5282;
        }

        .worked-example-title .icon {
            font-size: 1.25rem;
        }

        .worked-example-subtitle {
            font-size: 0.85rem;
            color: #4A5568;
            font-weight: 400;
        }

        .toggle-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #3182CE;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .toggle-arrow {
            transition: transform 0.3s ease;
            font-size: 1.25rem;
        }

        .worked-example-toggle.expanded .toggle-arrow {
            transform: rotate(180deg);
        }

        .worked-example-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, padding 0.4s ease;
            background-color: #F7FAFC;
        }

        .worked-example-toggle.expanded .worked-example-content {
            max-height: 2000px;
            padding: 1.5rem;
            border-top: 1px solid #BEE3F8;
        }

        .example-problem {
            background: white;
            border-radius: 6px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            border-left: 4px solid #3182CE;
        }

        .example-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #3182CE;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .example-text {
            color: #2D3748;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .example-solution {
            background: white;
            border-radius: 6px;
            padding: 1.25rem;
        }

        .example-step {
            display: flex;
            gap: 1rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid #E2E8F0;
        }

        .example-step:last-child {
            border-bottom: none;
        }

        .example-step-number {
            background-color: #3182CE;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .example-step-content {
            flex: 1;
        }

        .example-step-explanation {
            color: #4A5568;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .example-step-calculation {
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            background-color: #EDF2F7;
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            font-size: 0.9rem;
            color: #2D3748;
        }

        .example-final-answer {
            background: linear-gradient(135deg, #48BB78 0%, #38A169 100%);
            color: white;
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
            text-align: center;
        }

        .example-final-answer-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            opacity: 0.9;
        }

        .example-final-answer-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .now-try-badge {
            background-color: #48BB78;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            h1 {
                font-size: 1.5rem;
            }

            .problem-card {
                padding: 1.5rem;
            }

            .input-group {
                flex-direction: column;
                align-items: stretch;
            }

            .navigation {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-nav">
                <a href="index.html" class="back-link">‚Üê Back to Topics</a>
            </div>
            <h1>Options</h1>
            <div class="subtitle">Week 9 - MGMT 408</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: 0%"></div>
            </div>
            <div class="problem-number" id="progressText">Problem 1 of 10</div>
        </header>

        <div class="problem-card" id="problemCard">
            <div class="problem-header">
                <div class="problem-meta">
                    <span class="badge" id="difficultyBadge">Easy</span>
                    <span class="badge" style="background-color: #EBF8FF; color: #2C5282;" id="topicBadge">Topic</span>
                </div>
            </div>

            <!-- Worked Example Toggle -->
            <div class="worked-example-toggle" id="workedExampleToggle">
                <div class="worked-example-header" onclick="toggleWorkedExample()">
                    <div class="worked-example-title">
                        <span class="icon">üìñ</span>
                        <span>
                            See Worked Example
                            <div class="worked-example-subtitle">Similar problem with step-by-step solution</div>
                        </span>
                    </div>
                    <div class="toggle-indicator">
                        <span class="toggle-text" id="toggleText">Show</span>
                        <span class="toggle-arrow">‚ñº</span>
                    </div>
                </div>
                <div class="worked-example-content" id="workedExampleContent">
                    <!-- Content populated by JavaScript -->
                </div>
            </div>

            <div class="now-try-badge">‚úèÔ∏è Now You Try</div>

            <div class="problem-text" id="problemText">
                Loading problem...
            </div>

            <div class="formula-box hidden" id="formulaBox">
                <div class="formula-label">Formula:</div>
                <div id="formulaText"></div>
            </div>

            <div class="answer-section">
                <div class="input-group">
                    <label for="answerInput">Your Answer:</label>
                    <input type="number" id="answerInput" step="0.01" placeholder="Enter your answer">
                    <button class="btn-primary" id="submitBtn" onclick="checkAnswer()">Submit</button>
                </div>
            </div>

            <div id="feedbackBox" class="hidden"></div>

            <div class="navigation">
                <button class="btn-secondary" id="prevBtn" onclick="previousProblem()">Previous</button>
                <button class="btn-secondary" id="nextBtn" onclick="nextProblem()">Next Problem</button>
            </div>
        </div>
    </div>

    <!-- Calculator Toolbar -->
    <div class="calculator-toolbar">
        <button class="calculator-toggle-btn" onclick="toggleCalculator()">
            Calculator
        </button>
        <div class="calculator-container" id="calculatorContainer">
            <div class="calculator-display">
                <div class="calculator-expression" id="calcExpression">&nbsp;</div>
                <div class="calculator-result" id="calcResult">0</div>
            </div>
            <div class="calculator-buttons">
                <button class="calc-btn calc-btn-clear" onclick="calcClear()">AC</button>
                <button class="calc-btn" onclick="calcBackspace()">Del</button>
                <button class="calc-btn calc-btn-operator" onclick="calcAppend('^')">x^y</button>
                <button class="calc-btn calc-btn-operator" onclick="calcAppend('/')">√∑</button>

                <button class="calc-btn" onclick="calcAppend('7')">7</button>
                <button class="calc-btn" onclick="calcAppend('8')">8</button>
                <button class="calc-btn" onclick="calcAppend('9')">9</button>
                <button class="calc-btn calc-btn-operator" onclick="calcAppend('*')">x</button>

                <button class="calc-btn" onclick="calcAppend('4')">4</button>
                <button class="calc-btn" onclick="calcAppend('5')">5</button>
                <button class="calc-btn" onclick="calcAppend('6')">6</button>
                <button class="calc-btn calc-btn-operator" onclick="calcAppend('-')">-</button>

                <button class="calc-btn" onclick="calcAppend('1')">1</button>
                <button class="calc-btn" onclick="calcAppend('2')">2</button>
                <button class="calc-btn" onclick="calcAppend('3')">3</button>
                <button class="calc-btn calc-btn-operator" onclick="calcAppend('+')">+</button>

                <button class="calc-btn" onclick="calcAppend('0')">0</button>
                <button class="calc-btn" onclick="calcAppend('.')">.</button>
                <button class="calc-btn" onclick="calcAppend('(')">(</button>
                <button class="calc-btn" onclick="calcAppend(')')">)</button>

                <button class="calc-btn calc-btn-equals" onclick="calcEquals()" style="grid-column: span 4;">=</button>
            </div>
        </div>
    </div>

    <script>
        // Calculator state
        let calcCurrentExpression = '';
        let calcCurrentResult = '0';
        let calculatorOpen = false;

        function toggleCalculator() {
            calculatorOpen = !calculatorOpen;
            const container = document.getElementById('calculatorContainer');
            if (calculatorOpen) {
                container.classList.add('active');
            } else {
                container.classList.remove('active');
            }
        }

        function closeCalculator() {
            if (calculatorOpen) {
                calculatorOpen = false;
                document.getElementById('calculatorContainer').classList.remove('active');
            }
        }

        // Close calculator when clicking outside
        document.addEventListener('click', (e) => {
            const toolbar = document.querySelector('.calculator-toolbar');
            const container = document.getElementById('calculatorContainer');

            // If click is outside the calculator toolbar and container, close it
            if (calculatorOpen && !toolbar.contains(e.target)) {
                closeCalculator();
            }
        });

        function calcAppend(value) {
            calcCurrentExpression += value;
            updateCalcDisplay();
        }

        function calcClear() {
            calcCurrentExpression = '';
            calcCurrentResult = '0';
            updateCalcDisplay();
        }

        function calcBackspace() {
            calcCurrentExpression = calcCurrentExpression.slice(0, -1);
            updateCalcDisplay();
        }

        function calcEquals() {
            if (!calcCurrentExpression) return;

            try {
                // Replace ^ with ** for JavaScript exponentiation
                let expression = calcCurrentExpression.replace(/\^/g, '**');

                // Evaluate the expression safely
                let result = Function('"use strict"; return (' + expression + ')')();

                // Round to 4 decimal places to avoid floating point issues
                if (typeof result === 'number') {
                    calcCurrentResult = Number(result.toFixed(4)).toString();
                } else {
                    calcCurrentResult = result.toString();
                }
            } catch (error) {
                calcCurrentResult = 'Error';
            }

            updateCalcDisplay();
        }

        function updateCalcDisplay() {
            document.getElementById('calcExpression').textContent = calcCurrentExpression || '\u00A0';
            document.getElementById('calcResult').textContent = calcCurrentResult;
        }

        // Allow keyboard input for calculator (only when calculator is open)
        document.addEventListener('keydown', (e) => {
            if (document.activeElement.id === 'answerInput') return; // Don't interfere with answer input
            if (!calculatorOpen) return; // Only work when calculator is open

            if (e.key >= '0' && e.key <= '9') {
                calcAppend(e.key);
            } else if (e.key === '.') {
                calcAppend('.');
            } else if (e.key === '+' || e.key === '-' || e.key === '*' || e.key === '/') {
                calcAppend(e.key);
            } else if (e.key === '^') {
                calcAppend('^');
            } else if (e.key === 'Enter' && calcCurrentExpression) {
                calcEquals();
            } else if (e.key === 'Backspace' && calcCurrentExpression) {
                e.preventDefault();
                calcBackspace();
            } else if (e.key === 'Escape') {
                calcClear();
            } else if (e.key === '(' || e.key === ')') {
                calcAppend(e.key);
            }
        });

        // Format answer based on unit type
        function formatAnswer(value, unit) {
            if (unit === 'dollars') return '$' + value.toLocaleString();
            if (unit === 'percent') return value + '%';
            if (unit === 'choice') return 'Option ' + value;
            return value.toString();
        }

        // Worked examples for each problem type
        const workedExamples = {
            "opt_001": {
                problem: "You hold a call option with strike price \\(K = \\$30\\). At expiration, the stock price is \\(\\$38\\). What is your payoff?",
                steps: [
                    { explanation: "Identify the variables:", calculation: "Strike price \\(K = \\$30\\), Stock price at expiration \\(S_T = \\$38\\)" },
                    { explanation: "Write the call option payoff formula:", calculation: "\\(\\text{Call Payoff} = \\max(S_T - K, 0)\\)" },
                    { explanation: "Plug in our values:", calculation: "\\(\\text{Call Payoff} = \\max(38 - 30, 0)\\)" },
                    { explanation: "Calculate:", calculation: "\\(\\text{Call Payoff} = \\max(8, 0) = \\$8\\)" }
                ],
                answer: "$8"
            },
            "opt_002": {
                problem: "You hold a call option with strike price \\(K = \\$50\\). At expiration, the stock price is \\(\\$42\\). What is your payoff?",
                steps: [
                    { explanation: "Identify the variables:", calculation: "Strike price \\(K = \\$50\\), Stock price at expiration \\(S_T = \\$42\\)" },
                    { explanation: "Write the call option payoff formula:", calculation: "\\(\\text{Call Payoff} = \\max(S_T - K, 0)\\)" },
                    { explanation: "Plug in our values:", calculation: "\\(\\text{Call Payoff} = \\max(42 - 50, 0)\\)" },
                    { explanation: "Calculate:", calculation: "\\(\\text{Call Payoff} = \\max(-8, 0) = \\$0\\)" },
                    { explanation: "The option expires worthless because the stock price is below the strike.", calculation: "You would not exercise the right to buy at \\(\\$50\\) when the stock is only \\(\\$42\\)." }
                ],
                answer: "$0"
            },
            "opt_003": {
                problem: "You hold a put option with strike price \\(K = \\$45\\). At expiration, the stock price is \\(\\$37\\). What is your payoff?",
                steps: [
                    { explanation: "Identify the variables:", calculation: "Strike price \\(K = \\$45\\), Stock price at expiration \\(S_T = \\$37\\)" },
                    { explanation: "Write the put option payoff formula:", calculation: "\\(\\text{Put Payoff} = \\max(K - S_T, 0)\\)" },
                    { explanation: "Plug in our values:", calculation: "\\(\\text{Put Payoff} = \\max(45 - 37, 0)\\)" },
                    { explanation: "Calculate:", calculation: "\\(\\text{Put Payoff} = \\max(8, 0) = \\$8\\)" }
                ],
                answer: "$8"
            },
            "opt_004": {
                problem: "You hold a put option with strike price \\(K = \\$35\\). At expiration, the stock price is \\(\\$40\\). What is your payoff?",
                steps: [
                    { explanation: "Identify the variables:", calculation: "Strike price \\(K = \\$35\\), Stock price at expiration \\(S_T = \\$40\\)" },
                    { explanation: "Write the put option payoff formula:", calculation: "\\(\\text{Put Payoff} = \\max(K - S_T, 0)\\)" },
                    { explanation: "Plug in our values:", calculation: "\\(\\text{Put Payoff} = \\max(35 - 40, 0)\\)" },
                    { explanation: "Calculate:", calculation: "\\(\\text{Put Payoff} = \\max(-5, 0) = \\$0\\)" },
                    { explanation: "The put expires worthless because the stock is above the strike.", calculation: "You would not exercise the right to sell at \\(\\$35\\) when the stock is worth \\(\\$40\\)." }
                ],
                answer: "$0"
            },
            "opt_005": {
                problem: "You wrote (sold) a call option with strike price \\(K = \\$30\\). At expiration, the stock price is \\(\\$38\\). What is your payoff?",
                steps: [
                    { explanation: "Identify the variables:", calculation: "Strike price \\(K = \\$30\\), Stock price at expiration \\(S_T = \\$38\\)" },
                    { explanation: "As the writer of a call, your payoff is the negative of the holder's payoff:", calculation: "\\(\\text{Writer Payoff} = -\\max(S_T - K, 0)\\)" },
                    { explanation: "Plug in our values:", calculation: "\\(\\text{Writer Payoff} = -\\max(38 - 30, 0)\\)" },
                    { explanation: "Calculate:", calculation: "\\(\\text{Writer Payoff} = -\\max(8, 0) = -\\$8\\)" },
                    { explanation: "You lose \\(\\$8\\) because you must sell the stock at \\(\\$30\\) when it's worth \\(\\$38\\).", calculation: "The option holder exercises against you." }
                ],
                answer: "-$8"
            },
            "opt_006": {
                problem: "You bought a call option with strike \\(K = \\$30\\) for \\(\\$3.00\\), financing by borrowing at 3% annual rate. The option expires in 90 days. If the stock price at expiration is \\(\\$38\\), what is your profit?",
                steps: [
                    { explanation: "Identify the variables:", calculation: "\\(K = \\$30\\), \\(\\text{Premium} = \\$3.00\\), \\(r = 3\\%\\), \\(T = 90/365\\) years, \\(S_T = \\$38\\)" },
                    { explanation: "Calculate the future value of the premium (cost of financing):", calculation: "\\(FV(\\text{Premium}) = 3.00 \\times (1.03)^{90/365}\\)" },
                    { explanation: "Compute the exponent:", calculation: "\\((1.03)^{90/365} = (1.03)^{0.24658} = 1.00730\\)" },
                    { explanation: "Calculate FV of premium:", calculation: "\\(FV(\\text{Premium}) = 3.00 \\times 1.00730 = \\$3.0219\\)" },
                    { explanation: "Calculate option payoff at expiration:", calculation: "\\(\\text{Payoff} = \\max(38 - 30, 0) = \\$8.00\\)" },
                    { explanation: "Calculate profit:", calculation: "\\(\\text{Profit} = \\text{Payoff} - FV(\\text{Premium}) = 8.00 - 3.0219 = \\$4.98\\)" }
                ],
                answer: "$4.98"
            },
            "opt_007": {
                problem: "Stock price \\(S = \\$150.00\\), call price \\(C = \\$12.50\\) with strike \\(K = \\$160\\), risk-free rate 3% per year, expiration in 60 days. Using put-call parity \\(P = PV(K) + C - S\\), what is the put price?",
                steps: [
                    { explanation: "Identify the variables:", calculation: "\\(S = \\$150.00\\), \\(C = \\$12.50\\), \\(K = \\$160\\), \\(r = 3\\%\\), \\(T = 60/365\\) years" },
                    { explanation: "Write the put-call parity formula:", calculation: "\\(P = PV(K) + C - S\\)" },
                    { explanation: "Calculate PV(K):", calculation: "\\(PV(K) = \\frac{160}{(1.03)^{60/365}} = \\frac{160}{(1.03)^{0.16438}}\\)" },
                    { explanation: "Compute the denominator:", calculation: "\\((1.03)^{0.16438} = 1.004878 \\Rightarrow PV(K) = \\frac{160}{1.004878} = \\$159.22\\)" },
                    { explanation: "Plug into the formula:", calculation: "\\(P = 159.22 + 12.50 - 150.00 = \\$21.72\\)" }
                ],
                answer: "$21.72"
            },
            "opt_008": {
                problem: "Binomial model: Stock price \\(= \\$40\\), strike \\(= \\$40\\). In one period, stock goes to \\(\\$52\\) (up) or \\(\\$32\\) (down). Risk-free rate \\(= 5\\%\\). Find the replicating portfolio delta (shares of stock per option).",
                steps: [
                    { explanation: "Identify the variables:", calculation: "\\(S = \\$40\\), \\(K = \\$40\\), \\(S_u = \\$52\\), \\(S_d = \\$32\\), \\(r_f = 5\\%\\)" },
                    { explanation: "Calculate the call payoffs in each state:", calculation: "\\(C_u = \\max(52 - 40, 0) = \\$12\\), \\(C_d = \\max(32 - 40, 0) = \\$0\\)" },
                    { explanation: "Write the delta formula:", calculation: "\\(\\Delta = \\frac{C_u - C_d}{S_u - S_d}\\)" },
                    { explanation: "Plug in values:", calculation: "\\(\\Delta = \\frac{12 - 0}{52 - 32} = \\frac{12}{20} = 0.6\\)" }
                ],
                answer: "0.6"
            },
            "opt_009": {
                problem: "Using the binomial model (\\(S = \\$40\\), \\(K = \\$40\\), \\(S_u = \\$52\\), \\(S_d = \\$32\\), \\(r_f = 5\\%\\), \\(\\Delta = 0.6\\)), what is the call option price?",
                steps: [
                    { explanation: "We already know \\(\\Delta = 0.6\\). Now find B (borrowing amount):", calculation: "\\(B = \\frac{C_d - S_d \\times \\Delta}{1 + r_f}\\)" },
                    { explanation: "Plug in values:", calculation: "\\(B = \\frac{0 - 32 \\times 0.6}{1.05} = \\frac{-19.2}{1.05} = -\\$18.2857\\)" },
                    { explanation: "Calculate the option price using the replicating portfolio:", calculation: "\\(C = \\Delta \\times S + B\\)" },
                    { explanation: "Plug in values:", calculation: "\\(C = 0.6 \\times 40 + (-18.2857) = 24 - 18.2857 = \\$5.71\\)" }
                ],
                answer: "$5.71"
            },
            "opt_010": {
                problem: "Which of the following best explains why a call option on a non-dividend-paying stock has a European value equal to its American value? (1) Call options are always in the money (2) The insurance value (put + discount on strike) makes holding more valuable than exercising early (3) American options cannot be exercised early (4) Stock prices are always increasing",
                steps: [
                    { explanation: "Consider what happens if you exercise a call early:", calculation: "You pay \\(K\\) today and receive the stock." },
                    { explanation: "Compare to holding the option:", calculation: "By holding, you keep \\(PV(K)\\) invested at the risk-free rate, saving \\(K - PV(K)\\) in interest." },
                    { explanation: "Apply put-call parity:", calculation: "\\(C = P + [S - PV(K)]\\). Both \\(P > 0\\) and \\(S - PV(K) > 0\\) (since \\(PV(K) < K\\))." },
                    { explanation: "The time value = P + discount on strike is always positive:", calculation: "So the option alive is always worth more than exercising immediately." },
                    { explanation: "Correct answer:", calculation: "Option 2: The insurance value (put + discount on strike) makes holding more valuable." }
                ],
                answer: "Option 2"
            }
        };

        // Problems data embedded directly to avoid CORS issues
        let problems = [
            {
                "id": "opt_001",
                "topic": "Call Option Payoff",
                "difficulty": "easy",
                "problem_text": "You hold a call option with strike price \\(K = \\$25\\). At expiration, the stock price is \\(\\$32\\). What is your payoff?",
                "given": {"strike_price": 25, "stock_price": 32},
                "formula": "\\(\\text{Call Payoff} = \\max(S_T - K, 0)\\)",
                "solution_steps": [
                    "Step 1: Identify variables: \\(K = \\$25\\), \\(S_T = \\$32\\)",
                    "Step 2: Apply the call payoff formula: \\(\\text{Payoff} = \\max(S_T - K, 0)\\)",
                    "Step 3: \\(\\text{Payoff} = \\max(32 - 25, 0)\\)",
                    "Step 4: \\(\\text{Payoff} = \\max(7, 0)\\)",
                    "Step 5: Final answer: \\(\\text{Payoff} = \\$7\\)"
                ],
                "correct_answer": 7,
                "tolerance": 0.01,
                "unit": "dollars",
                "hints": {
                    "level_1": "A call option gives you the right to BUY at the strike price. You profit when the stock price exceeds the strike.",
                    "level_2": "The formula is: \\(\\text{Call Payoff} = \\max(S_T - K, 0)\\). Plug in \\(S_T = \\$32\\) and \\(K = \\$25\\).",
                    "level_3": "\\(\\max(32-25, 0) = \\max(7, 0) = \\$7\\)"
                }
            },
            {
                "id": "opt_002",
                "topic": "Call Option Payoff (Out of the Money)",
                "difficulty": "easy",
                "problem_text": "You hold a call option with strike price \\(K = \\$25\\). At expiration, the stock price is \\(\\$18\\). What is your payoff?",
                "given": {"strike_price": 25, "stock_price": 18},
                "formula": "\\(\\text{Call Payoff} = \\max(S_T - K, 0)\\)",
                "solution_steps": [
                    "Step 1: Identify variables: \\(K = \\$25\\), \\(S_T = \\$18\\)",
                    "Step 2: Apply the call payoff formula: \\(\\text{Payoff} = \\max(S_T - K, 0)\\)",
                    "Step 3: \\(\\text{Payoff} = \\max(18 - 25, 0)\\)",
                    "Step 4: \\(\\text{Payoff} = \\max(-7, 0)\\)",
                    "Step 5: Final answer: \\(\\text{Payoff} = \\$0\\) (the option expires worthless)"
                ],
                "correct_answer": 0,
                "tolerance": 0.01,
                "unit": "dollars",
                "hints": {
                    "level_1": "Would you exercise the right to buy a stock at \\(\\$25\\) when it's only worth \\(\\$18\\)?",
                    "level_2": "\\(\\text{Call Payoff} = \\max(S_T - K, 0)\\). Since \\(S_T < K\\), the max function returns 0.",
                    "level_3": "\\(\\max(18-25, 0) = \\max(-7, 0) = \\$0\\)"
                }
            },
            {
                "id": "opt_003",
                "topic": "Put Option Payoff",
                "difficulty": "easy",
                "problem_text": "You hold a put option with strike price \\(K = \\$25\\). At expiration, the stock price is \\(\\$18\\). What is your payoff?",
                "given": {"strike_price": 25, "stock_price": 18},
                "formula": "\\(\\text{Put Payoff} = \\max(K - S_T, 0)\\)",
                "solution_steps": [
                    "Step 1: Identify variables: \\(K = \\$25\\), \\(S_T = \\$18\\)",
                    "Step 2: Apply the put payoff formula: \\(\\text{Payoff} = \\max(K - S_T, 0)\\)",
                    "Step 3: \\(\\text{Payoff} = \\max(25 - 18, 0)\\)",
                    "Step 4: \\(\\text{Payoff} = \\max(7, 0)\\)",
                    "Step 5: Final answer: \\(\\text{Payoff} = \\$7\\)"
                ],
                "correct_answer": 7,
                "tolerance": 0.01,
                "unit": "dollars",
                "hints": {
                    "level_1": "A put option gives you the right to SELL at the strike price. You profit when the stock price is below the strike.",
                    "level_2": "The formula is: \\(\\text{Put Payoff} = \\max(K - S_T, 0)\\). Plug in \\(K = \\$25\\) and \\(S_T = \\$18\\).",
                    "level_3": "\\(\\max(25-18, 0) = \\max(7, 0) = \\$7\\)"
                }
            },
            {
                "id": "opt_004",
                "topic": "Put Option Payoff (Out of the Money)",
                "difficulty": "medium",
                "problem_text": "You hold a put option with strike price \\(K = \\$25\\). At expiration, the stock price is \\(\\$30\\). What is your payoff?",
                "given": {"strike_price": 25, "stock_price": 30},
                "formula": "\\(\\text{Put Payoff} = \\max(K - S_T, 0)\\)",
                "solution_steps": [
                    "Step 1: Identify variables: \\(K = \\$25\\), \\(S_T = \\$30\\)",
                    "Step 2: Apply the put payoff formula: \\(\\text{Payoff} = \\max(K - S_T, 0)\\)",
                    "Step 3: \\(\\text{Payoff} = \\max(25 - 30, 0)\\)",
                    "Step 4: \\(\\text{Payoff} = \\max(-5, 0)\\)",
                    "Step 5: Final answer: \\(\\text{Payoff} = \\$0\\) (the put expires worthless)"
                ],
                "correct_answer": 0,
                "tolerance": 0.01,
                "unit": "dollars",
                "hints": {
                    "level_1": "Would you exercise the right to sell a stock at \\(\\$25\\) when it's worth \\(\\$30\\) in the market?",
                    "level_2": "\\(\\text{Put Payoff} = \\max(K - S_T, 0)\\). Since \\(K < S_T\\), the max function returns 0.",
                    "level_3": "\\(\\max(25-30, 0) = \\max(-5, 0) = \\$0\\)"
                }
            },
            {
                "id": "opt_005",
                "topic": "Short Call Payoff",
                "difficulty": "medium",
                "problem_text": "You wrote (sold) a call option with strike price \\(K = \\$25\\). At expiration, the stock price is \\(\\$32\\). What is your payoff?",
                "given": {"strike_price": 25, "stock_price": 32},
                "formula": "\\(\\text{Short Call Payoff} = -\\max(S_T - K, 0)\\)",
                "solution_steps": [
                    "Step 1: Identify variables: \\(K = \\$25\\), \\(S_T = \\$32\\)",
                    "Step 2: As the writer, your payoff is the negative of the buyer's payoff",
                    "Step 3: Buyer's payoff \\(= \\max(32 - 25, 0) = \\max(7, 0) = \\$7\\)",
                    "Step 4: Your payoff \\(= -\\$7\\)",
                    "Step 5: Final answer: \\(\\text{Payoff} = -\\$7\\) (you lose \\(\\$7\\))"
                ],
                "correct_answer": -7,
                "tolerance": 0.01,
                "unit": "dollars",
                "hints": {
                    "level_1": "When you WRITE (sell) an option, your payoff is the exact opposite of the holder's payoff.",
                    "level_2": "\\(\\text{Short Call Payoff} = -\\max(S_T - K, 0)\\). The holder gains \\(\\$7\\), so you lose \\(\\$7\\).",
                    "level_3": "\\(-\\max(32-25, 0) = -\\max(7, 0) = -\\$7\\)"
                }
            },
            {
                "id": "opt_006",
                "topic": "Call Option Profit with Financing",
                "difficulty": "hard",
                "problem_text": "You bought a call option with strike \\(K = \\$25\\) for \\(\\$3.00\\), financing by borrowing at 3% annual rate. The option expires in 90 days. If the stock price at expiration is \\(\\$32\\), what is your profit?",
                "given": {"strike_price": 25, "premium": 3.00, "rate": 0.03, "days": 90, "stock_price": 32},
                "formula": "\\(\\text{Profit} = \\max(S_T - K, 0) - \\text{Premium} \\times (1+r)^{T/365}\\)",
                "solution_steps": [
                    "Step 1: Identify variables: \\(K = \\$25\\), \\(\\text{Premium} = \\$3.00\\), \\(r = 3\\%\\), \\(T = 90\\) days, \\(S_T = \\$32\\)",
                    "Step 2: Calculate the future value of the premium (cost of financing):",
                    "\\(FV(\\text{Premium}) = 3.00 \\times (1.03)^{90/365} = 3.00 \\times (1.03)^{0.24658}\\)",
                    "Step 3: \\((1.03)^{0.24658} = 1.00731\\)",
                    "Step 4: \\(FV(\\text{Premium}) = 3.00 \\times 1.00731 = \\$3.0219\\)",
                    "Step 5: Option payoff \\(= \\max(32 - 25, 0) = \\$7.00\\)",
                    "Step 6: \\(\\text{Profit} = 7.00 - 3.0219 = \\$3.98\\)"
                ],
                "correct_answer": 3.98,
                "tolerance": 0.05,
                "unit": "dollars",
                "hints": {
                    "level_1": "Profit = Option payoff at expiration minus the future value of the premium you paid.",
                    "level_2": "\\(FV(\\text{Premium}) = 3.00 \\times (1.03)^{90/365}\\). Then \\(\\text{Profit} = \\max(32-25, 0) - FV(\\text{Premium})\\).",
                    "level_3": "\\(FV(\\text{Premium}) = 3.00 \\times 1.00731 = \\$3.022\\). \\(\\text{Profit} = 7.00 - 3.022 = \\$3.98\\)"
                }
            },
            {
                "id": "opt_007",
                "topic": "Put-Call Parity",
                "difficulty": "hard",
                "problem_text": "Stock price \\(S = \\$100\\), call price \\(C = \\$8.00\\) with strike \\(K = \\$105\\), risk-free rate 3% per year, expiration in 90 days. Using put-call parity \\(P = PV(K) + C - S\\), what is the put price?",
                "given": {"stock_price": 100, "call_price": 8.00, "strike_price": 105, "rate": 0.03, "days": 90},
                "formula": "\\(P = PV(K) + C - S\\), where \\(PV(K) = \\frac{K}{(1+r)^{T/365}}\\)",
                "solution_steps": [
                    "Step 1: Identify variables: \\(S = \\$100\\), \\(C = \\$8.00\\), \\(K = \\$105\\), \\(r = 3\\%\\), \\(T = 90\\) days",
                    "Step 2: Calculate \\(PV(K) = \\frac{105}{(1.03)^{90/365}}\\)",
                    "Step 3: \\((1.03)^{90/365} = (1.03)^{0.24658} = 1.00731\\)",
                    "Step 4: \\(PV(K) = \\frac{105}{1.00731} = \\$104.24\\)",
                    "Step 5: Apply put-call parity: \\(P = PV(K) + C - S\\)",
                    "Step 6: \\(P = 104.24 + 8.00 - 100\\)",
                    "Step 7: Final answer: \\(P = \\$12.24\\)"
                ],
                "correct_answer": 12.24,
                "tolerance": 0.5,
                "unit": "dollars",
                "hints": {
                    "level_1": "Put-call parity: \\(P = PV(K) + C - S\\). First find the present value of the strike.",
                    "level_2": "\\(PV(K) = \\frac{105}{(1.03)^{90/365}}\\). Then \\(P = PV(K) + 8.00 - 100\\).",
                    "level_3": "\\(PV(K) = \\frac{105}{1.00731} = \\$104.24\\). \\(P = 104.24 + 8.00 - 100 = \\$12.24\\)"
                }
            },
            {
                "id": "opt_008",
                "topic": "Binomial Model - Delta",
                "difficulty": "hard",
                "problem_text": "Binomial model: Stock price \\(= \\$40\\), strike \\(= \\$40\\). In one period, stock goes to \\(\\$50\\) (up) or \\(\\$30\\) (down). Risk-free rate \\(= 5\\%\\). Find the replicating portfolio delta (shares of stock to hold per call option).",
                "given": {"stock_price": 40, "strike_price": 40, "stock_up": 50, "stock_down": 30, "rate": 0.05},
                "formula": "\\(\\Delta = \\frac{C_u - C_d}{S_u - S_d}\\)",
                "solution_steps": [
                    "Step 1: Identify variables: \\(S = \\$40\\), \\(K = \\$40\\), \\(S_u = \\$50\\), \\(S_d = \\$30\\), \\(r_f = 5\\%\\)",
                    "Step 2: Calculate call payoffs in each state:",
                    "\\(C_u = \\max(50 - 40, 0) = \\$10\\)",
                    "\\(C_d = \\max(30 - 40, 0) = \\$0\\)",
                    "Step 3: Apply the delta formula: \\(\\Delta = \\frac{C_u - C_d}{S_u - S_d}\\)",
                    "Step 4: \\(\\Delta = \\frac{10 - 0}{50 - 30} = \\frac{10}{20}\\)",
                    "Step 5: Final answer: \\(\\Delta = 0.5\\)"
                ],
                "correct_answer": 0.5,
                "tolerance": 0.01,
                "unit": "decimal",
                "hints": {
                    "level_1": "Delta tells you how many shares to hold to replicate the option. It uses the spread in option values divided by the spread in stock prices.",
                    "level_2": "First find \\(C_u = \\max(50-40,0)\\) and \\(C_d = \\max(30-40,0)\\). Then \\(\\Delta = \\frac{C_u - C_d}{S_u - S_d}\\).",
                    "level_3": "\\(C_u = \\$10\\), \\(C_d = \\$0\\). \\(\\Delta = \\frac{10 - 0}{50 - 30} = \\frac{10}{20} = 0.5\\)"
                }
            },
            {
                "id": "opt_009",
                "topic": "Binomial Model - Option Price",
                "difficulty": "hard",
                "problem_text": "Using the binomial model (\\(S = \\$40\\), \\(K = \\$40\\), \\(S_u = \\$50\\), \\(S_d = \\$30\\), \\(r_f = 5\\%\\), \\(\\Delta = 0.5\\)), what is the call option price?",
                "given": {"stock_price": 40, "strike_price": 40, "stock_up": 50, "stock_down": 30, "rate": 0.05, "delta": 0.5},
                "formula": "\\(C = \\Delta \\times S + B\\), where \\(B = \\frac{C_d - S_d \\times \\Delta}{1 + r_f}\\)",
                "solution_steps": [
                    "Step 1: Identify variables: \\(S = \\$40\\), \\(K = \\$40\\), \\(S_u = \\$50\\), \\(S_d = \\$30\\), \\(r_f = 5\\%\\), \\(\\Delta = 0.5\\)",
                    "Step 2: \\(C_u = \\max(50-40,0) = \\$10\\), \\(C_d = \\max(30-40,0) = \\$0\\)",
                    "Step 3: Calculate B (borrowing): \\(B = \\frac{C_d - S_d \\times \\Delta}{1 + r_f}\\)",
                    "Step 4: \\(B = \\frac{0 - 30 \\times 0.5}{1.05} = \\frac{-15}{1.05} = -\\$14.2857\\)",
                    "Step 5: Calculate option price: \\(C = \\Delta \\times S + B\\)",
                    "Step 6: \\(C = 0.5 \\times 40 + (-14.2857) = 20 - 14.2857\\)",
                    "Step 7: Final answer: \\(C = \\$5.71\\)"
                ],
                "correct_answer": 5.71,
                "tolerance": 0.1,
                "unit": "dollars",
                "hints": {
                    "level_1": "The option price equals the cost of the replicating portfolio: \\(\\Delta\\) shares of stock plus borrowing \\(B\\).",
                    "level_2": "\\(B = \\frac{C_d - S_d \\times \\Delta}{1 + r_f} = \\frac{0 - 30 \\times 0.5}{1.05}\\). Then \\(C = \\Delta \\times S + B\\).",
                    "level_3": "\\(B = \\frac{-15}{1.05} = -\\$14.29\\). \\(C = 0.5 \\times 40 + (-14.29) = 20 - 14.29 = \\$5.71\\)"
                }
            },
            {
                "id": "opt_010",
                "topic": "Early Exercise and Put-Call Parity",
                "difficulty": "medium",
                "problem_text": "According to put-call parity, it is never optimal to exercise early a call option on a non-dividend-paying stock because:\n\n(1) Call options always expire worthless\n(2) The time value (put price + discount on strike) is always positive\n(3) Early exercise is illegal for American options\n(4) The stock price always goes up",
                "given": {},
                "formula": "\\(C = P + S - PV(K)\\). Time value \\(= P + (K - PV(K)) > 0\\)",
                "solution_steps": [
                    "Step 1: From put-call parity: \\(C = P + S - PV(K)\\)",
                    "Step 2: The intrinsic value of a call is \\(\\max(S - K, 0)\\)",
                    "Step 3: The time value \\(= C - \\text{intrinsic value} = P + (K - PV(K))\\)",
                    "Step 4: \\(P \\geq 0\\) always (options can't have negative value)",
                    "Step 5: \\(K - PV(K) > 0\\) because \\(PV(K) < K\\) when \\(r > 0\\) (money has time value)",
                    "Step 6: Therefore the time value is always positive - the option alive is worth more than exercising",
                    "Step 7: Correct answer: Option 2"
                ],
                "correct_answer": 2,
                "tolerance": 0.01,
                "unit": "choice",
                "hints": {
                    "level_1": "Think about what you give up by exercising early. Consider put-call parity: \\(C = P + S - PV(K)\\).",
                    "level_2": "The time value of a call \\(= P + (K - PV(K))\\). Since puts have non-negative value and \\(PV(K) < K\\)...",
                    "level_3": "Both \\(P \\geq 0\\) and \\(K - PV(K) > 0\\), so the time value is always positive. You always lose value by exercising early. Answer: 2"
                }
            }
        ];

        let currentProblemIndex = 0;
        let attemptCount = 0;
        let completedProblems = new Set();

        // Spaced repetition tracking
        const TOPIC_KEY = 'options'; // Unique key for this topic
        const MISSED_PROBLEMS_KEY = 'finance_missed_options';
        const MASTERED_PROBLEMS_KEY = 'finance_mastered_options';

        // Check if we're in review mode (URL parameter)
        const urlParams = new URLSearchParams(window.location.search);
        const reviewMode = urlParams.get('review') === 'true';

        function getMissedProblems() {
            const stored = localStorage.getItem(MISSED_PROBLEMS_KEY);
            return stored ? JSON.parse(stored) : {};
        }

        function getMasteredProblems() {
            const stored = localStorage.getItem(MASTERED_PROBLEMS_KEY);
            return stored ? JSON.parse(stored) : {};
        }

        function saveMissedProblem(problemId) {
            const missed = getMissedProblems();
            missed[problemId] = {
                count: (missed[problemId]?.count || 0) + 1,
                lastMissed: new Date().toISOString()
            };
            localStorage.setItem(MISSED_PROBLEMS_KEY, JSON.stringify(missed));
        }

        function markProblemMastered(problemId) {
            // Remove from missed
            const missed = getMissedProblems();
            delete missed[problemId];
            localStorage.setItem(MISSED_PROBLEMS_KEY, JSON.stringify(missed));

            // Add to mastered
            const mastered = getMasteredProblems();
            mastered[problemId] = {
                masteredOn: new Date().toISOString()
            };
            localStorage.setItem(MASTERED_PROBLEMS_KEY, JSON.stringify(mastered));
        }

        function filterProblemsForReview() {
            if (!reviewMode) return problems;

            const missed = getMissedProblems();
            const missedIds = Object.keys(missed);

            if (missedIds.length === 0) {
                return []; // No problems to review
            }

            return problems.filter(p => missedIds.includes(p.id));
        }

        // Load problems on page load
        function loadProblems() {
            // Filter problems if in review mode
            if (reviewMode) {
                const reviewProblems = filterProblemsForReview();
                if (reviewProblems.length === 0) {
                    showNoProblemsToReview();
                    return;
                }
                problems = reviewProblems;
                // Update header to show review mode
                document.querySelector('h1').textContent = 'Options - Review';
                document.querySelector('.subtitle').textContent = 'Reviewing missed problems';
            }
            displayProblem();
        }

        function showNoProblemsToReview() {
            const problemCard = document.getElementById('problemCard');
            problemCard.innerHTML = `
                <div style="text-align: center; padding: 3rem;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">üéâ</div>
                    <h2 style="font-size: 1.75rem; margin-bottom: 1rem; color: #2D3748;">No Problems to Review!</h2>
                    <p style="font-size: 1.1rem; color: #4A5568; margin-bottom: 2rem;">
                        You've mastered all the problems you previously missed. Great work!
                    </p>
                    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                        <a href="week9-options.html" class="btn-primary" style="text-decoration: none; display: inline-block; padding: 0.75rem 2rem;">Practice All Problems</a>
                        <a href="index.html" class="btn-secondary" style="text-decoration: none; display: inline-block; padding: 0.75rem 2rem;">Back to Topics</a>
                    </div>
                </div>
            `;
        }

        // Toggle worked example visibility
        function toggleWorkedExample() {
            const toggle = document.getElementById('workedExampleToggle');
            const toggleText = document.getElementById('toggleText');
            toggle.classList.toggle('expanded');
            toggleText.textContent = toggle.classList.contains('expanded') ? 'Hide' : 'Show';
        }

        // Populate worked example content
        function displayWorkedExample(problemId) {
            const example = workedExamples[problemId];
            const container = document.getElementById('workedExampleContent');
            const toggle = document.getElementById('workedExampleToggle');

            // Reset to collapsed state
            toggle.classList.remove('expanded');
            document.getElementById('toggleText').textContent = 'Show';

            if (!example) {
                toggle.style.display = 'none';
                return;
            }

            toggle.style.display = 'block';

            let stepsHtml = example.steps.map((step, index) => `
                <div class="example-step">
                    <span class="example-step-number">${index + 1}</span>
                    <div class="example-step-content">
                        <div class="example-step-explanation">${step.explanation}</div>
                        <div class="example-step-calculation">${step.calculation}</div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = `
                <div class="example-problem">
                    <div class="example-label">Example Problem</div>
                    <div class="example-text">${example.problem}</div>
                </div>
                <div class="example-solution">
                    <div class="example-label">Step-by-Step Solution</div>
                    ${stepsHtml}
                    <div class="example-final-answer">
                        <div class="example-final-answer-label">Final Answer</div>
                        <div class="example-final-answer-value">${example.answer}</div>
                    </div>
                </div>
            `;
        }

        function displayProblem() {
            if (problems.length === 0) return;

            const problem = problems[currentProblemIndex];
            attemptCount = 0;

            // Update progress
            const progress = ((currentProblemIndex) / problems.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressText').textContent =
                `Problem ${currentProblemIndex + 1} of ${problems.length}`;

            // Update difficulty badge
            const difficultyBadge = document.getElementById('difficultyBadge');
            difficultyBadge.textContent = problem.difficulty.charAt(0).toUpperCase() + problem.difficulty.slice(1);
            difficultyBadge.className = 'badge badge-' + problem.difficulty;

            // Update topic badge
            document.getElementById('topicBadge').textContent = problem.topic;

            // Display worked example for this problem
            displayWorkedExample(problem.id);

            // Update problem text
            document.getElementById('problemText').textContent = problem.problem_text;

            // Update formula (but keep it hidden initially)
            document.getElementById('formulaText').textContent = problem.formula;
            document.getElementById('formulaBox').classList.add('hidden');

            // Clear answer input and feedback
            document.getElementById('answerInput').value = '';
            document.getElementById('feedbackBox').className = 'hidden';
            document.getElementById('submitBtn').disabled = false;

            // Render LaTeX
            renderMath();

            // Update navigation buttons
            document.getElementById('prevBtn').disabled = currentProblemIndex === 0;
            document.getElementById('nextBtn').textContent =
                currentProblemIndex === problems.length - 1 ? 'Finish' : 'Next Problem';
        }

        function checkAnswer() {
            const problem = problems[currentProblemIndex];
            const userAnswer = parseFloat(document.getElementById('answerInput').value);

            if (isNaN(userAnswer)) {
                showFeedback('Please enter a valid number', 'incorrect');
                return;
            }

            // Smart tolerance: allow for rounding errors from intermediate calculations
            // Use 0.5% of the correct answer or $1, whichever is larger
            // This handles cases where students round intermediate steps
            const percentTolerance = Math.abs(problem.correct_answer) * 0.005; // 0.5%
            const minTolerance = problem.unit === 'percent' ? 0.05 : 1; // For percentages, use 0.05
            const calculatedTolerance = Math.max(percentTolerance, minTolerance);

            // Use problem-specific tolerance if provided, otherwise use calculated tolerance
            const tolerance = problem.tolerance !== undefined ? problem.tolerance : calculatedTolerance;

            const isCorrect = Math.abs(userAnswer - problem.correct_answer) <= tolerance;

            attemptCount++;

            if (isCorrect) {
                completedProblems.add(currentProblemIndex);
                // If correct on first attempt, mark as mastered
                if (attemptCount === 1) {
                    markProblemMastered(problem.id);
                }
                showCorrectFeedback();
            } else {
                // Track this as a missed problem
                saveMissedProblem(problem.id);
                showIncorrectFeedback();
            }
        }

        function showCorrectFeedback() {
            const problem = problems[currentProblemIndex];
            const feedbackBox = document.getElementById('feedbackBox');

            let html = `
                <div class="feedback-title">
                    Correct!
                </div>
                <div class="feedback-content">
                    Great job! The correct answer is ${formatAnswer(problem.correct_answer, problem.unit || 'dollars')}.
                </div>
            `;

            feedbackBox.className = 'feedback-box feedback-correct';
            feedbackBox.innerHTML = html;

            document.getElementById('submitBtn').disabled = true;
            renderMath();
        }

        function showIncorrectFeedback() {
            const problem = problems[currentProblemIndex];
            const feedbackBox = document.getElementById('feedbackBox');

            let html = `
                <div class="feedback-title">
                    Not quite right
                </div>
            `;

            // Adaptive feedback based on attempt count
            if (attemptCount === 1) {
                html += `
                    <div class="hint-box">
                        <strong>Hint:</strong> ${problem.hints.level_1}
                    </div>
                `;
            } else if (attemptCount === 2) {
                // Show formula on second attempt
                document.getElementById('formulaBox').classList.remove('hidden');
                html += `
                    <div class="hint-box">
                        <strong>Formula revealed above.</strong> ${problem.hints.level_2}
                    </div>
                `;
            } else if (attemptCount === 3) {
                // Keep formula visible
                document.getElementById('formulaBox').classList.remove('hidden');
                html += `
                    <div class="hint-box">
                        <strong>Detailed hint:</strong> ${problem.hints.level_3}
                    </div>
                    <div style="margin-top: 1rem;">
                        <button class="btn-secondary" onclick="showFullSolution()">Show Full Solution</button>
                    </div>
                `;
            } else {
                // After 3 attempts, show full solution automatically
                showFullSolution();
                return;
            }

            feedbackBox.className = 'feedback-box feedback-incorrect';
            feedbackBox.innerHTML = html;
            renderMath();
        }

        function showFullSolution() {
            const problem = problems[currentProblemIndex];
            const feedbackBox = document.getElementById('feedbackBox');

            let html = `
                <div class="feedback-title">
                    Solution
                </div>
                <div class="solution-steps">
            `;

            problem.solution_steps.forEach((step, index) => {
                html += `
                    <div class="solution-step">
                        <span class="step-number">Step ${index + 1}:</span> ${step}
                    </div>
                `;
            });

            html += `
                </div>
                <div class="feedback-content" style="margin-top: 1rem; padding-top: 1rem; border-top: 2px solid #E2E8F0;">
                    <strong>Final Answer:</strong> ${formatAnswer(problem.correct_answer, problem.unit || 'dollars')}
                </div>
            `;

            feedbackBox.className = 'feedback-box feedback-correct';
            feedbackBox.innerHTML = html;

            document.getElementById('submitBtn').disabled = true;
            renderMath();
        }

        function nextProblem() {
            if (currentProblemIndex < problems.length - 1) {
                currentProblemIndex++;
                displayProblem();
            } else {
                showSummary();
            }
        }

        function previousProblem() {
            if (currentProblemIndex > 0) {
                currentProblemIndex--;
                displayProblem();
            }
        }

        function showSummary() {
            const problemCard = document.getElementById('problemCard');
            const completed = completedProblems.size;
            const total = problems.length;
            const percentage = Math.round((completed / total) * 100);

            // Check how many problems are in the missed queue
            const missed = getMissedProblems();
            const missedCount = Object.keys(missed).length;

            let reviewButton = '';
            if (missedCount > 0 && !reviewMode) {
                reviewButton = `
                    <a href="week9-options.html?review=true" class="btn-primary" style="text-decoration: none; display: inline-block; background-color: #DD6B20;">
                        Review ${missedCount} Missed Problem${missedCount > 1 ? 's' : ''}
                    </a>
                `;
            }

            let celebrationMessage = '';
            if (reviewMode && completed === total) {
                celebrationMessage = `
                    <div style="background-color: #C6F6D5; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        <strong>Excellent!</strong> You've mastered these previously missed problems!
                    </div>
                `;
            }

            problemCard.innerHTML = `
                <div style="text-align: center; padding: 3rem;">
                    <h2 style="font-size: 2rem; margin-bottom: 1rem;">${reviewMode ? 'Review Session Complete!' : 'Practice Session Complete!'}</h2>
                    ${celebrationMessage}
                    <div style="font-size: 3rem; font-weight: bold; color: #2C5282; margin: 2rem 0;">
                        ${completed} / ${total}
                    </div>
                    <div style="font-size: 1.25rem; color: #4A5568; margin-bottom: 2rem;">
                        You got ${percentage}% of problems correct on the first try!
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                        ${reviewButton}
                        <button class="btn-primary" onclick="location.href='week9-options.html'">Practice All</button>
                        <a href="index.html" class="btn-secondary" style="text-decoration: none; display: inline-block;">Back to Topics</a>
                    </div>
                </div>
            `;
        }

        function renderMath() {
            setTimeout(() => {
                if (typeof renderMathInElement === 'function') {
                    renderMathInElement(document.body, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '\\(', right: '\\)', display: false}
                        ],
                        throwOnError: false
                    });
                }
            }, 100);
        }

        // Allow Enter key to submit
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('answerInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !document.getElementById('submitBtn').disabled) {
                    checkAnswer();
                }
            });
            loadProblems();
        });
    </script>
</body>
</html>
