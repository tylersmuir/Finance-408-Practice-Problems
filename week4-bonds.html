<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Practice Tool - Bond Valuation</title>

    <!-- KaTeX for LaTeX rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #ffffff;
            color: #1a1a1a;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            background-color: #2C5282;
            color: white;
            padding: 2rem;
            margin-bottom: 2rem;
            border-radius: 8px;
        }

        .header-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .back-link {
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .back-link:hover {
            color: white;
        }

        h1 {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }

        .progress-bar {
            background-color: #E2E8F0;
            height: 8px;
            border-radius: 4px;
            margin: 1.5rem 0;
            overflow: hidden;
        }

        .progress-fill {
            background-color: #48BB78;
            height: 100%;
            transition: width 0.3s ease;
        }

        .problem-card {
            background: white;
            border: 2px solid #E2E8F0;
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .problem-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #E2E8F0;
        }

        .problem-meta {
            display: flex;
            gap: 1rem;
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .badge-easy { background-color: #C6F6D5; color: #22543D; }
        .badge-medium { background-color: #FEF3C7; color: #78350F; }
        .badge-hard { background-color: #FED7D7; color: #742A2A; }

        .problem-number {
            font-size: 0.875rem;
            color: #718096;
            font-weight: 500;
        }

        .problem-text {
            font-size: 1.125rem;
            line-height: 1.8;
            margin-bottom: 2rem;
            color: #2D3748;
        }

        .formula-box {
            background-color: #F7FAFC;
            border-left: 4px solid #2C5282;
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            border-radius: 4px;
        }

        .formula-label {
            font-size: 0.875rem;
            color: #4A5568;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .answer-section {
            margin: 2rem 0;
        }

        .input-group {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        label {
            font-weight: 500;
            color: #2D3748;
        }

        input[type="number"] {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 2px solid #CBD5E0;
            border-radius: 6px;
            font-size: 1.125rem;
            transition: border-color 0.2s;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #2C5282;
        }

        button {
            padding: 0.75rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: #2C5282;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2A4365;
        }

        .btn-primary:disabled {
            background-color: #CBD5E0;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: #E2E8F0;
            color: #2D3748;
        }

        .btn-secondary:hover {
            background-color: #CBD5E0;
        }

        .feedback-box {
            margin-top: 1.5rem;
            padding: 1.5rem;
            border-radius: 8px;
            border: 2px solid;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .feedback-correct {
            background-color: #F0FFF4;
            border-color: #48BB78;
            color: #22543D;
        }

        .feedback-incorrect {
            background-color: #FFF5F5;
            border-color: #F56565;
            color: #742A2A;
        }

        .feedback-title {
            font-weight: 600;
            font-size: 1.125rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .feedback-content {
            margin-top: 1rem;
            line-height: 1.8;
        }

        .hint-box {
            background-color: #EBF8FF;
            border-left: 4px solid #3182CE;
            padding: 1rem 1.5rem;
            margin-top: 1rem;
            border-radius: 4px;
        }

        .solution-steps {
            margin-top: 1rem;
        }

        .solution-step {
            padding: 0.75rem 0;
            border-bottom: 1px solid #E2E8F0;
        }

        .solution-step:last-child {
            border-bottom: none;
        }

        .step-number {
            font-weight: 600;
            color: #2C5282;
        }

        .navigation {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .navigation button {
            flex: 1;
        }

        .hidden {
            display: none;
        }

        /* Calculator Styles */
        .calculator-toolbar {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .calculator-toggle-btn {
            background-color: #2C5282;
            color: white;
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 50px;
            font-size: 1.125rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .calculator-toggle-btn:hover {
            background-color: #2A4365;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }

        .calculator-container {
            position: absolute;
            bottom: 70px;
            right: 0;
            width: 320px;
            background-color: #F7FAFC;
            border: 2px solid #E2E8F0;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            padding: 1rem;
            display: none;
        }

        .calculator-container.active {
            display: block;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .calculator-display {
            background-color: #2D3748;
            color: #48BB78;
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            font-family: 'Courier New', monospace;
            font-size: 1.25rem;
            text-align: right;
            min-height: 50px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .calculator-expression {
            font-size: 0.875rem;
            color: #CBD5E0;
            margin-bottom: 0.25rem;
        }

        .calculator-result {
            font-size: 1.25rem;
            color: #48BB78;
            font-weight: 600;
        }

        .calculator-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
        }

        .calc-btn {
            padding: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            border: 1px solid #CBD5E0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            background-color: white;
            color: #2D3748;
        }

        .calc-btn:hover {
            background-color: #EDF2F7;
            transform: translateY(-1px);
        }

        .calc-btn:active {
            transform: translateY(0);
        }

        .calc-btn-operator {
            background-color: #2C5282;
            color: white;
            border-color: #2C5282;
        }

        .calc-btn-operator:hover {
            background-color: #2A4365;
        }

        .calc-btn-equals {
            background-color: #48BB78;
            color: white;
            border-color: #48BB78;
        }

        .calc-btn-equals:hover {
            background-color: #38A169;
        }

        .calc-btn-clear {
            background-color: #F56565;
            color: white;
            border-color: #F56565;
        }

        .calc-btn-clear:hover {
            background-color: #E53E3E;
        }


        /* Worked Example Toggle Styles */
        .worked-example-toggle {
            background: linear-gradient(135deg, #EBF8FF 0%, #E6FFFA 100%);
            border: 2px solid #3182CE;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }
        .worked-example-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .worked-example-header:hover { background-color: rgba(49, 130, 206, 0.1); }
        .worked-example-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
            color: #2C5282;
        }
        .worked-example-title .icon { font-size: 1.25rem; }
        .worked-example-subtitle { font-size: 0.85rem; color: #4A5568; font-weight: 400; }
        .toggle-indicator { display: flex; align-items: center; gap: 0.5rem; color: #3182CE; font-size: 0.875rem; font-weight: 500; }
        .toggle-arrow { transition: transform 0.3s ease; font-size: 1.25rem; }
        .worked-example-toggle.expanded .toggle-arrow { transform: rotate(180deg); }
        .worked-example-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease, padding 0.4s ease; background-color: #F7FAFC; }
        .worked-example-toggle.expanded .worked-example-content { max-height: 2000px; padding: 1.5rem; border-top: 1px solid #BEE3F8; }
        .example-problem { background: white; border-radius: 6px; padding: 1.25rem; margin-bottom: 1rem; border-left: 4px solid #3182CE; }
        .example-label { font-size: 0.75rem; font-weight: 600; color: #3182CE; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; }
        .example-text { color: #2D3748; font-size: 0.95rem; line-height: 1.6; }
        .example-solution { background: white; border-radius: 6px; padding: 1.25rem; }
        .example-step { display: flex; gap: 1rem; padding: 0.75rem 0; border-bottom: 1px solid #E2E8F0; }
        .example-step:last-child { border-bottom: none; }
        .example-step-number { background-color: #3182CE; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; flex-shrink: 0; }
        .example-step-content { flex: 1; }
        .example-step-explanation { color: #4A5568; font-size: 0.9rem; margin-bottom: 0.25rem; }
        .example-step-calculation { font-family: 'SF Mono', Monaco, 'Courier New', monospace; background-color: #EDF2F7; padding: 0.5rem 0.75rem; border-radius: 4px; font-size: 0.9rem; color: #2D3748; }
        .example-final-answer { background: linear-gradient(135deg, #48BB78 0%, #38A169 100%); color: white; padding: 1rem; border-radius: 6px; margin-top: 1rem; text-align: center; }
        .example-final-answer-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.9; }
        .example-final-answer-value { font-size: 1.5rem; font-weight: 700; }
        .now-try-badge { background-color: #48BB78; color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.875rem; font-weight: 600; display: inline-flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            h1 {
                font-size: 1.5rem;
            }

            .problem-card {
                padding: 1.5rem;
            }

            .input-group {
                flex-direction: column;
                align-items: stretch;
            }

            .navigation {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-nav">
                <a href="index.html" class="back-link">‚Üê Back to Topics</a>
            </div>
            <h1>Bond Valuation</h1>
            <div class="subtitle">Week 4 - MGMT 408</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: 0%"></div>
            </div>
            <div class="problem-number" id="progressText">Problem 1 of 10</div>
        </header>

        <div class="problem-card" id="problemCard">
            <div class="problem-header">
                <div class="problem-meta">
                    <span class="badge" id="difficultyBadge">Easy</span>
                    <span class="badge" style="background-color: #EBF8FF; color: #2C5282;" id="topicBadge">Topic</span>
                </div>
            </div>

            <!-- Worked Example Toggle -->
            <div class="worked-example-toggle" id="workedExampleToggle">
                <div class="worked-example-header" onclick="toggleWorkedExample()">
                    <div class="worked-example-title">
                        <span class="icon">üìñ</span>
                        <span>
                            See Worked Example
                            <div class="worked-example-subtitle">Similar problem with step-by-step solution</div>
                        </span>
                    </div>
                    <div class="toggle-indicator">
                        <span class="toggle-text" id="toggleText">Show</span>
                        <span class="toggle-arrow">‚ñº</span>
                    </div>
                </div>
                <div class="worked-example-content" id="workedExampleContent"></div>
            </div>

            <div class="now-try-badge">‚úèÔ∏è Now You Try</div>

            <div class="problem-text" id="problemText">
                Loading problem...
            </div>

            <div class="formula-box hidden" id="formulaBox">
                <div class="formula-label">Formula:</div>
                <div id="formulaText"></div>
            </div>

            <div class="answer-section">
                <div class="input-group">
                    <label for="answerInput">Your Answer:</label>
                    <input type="number" id="answerInput" step="0.01" placeholder="Enter your answer">
                    <button class="btn-primary" id="submitBtn" onclick="checkAnswer()">Submit</button>
                </div>
            </div>

            <div id="feedbackBox" class="hidden"></div>

            <div class="navigation">
                <button class="btn-secondary" id="prevBtn" onclick="previousProblem()">Previous</button>
                <button class="btn-secondary" id="nextBtn" onclick="nextProblem()">Next Problem</button>
            </div>
        </div>
    </div>

    <!-- Calculator Toolbar -->
    <div class="calculator-toolbar">
        <button class="calculator-toggle-btn" onclick="toggleCalculator()">
            Calculator
        </button>
        <div class="calculator-container" id="calculatorContainer">
            <div class="calculator-display">
                <div class="calculator-expression" id="calcExpression">&nbsp;</div>
                <div class="calculator-result" id="calcResult">0</div>
            </div>
            <div class="calculator-buttons">
                <button class="calc-btn calc-btn-clear" onclick="calcClear()">AC</button>
                <button class="calc-btn" onclick="calcBackspace()">Del</button>
                <button class="calc-btn calc-btn-operator" onclick="calcAppend('^')">x^y</button>
                <button class="calc-btn calc-btn-operator" onclick="calcAppend('/')">√∑</button>

                <button class="calc-btn" onclick="calcAppend('7')">7</button>
                <button class="calc-btn" onclick="calcAppend('8')">8</button>
                <button class="calc-btn" onclick="calcAppend('9')">9</button>
                <button class="calc-btn calc-btn-operator" onclick="calcAppend('*')">x</button>

                <button class="calc-btn" onclick="calcAppend('4')">4</button>
                <button class="calc-btn" onclick="calcAppend('5')">5</button>
                <button class="calc-btn" onclick="calcAppend('6')">6</button>
                <button class="calc-btn calc-btn-operator" onclick="calcAppend('-')">-</button>

                <button class="calc-btn" onclick="calcAppend('1')">1</button>
                <button class="calc-btn" onclick="calcAppend('2')">2</button>
                <button class="calc-btn" onclick="calcAppend('3')">3</button>
                <button class="calc-btn calc-btn-operator" onclick="calcAppend('+')">+</button>

                <button class="calc-btn" onclick="calcAppend('0')">0</button>
                <button class="calc-btn" onclick="calcAppend('.')">.</button>
                <button class="calc-btn" onclick="calcAppend('(')">(</button>
                <button class="calc-btn" onclick="calcAppend(')')">)</button>

                <button class="calc-btn calc-btn-equals" onclick="calcEquals()" style="grid-column: span 4;">=</button>
            </div>
        </div>
    </div>

    <script>
        // Spaced repetition tracking
        const TOPIC_KEY = 'bonds';
        const MISSED_PROBLEMS_KEY = 'finance_missed_' + TOPIC_KEY;
        const MASTERED_PROBLEMS_KEY = 'finance_mastered_' + TOPIC_KEY;

        // Check if we're in review mode
        const urlParams = new URLSearchParams(window.location.search);
        const reviewMode = urlParams.get('review') === 'true';

        function getMissedProblems() {
            const stored = localStorage.getItem(MISSED_PROBLEMS_KEY);
            return stored ? JSON.parse(stored) : {};
        }

        function getMasteredProblems() {
            const stored = localStorage.getItem(MASTERED_PROBLEMS_KEY);
            return stored ? JSON.parse(stored) : {};
        }

        function saveMissedProblem(problemId) {
            const missed = getMissedProblems();
            missed[problemId] = {
                count: (missed[problemId]?.count || 0) + 1,
                lastMissed: new Date().toISOString()
            };
            localStorage.setItem(MISSED_PROBLEMS_KEY, JSON.stringify(missed));
        }

        function markProblemMastered(problemId) {
            // Remove from missed
            const missed = getMissedProblems();
            delete missed[problemId];
            localStorage.setItem(MISSED_PROBLEMS_KEY, JSON.stringify(missed));

            // Add to mastered
            const mastered = getMasteredProblems();
            mastered[problemId] = { masteredOn: new Date().toISOString() };
            localStorage.setItem(MASTERED_PROBLEMS_KEY, JSON.stringify(mastered));
        }

        function filterProblemsForReview() {
            if (!reviewMode) return problems;

            const missed = getMissedProblems();
            const missedIds = Object.keys(missed);

            if (missedIds.length === 0) return [];

            return problems.filter(p => missedIds.includes(p.id));
        }

        // Calculator state
        let calcCurrentExpression = '';
        let calcCurrentResult = '0';
        let calculatorOpen = false;

        function toggleCalculator() {
            calculatorOpen = !calculatorOpen;
            const container = document.getElementById('calculatorContainer');
            if (calculatorOpen) {
                container.classList.add('active');
            } else {
                container.classList.remove('active');
            }
        }

        function closeCalculator() {
            if (calculatorOpen) {
                calculatorOpen = false;
                document.getElementById('calculatorContainer').classList.remove('active');
            }
        }

        // Close calculator when clicking outside
        document.addEventListener('click', (e) => {
            const toolbar = document.querySelector('.calculator-toolbar');
            const container = document.getElementById('calculatorContainer');

            // If click is outside the calculator toolbar and container, close it
            if (calculatorOpen && !toolbar.contains(e.target)) {
                closeCalculator();
            }
        });

        function calcAppend(value) {
            calcCurrentExpression += value;
            updateCalcDisplay();
        }

        function calcClear() {
            calcCurrentExpression = '';
            calcCurrentResult = '0';
            updateCalcDisplay();
        }

        function calcBackspace() {
            calcCurrentExpression = calcCurrentExpression.slice(0, -1);
            updateCalcDisplay();
        }

        function calcEquals() {
            if (!calcCurrentExpression) return;

            try {
                // Replace ^ with ** for JavaScript exponentiation
                let expression = calcCurrentExpression.replace(/\^/g, '**');

                // Evaluate the expression safely
                let result = Function('"use strict"; return (' + expression + ')')();

                // Round to 4 decimal places to avoid floating point issues
                if (typeof result === 'number') {
                    calcCurrentResult = Number(result.toFixed(4)).toString();
                } else {
                    calcCurrentResult = result.toString();
                }
            } catch (error) {
                calcCurrentResult = 'Error';
            }

            updateCalcDisplay();
        }

        function updateCalcDisplay() {
            document.getElementById('calcExpression').textContent = calcCurrentExpression || '\u00A0';
            document.getElementById('calcResult').textContent = calcCurrentResult;
        }

        // Allow keyboard input for calculator (only when calculator is open)
        document.addEventListener('keydown', (e) => {
            if (document.activeElement.id === 'answerInput') return; // Don't interfere with answer input
            if (!calculatorOpen) return; // Only work when calculator is open

            if (e.key >= '0' && e.key <= '9') {
                calcAppend(e.key);
            } else if (e.key === '.') {
                calcAppend('.');
            } else if (e.key === '+' || e.key === '-' || e.key === '*' || e.key === '/') {
                calcAppend(e.key);
            } else if (e.key === '^') {
                calcAppend('^');
            } else if (e.key === 'Enter' && calcCurrentExpression) {
                calcEquals();
            } else if (e.key === 'Backspace' && calcCurrentExpression) {
                e.preventDefault();
                calcBackspace();
            } else if (e.key === 'Escape') {
                calcClear();
            } else if (e.key === '(' || e.key === ')') {
                calcAppend(e.key);
            }
        });

        // Worked examples for each problem type
        const workedExamples = {
            "bond_001": {
                problem: "A bond has face value $1,000, 8% coupon rate, paid annually. What is the annual coupon payment?",
                steps: [
                    { explanation: "Identify values:", calculation: "Face Value = $1,000, Coupon Rate = 8%, Payments/year = 1" },
                    { explanation: "Apply coupon formula:", calculation: "Coupon = Face Value √ó Coupon Rate" },
                    { explanation: "Calculate:", calculation: "Coupon = $1,000 √ó 0.08 = $80" }
                ],
                answer: "$80"
            },
            "bond_002": {
                problem: "A 3-year bond has face value $100, 5% annual coupon, YTM of 6%. What is the price?",
                steps: [
                    { explanation: "Calculate annual coupon:", calculation: "C = $100 √ó 5% = $5" },
                    { explanation: "Discount each cash flow at 6%:", calculation: "P = $5/1.06 + $5/1.06¬≤ + $105/1.06¬≥" },
                    { explanation: "Calculate each term:", calculation: "$4.72 + $4.45 + $88.17 = $97.33" }
                ],
                answer: "$97.33"
            },
            "bond_003": {
                problem: "A 2-year bond, $100 face, 6% coupon, price $99. Approximate the YTM.",
                steps: [
                    { explanation: "Price below par means YTM > coupon rate:", calculation: "YTM > 6%" },
                    { explanation: "Try 6.5%:", calculation: "P = $6/1.065 + $106/1.065¬≤ = $99.09 (close!)" },
                    { explanation: "Since $99.09 ‚âà $99:", calculation: "YTM ‚âà 6.5%" }
                ],
                answer: "6.5%"
            },
            "bond_004": {
                problem: "Bond has 4% coupon, 5% yield, face $1,000, trades at $980. What is the discount amount?",
                steps: [
                    { explanation: "Compare coupon to yield:", calculation: "4% < 5%, so bond trades at discount" },
                    { explanation: "Calculate discount:", calculation: "Discount = Face Value - Price" },
                    { explanation: "Calculate:", calculation: "Discount = $1,000 - $980 = $20" }
                ],
                answer: "$20 discount"
            },
            "bond_005": {
                problem: "Zero-coupon bond, face $1,000, 5 years to maturity, YTM 4%. What is the price?",
                steps: [
                    { explanation: "Zero-coupon means only payment is face value at maturity:", calculation: "No coupons" },
                    { explanation: "Discount face value:", calculation: "P = $1,000 / (1.04)‚Åµ" },
                    { explanation: "Calculate:", calculation: "P = $1,000 / 1.2167 = $821.93" }
                ],
                answer: "$821.93"
            },
            "bond_006": {
                problem: "Bond pays $40 semiannual coupon, YTM 10% (annual), 3 years to maturity, face $1,000. Price?",
                steps: [
                    { explanation: "Convert to semiannual:", calculation: "y = 10%/2 = 5%, n = 3√ó2 = 6 periods" },
                    { explanation: "PV of coupons (annuity):", calculation: "PV = $40 √ó [1 - 1/1.05‚Å∂] / 0.05 = $203.04" },
                    { explanation: "PV of face value:", calculation: "PV = $1,000 / 1.05‚Å∂ = $746.22" },
                    { explanation: "Total price:", calculation: "P = $203.04 + $746.22 = $949.26" }
                ],
                answer: "$949.26"
            },
            "bond_007": {
                problem: "Bond A has duration 5 years. Yields rise 1%. What is the approximate % price change?",
                steps: [
                    { explanation: "Duration measures sensitivity:", calculation: "% Change ‚âà -Duration √ó Œîy" },
                    { explanation: "Plug in values:", calculation: "% Change ‚âà -5 √ó 0.01" },
                    { explanation: "Calculate:", calculation: "% Change ‚âà -5% (price falls)" }
                ],
                answer: "-5%"
            },
            "bond_008": {
                problem: "Current 1-year rate is 3%, 2-year rate is 4%. What's the expected 1-year rate next year?",
                steps: [
                    { explanation: "Use expectations hypothesis:", calculation: "(1 + r‚ÇÇ)¬≤ = (1 + r‚ÇÅ)(1 + f‚ÇÅ,‚ÇÇ)" },
                    { explanation: "Solve for forward rate:", calculation: "f‚ÇÅ,‚ÇÇ = (1.04)¬≤ / (1.03) - 1" },
                    { explanation: "Calculate:", calculation: "f‚ÇÅ,‚ÇÇ = 1.0816 / 1.03 - 1 = 5.01%" }
                ],
                answer: "5.01%"
            },
            "bond_009": {
                problem: "Bond price $950, face $1,000, 6% coupon, 10 years. What's the current yield?",
                steps: [
                    { explanation: "Calculate annual coupon:", calculation: "Coupon = $1,000 √ó 6% = $60" },
                    { explanation: "Current yield formula:", calculation: "Current Yield = Annual Coupon / Price" },
                    { explanation: "Calculate:", calculation: "Current Yield = $60 / $950 = 6.32%" }
                ],
                answer: "6.32%"
            },
            "bond_010": {
                problem: "A 10-year bond has modified duration of 8. Price is $1,000. If yields fall 0.5%, estimate new price.",
                steps: [
                    { explanation: "Price change formula:", calculation: "ŒîP/P ‚âà -Duration √ó Œîy" },
                    { explanation: "Calculate % change:", calculation: "ŒîP/P ‚âà -8 √ó (-0.005) = +4%" },
                    { explanation: "Calculate new price:", calculation: "New Price = $1,000 √ó 1.04 = $1,040" }
                ],
                answer: "$1,040"
            }
        };

        // Bond Valuation Problems based on Week 4 slides (with variations)
        let problems = [
            {
                "id": "bond_001",
                "topic": "Coupon Payment Calculation",
                "difficulty": "easy",
                "problem_text": "A corporate bond has a face value of $1,000 and a coupon rate of 6%. The bond pays coupons semiannually. What is the amount of each coupon payment?",
                "given": {
                    "face_value": 1000,
                    "coupon_rate": 0.06,
                    "payments_per_year": 2
                },
                "formula": "C = (F √ó Coupon Rate) / m",
                "solution_steps": [
                    "Step 1: Identify the variables: F = $1,000, Coupon Rate = 6%, m = 2 (semiannual)",
                    "Step 2: Apply the coupon payment formula: C = (F √ó Coupon Rate) / m",
                    "Step 3: Substitute: C = (1000 √ó 0.06) / 2",
                    "Step 4: Calculate: C = 60 / 2",
                    "Step 5: Final answer: C = $30 per payment"
                ],
                "correct_answer": 30.00,
                "hints": {
                    "level_1": "The annual coupon is face value times the coupon rate, then divide by number of payments per year",
                    "level_2": "Annual coupon = $1,000 √ó 6% = $60, then divide by 2 for semiannual",
                    "level_3": "C = 60 / 2 = $30"
                }
            },
            {
                "id": "bond_002",
                "topic": "Bond Price from Yield",
                "difficulty": "medium",
                "problem_text": "You are given a bond with face value of $100, maturity of 4 years, annual coupon rate of 7%, and a yield to maturity of 8.5%. What is the price of this bond?",
                "given": {
                    "face_value": 100,
                    "maturity": 4,
                    "coupon_rate": 0.07,
                    "yield": 0.085
                },
                "formula": "P = C/(1+y) + C/(1+y)¬≤ + C/(1+y)¬≥ + (C+F)/(1+y)‚Å¥",
                "solution_steps": [
                    "Step 1: Calculate coupon: C = $100 √ó 7% = $7",
                    "Step 2: Set up the PV calculation with yield y = 8.5%",
                    "Step 3: P = 7/1.085 + 7/(1.085)¬≤ + 7/(1.085)¬≥ + 107/(1.085)‚Å¥",
                    "Step 4: P = 6.45 + 5.95 + 5.48 + 77.18",
                    "Step 5: Final answer: P = $95.06"
                ],
                "correct_answer": 95.06,
                "hints": {
                    "level_1": "The bond price is the present value of all future cash flows (coupons + face value) discounted at the yield",
                    "level_2": "Coupon = $7, discount each payment at 8.5%",
                    "level_3": "P = 7/1.085 + 7/1.085¬≤ + 7/1.085¬≥ + 107/1.085‚Å¥"
                }
            },
            {
                "id": "bond_003",
                "topic": "Bond Yield from Price",
                "difficulty": "medium",
                "problem_text": "A 3-year bond has a face value of $100, pays an annual coupon of 8%, and is currently selling for $97.50. What is the approximate yield to maturity?",
                "given": {
                    "face_value": 100,
                    "maturity": 3,
                    "coupon_rate": 0.08,
                    "price": 97.50
                },
                "formula": "P = C/(1+y) + C/(1+y)¬≤ + (C+F)/(1+y)¬≥",
                "solution_steps": [
                    "Step 1: The price $97.50 is very close to $97.47 (which corresponds to y = 9%)",
                    "Step 2: Compare: At y = 8.5%, P = $98.71 (too high)",
                    "Step 3: At y = 9%, P = $97.47 (very close to $97.50)",
                    "Step 4: Since $97.50 is between these but much closer to $97.47",
                    "Step 5: Final answer: y ‚âà 9.0%"
                ],
                "correct_answer": 9.0,
                "unit": "percent",
                "hints": {
                    "level_1": "Find which yield gives a price closest to $97.50",
                    "level_2": "At 9%, price = $97.47; at 8.5%, price = $98.71",
                    "level_3": "$97.50 is almost exactly $97.47, so yield ‚âà 9%"
                }
            },
            {
                "id": "bond_004",
                "topic": "Premium vs Discount Bonds",
                "difficulty": "easy",
                "problem_text": "A bond has a coupon rate of 5% and a yield to maturity of 4%. Is this bond trading at a premium, par, or discount? If the face value is $1,000, and the bond is trading at $1,037, what is the dollar amount of the premium?",
                "given": {
                    "coupon_rate": 0.05,
                    "yield": 0.04,
                    "face_value": 1000,
                    "price": 1037
                },
                "formula": "Premium = Price - Face Value (when Coupon Rate > Yield)",
                "solution_steps": [
                    "Step 1: Compare coupon rate (5%) to yield (4%)",
                    "Step 2: Since Coupon Rate > Yield, the bond trades at a premium",
                    "Step 3: Premium = Price - Face Value",
                    "Step 4: Premium = $1,037 - $1,000",
                    "Step 5: Final answer: Premium = $37"
                ],
                "correct_answer": 37.00,
                "hints": {
                    "level_1": "When coupon rate exceeds yield, the bond trades above par (at a premium)",
                    "level_2": "Premium is the amount by which price exceeds face value",
                    "level_3": "Premium = $1,037 - $1,000"
                }
            },
            {
                "id": "bond_005",
                "topic": "Term Structure - Bond Pricing",
                "difficulty": "hard",
                "problem_text": "The term structure shows: r‚ÇÅ = 4.5%, r‚ÇÇ = 4.8%, r‚ÇÉ = 5.0%. A 3-year bond pays annual coupons of $60 and has a face value of $1,000. Using the term structure (spot rates), what is the bond's price?",
                "given": {
                    "r1": 0.045,
                    "r2": 0.048,
                    "r3": 0.050,
                    "coupon": 60,
                    "face_value": 1000
                },
                "formula": "P = C/(1+r‚ÇÅ) + C/(1+r‚ÇÇ)¬≤ + (C+F)/(1+r‚ÇÉ)¬≥",
                "solution_steps": [
                    "Step 1: Use different spot rates for each cash flow",
                    "Step 2: PV of Year 1 coupon: 60/(1.045) = $57.42",
                    "Step 3: PV of Year 2 coupon: 60/(1.048)¬≤ = $54.63",
                    "Step 4: PV of Year 3 (coupon + face): 1060/(1.050)¬≥ = $915.65",
                    "Step 5: Total: P = 57.42 + 54.63 + 915.65",
                    "Step 6: Final answer: P = $1,027.70"
                ],
                "correct_answer": 1027.70,
                "hints": {
                    "level_1": "With the term structure, each cash flow is discounted at its own spot rate",
                    "level_2": "Year 1: 60/1.045, Year 2: 60/1.048¬≤, Year 3: 1060/1.050¬≥",
                    "level_3": "Calculate: 57.42 + 54.63 + 915.65"
                }
            },
            {
                "id": "bond_006",
                "topic": "Treasury Pricing - Semiannual",
                "difficulty": "hard",
                "problem_text": "A T-note has 2 years to maturity, a coupon rate of 6%, semiannual coupons, and face value of $100. The term structure (EAR) is: r‚ÇÄ.‚ÇÖ = 3.5%, r‚ÇÅ = 3.8%, r‚ÇÅ.‚ÇÖ = 4.0%, r‚ÇÇ = 4.2%. What is the price?",
                "given": {
                    "face_value": 100,
                    "coupon_rate": 0.06,
                    "r_05": 0.035,
                    "r_1": 0.038,
                    "r_15": 0.040,
                    "r_2": 0.042
                },
                "formula": "P = C/(1+r‚ÇÄ.‚ÇÖ)^0.5 + C/(1+r‚ÇÅ)^1 + C/(1+r‚ÇÅ.‚ÇÖ)^1.5 + (C+F)/(1+r‚ÇÇ)^2",
                "solution_steps": [
                    "Step 1: Semiannual coupon = $100 √ó 6% / 2 = $3",
                    "Step 2: PV at 0.5yr: 3/(1.035)^0.5 = $2.95",
                    "Step 3: PV at 1yr: 3/(1.038)^1 = $2.89",
                    "Step 4: PV at 1.5yr: 3/(1.040)^1.5 = $2.83",
                    "Step 5: PV at 2yr: 103/(1.042)^2 = $94.86",
                    "Step 6: Total: P = 2.95 + 2.89 + 2.83 + 94.86",
                    "Step 7: Final answer: P = $103.53"
                ],
                "correct_answer": 103.53,
                "hints": {
                    "level_1": "Semiannual coupon is $3. Discount each payment using the appropriate spot rate and fractional year",
                    "level_2": "Remember to use the fractional exponents: (1+r)^0.5, (1+r)^1, (1+r)^1.5, (1+r)^2",
                    "level_3": "3/1.035^0.5 + 3/1.038^1 + 3/1.040^1.5 + 103/1.042^2"
                }
            },
            {
                "id": "bond_007",
                "topic": "Forward Rates",
                "difficulty": "hard",
                "problem_text": "The 1-year spot rate is 3.0% and the 2-year spot rate is 3.5%. What is the one-year forward rate (the rate for borrowing from year 1 to year 2)?",
                "given": {
                    "r1": 0.03,
                    "r2": 0.035
                },
                "formula": "f‚ÇÅ‚ÇÅ = (1+r‚ÇÇ)¬≤/(1+r‚ÇÅ) - 1",
                "solution_steps": [
                    "Step 1: The forward rate makes borrowing long-term equivalent to rolling over short-term",
                    "Step 2: Apply the formula: f‚ÇÅ‚ÇÅ = (1+r‚ÇÇ)¬≤/(1+r‚ÇÅ) - 1",
                    "Step 3: f‚ÇÅ‚ÇÅ = (1.035)¬≤/(1.03) - 1",
                    "Step 4: f‚ÇÅ‚ÇÅ = 1.071225/1.03 - 1",
                    "Step 5: f‚ÇÅ‚ÇÅ = 1.04003 - 1",
                    "Step 6: Final answer: f‚ÇÅ‚ÇÅ = 4.0% (approximately)"
                ],
                "correct_answer": 4.0,
                "unit": "percent",
                "hints": {
                    "level_1": "The forward rate equates the return from a 2-year investment to rolling over two 1-year investments",
                    "level_2": "(1+r‚ÇÇ)¬≤ = (1+r‚ÇÅ)(1+f‚ÇÅ‚ÇÅ), so f‚ÇÅ‚ÇÅ = (1+r‚ÇÇ)¬≤/(1+r‚ÇÅ) - 1",
                    "level_3": "Calculate: (1.035)¬≤/1.03 - 1 = 0.04003 ‚âà 4.0%"
                }
            },
            {
                "id": "bond_008",
                "topic": "Bond Price Change - Interest Rates",
                "difficulty": "medium",
                "problem_text": "A 20-year zero-coupon bond with face value $100 has a yield of 5%. What is the percentage change in price if the yield increases to 6%?",
                "given": {
                    "face_value": 100,
                    "maturity": 20,
                    "initial_yield": 0.05,
                    "new_yield": 0.06
                },
                "formula": "% Change = (P_new - P_old) / P_old √ó 100",
                "solution_steps": [
                    "Step 1: Calculate initial price: P‚ÇÄ = 100/(1.05)¬≤‚Å∞ = $37.69",
                    "Step 2: Calculate new price: P‚ÇÅ = 100/(1.06)¬≤‚Å∞ = $31.18",
                    "Step 3: Calculate percentage change: (31.18 - 37.69)/37.69",
                    "Step 4: = -6.51/37.69",
                    "Step 5: = -0.1728",
                    "Step 6: Final answer: -17.3% (negative means price fell)"
                ],
                "correct_answer": -17.3,
                "unit": "percent",
                "hints": {
                    "level_1": "When yields rise, bond prices fall. Calculate both prices and find the percentage change",
                    "level_2": "P‚ÇÄ = 100/1.05¬≤‚Å∞ = $37.69; P‚ÇÅ = 100/1.06¬≤‚Å∞ = $31.18",
                    "level_3": "% change = (31.18 - 37.69)/37.69 √ó 100"
                }
            },
            {
                "id": "bond_009",
                "topic": "Zero-Coupon Bond Price Over Time",
                "difficulty": "easy",
                "problem_text": "A 25-year zero-coupon bond has a face value of $100 and a yield to maturity of 4%. What is the current price of this bond?",
                "given": {
                    "face_value": 100,
                    "maturity": 25,
                    "yield": 0.04
                },
                "formula": "P = F / (1+y)^T",
                "solution_steps": [
                    "Step 1: For a zero-coupon bond, price = PV of face value only",
                    "Step 2: Apply the formula: P = F / (1+y)^T",
                    "Step 3: P = 100 / (1.04)^25",
                    "Step 4: (1.04)^25 = 2.6658",
                    "Step 5: P = 100 / 2.6658",
                    "Step 6: Final answer: P = $37.51"
                ],
                "correct_answer": 37.51,
                "hints": {
                    "level_1": "Zero-coupon bonds pay no coupons, so price is just the PV of face value",
                    "level_2": "P = Face Value / (1 + yield)^years",
                    "level_3": "P = 100 / (1.04)^25"
                }
            },
            {
                "id": "bond_010",
                "topic": "Credit Spread",
                "difficulty": "easy",
                "problem_text": "A corporate bond has a yield to maturity of 6.5%. A Treasury bond with the same maturity has a yield of 4.2%. What is the credit spread in basis points? (1 basis point = 0.01%)",
                "given": {
                    "corporate_yield": 0.065,
                    "treasury_yield": 0.042
                },
                "formula": "Credit Spread = Corporate Yield - Treasury Yield",
                "solution_steps": [
                    "Step 1: The credit spread is the difference in yields between corporate and Treasury bonds",
                    "Step 2: Credit Spread = 6.5% - 4.2% = 2.3%",
                    "Step 3: Convert to basis points: 2.3% √ó 100 = 230 basis points",
                    "Step 4: Final answer: 230 basis points"
                ],
                "correct_answer": 230,
                "unit": "bps",
                "hints": {
                    "level_1": "Credit spread compensates investors for default risk above the risk-free rate",
                    "level_2": "Spread = Corporate yield - Treasury yield = 6.5% - 4.2%",
                    "level_3": "2.3% = 230 basis points (multiply by 100)"
                }
            }
        ];

        let currentProblemIndex = 0;
        let attemptCount = 0;
        let completedProblems = new Set();

        // Load problems on page load
        function loadProblems() {
            // Filter for review mode if needed
            problems = filterProblemsForReview();

            if (problems.length === 0 && reviewMode) {
                // No problems to review
                document.getElementById('problemCard').innerHTML = `
                    <div style="text-align: center; padding: 3rem;">
                        <h2 style="font-size: 2rem; margin-bottom: 1rem; color: #48BB78;">All Caught Up!</h2>
                        <div style="font-size: 1.25rem; color: #4A5568; margin-bottom: 2rem;">
                            You've mastered all the previously missed Bond Valuation problems.
                        </div>
                        <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                            <a href="week4-bonds.html" class="btn-primary" style="text-decoration: none; display: inline-block;">Practice All Problems</a>
                            <a href="index.html" class="btn-secondary" style="text-decoration: none; display: inline-block;">Back to Topics</a>
                        </div>
                    </div>
                `;
                return;
            }

            // Update header for review mode
            if (reviewMode) {
                document.querySelector('h1').textContent = 'Bond Valuation - Review Mode';
                document.querySelector('.subtitle').textContent = 'Reviewing previously missed problems';
            }

            displayProblem();
        }

        // Toggle worked example visibility
        function toggleWorkedExample() {
            const toggle = document.getElementById('workedExampleToggle');
            const toggleText = document.getElementById('toggleText');
            toggle.classList.toggle('expanded');
            toggleText.textContent = toggle.classList.contains('expanded') ? 'Hide' : 'Show';
        }

        // Populate worked example content
        function displayWorkedExample(problemId) {
            const example = workedExamples[problemId];
            const container = document.getElementById('workedExampleContent');
            const toggle = document.getElementById('workedExampleToggle');
            toggle.classList.remove('expanded');
            document.getElementById('toggleText').textContent = 'Show';
            if (!example) { toggle.style.display = 'none'; return; }
            toggle.style.display = 'block';
            let stepsHtml = example.steps.map((step, index) => `
                <div class="example-step">
                    <span class="example-step-number">${index + 1}</span>
                    <div class="example-step-content">
                        <div class="example-step-explanation">${step.explanation}</div>
                        <div class="example-step-calculation">${step.calculation}</div>
                    </div>
                </div>
            `).join('');
            container.innerHTML = `
                <div class="example-problem">
                    <div class="example-label">Example Problem</div>
                    <div class="example-text">${example.problem}</div>
                </div>
                <div class="example-solution">
                    <div class="example-label">Step-by-Step Solution</div>
                    ${stepsHtml}
                    <div class="example-final-answer">
                        <div class="example-final-answer-label">Final Answer</div>
                        <div class="example-final-answer-value">${example.answer}</div>
                    </div>
                </div>
            `;
        }

        function displayProblem() {
            if (problems.length === 0) return;

            const problem = problems[currentProblemIndex];
            attemptCount = 0;

            // Update progress
            const progress = ((currentProblemIndex) / problems.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressText').textContent =
                `Problem ${currentProblemIndex + 1} of ${problems.length}`;

            // Update difficulty badge
            const difficultyBadge = document.getElementById('difficultyBadge');
            difficultyBadge.textContent = problem.difficulty.charAt(0).toUpperCase() + problem.difficulty.slice(1);
            difficultyBadge.className = 'badge badge-' + problem.difficulty;

            // Update topic badge
            document.getElementById('topicBadge').textContent = problem.topic;

            // Display worked example for this problem
            displayWorkedExample(problem.id);

            // Update problem text
            document.getElementById('problemText').textContent = problem.problem_text;

            // Update formula (but keep it hidden initially)
            document.getElementById('formulaText').textContent = problem.formula;
            document.getElementById('formulaBox').classList.add('hidden');

            // Clear answer input and feedback
            document.getElementById('answerInput').value = '';
            document.getElementById('feedbackBox').className = 'hidden';
            document.getElementById('submitBtn').disabled = false;

            // Render LaTeX
            renderMath();

            // Update navigation buttons
            document.getElementById('prevBtn').disabled = currentProblemIndex === 0;
            document.getElementById('nextBtn').textContent =
                currentProblemIndex === problems.length - 1 ? 'Finish' : 'Next Problem';
        }

        function checkAnswer() {
            const problem = problems[currentProblemIndex];
            const userAnswer = parseFloat(document.getElementById('answerInput').value);

            if (isNaN(userAnswer)) {
                showFeedback('Please enter a valid number', 'incorrect');
                return;
            }

            // Smart tolerance: 0.5% of correct answer OR $1 (or appropriate minimum), whichever is larger
            const percentTolerance = Math.abs(problem.correct_answer) * 0.005; // 0.5%
            let minTolerance;
            if (problem.unit === 'percent') {
                minTolerance = 0.1; // 0.1 percentage points for percentages
            } else if (problem.unit === 'bps') {
                minTolerance = 5; // 5 basis points
            } else {
                minTolerance = 1; // $1 for dollar amounts
            }
            const tolerance = Math.max(percentTolerance, minTolerance);

            const isCorrect = Math.abs(userAnswer - problem.correct_answer) <= tolerance;

            attemptCount++;

            if (isCorrect) {
                completedProblems.add(currentProblemIndex);
                // Mark as mastered if correct on first attempt
                if (attemptCount === 1) {
                    markProblemMastered(problem.id);
                }
                showCorrectFeedback();
            } else {
                // Track missed problem
                saveMissedProblem(problem.id);
                showIncorrectFeedback();
            }
        }

        function formatAnswer(problem) {
            if (problem.unit === 'percent') {
                return problem.correct_answer.toFixed(1) + '%';
            } else if (problem.unit === 'bps') {
                return problem.correct_answer.toFixed(0) + ' basis points';
            } else if (problem.correct_answer >= 1000) {
                return '$' + problem.correct_answer.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            } else {
                return '$' + problem.correct_answer.toFixed(2);
            }
        }

        function showCorrectFeedback() {
            const problem = problems[currentProblemIndex];
            const feedbackBox = document.getElementById('feedbackBox');

            let html = `
                <div class="feedback-title">
                    Correct!
                </div>
                <div class="feedback-content">
                    Great job! The correct answer is ${formatAnswer(problem)}.
                </div>
            `;

            feedbackBox.className = 'feedback-box feedback-correct';
            feedbackBox.innerHTML = html;

            document.getElementById('submitBtn').disabled = true;
            renderMath();
        }

        function showIncorrectFeedback() {
            const problem = problems[currentProblemIndex];
            const feedbackBox = document.getElementById('feedbackBox');

            let html = `
                <div class="feedback-title">
                    Not quite right
                </div>
            `;

            // Adaptive feedback based on attempt count
            if (attemptCount === 1) {
                html += `
                    <div class="hint-box">
                        <strong>Hint:</strong> ${problem.hints.level_1}
                    </div>
                `;
            } else if (attemptCount === 2) {
                // Show formula on second attempt
                document.getElementById('formulaBox').classList.remove('hidden');
                html += `
                    <div class="hint-box">
                        <strong>Formula revealed above.</strong> ${problem.hints.level_2}
                    </div>
                `;
            } else if (attemptCount === 3) {
                // Keep formula visible
                document.getElementById('formulaBox').classList.remove('hidden');
                html += `
                    <div class="hint-box">
                        <strong>Detailed hint:</strong> ${problem.hints.level_3}
                    </div>
                    <div style="margin-top: 1rem;">
                        <button class="btn-secondary" onclick="showFullSolution()">Show Full Solution</button>
                    </div>
                `;
            } else {
                // After 3 attempts, show full solution automatically
                showFullSolution();
                return;
            }

            feedbackBox.className = 'feedback-box feedback-incorrect';
            feedbackBox.innerHTML = html;
            renderMath();
        }

        function showFullSolution() {
            const problem = problems[currentProblemIndex];
            const feedbackBox = document.getElementById('feedbackBox');

            let html = `
                <div class="feedback-title">
                    Solution
                </div>
                <div class="solution-steps">
            `;

            problem.solution_steps.forEach((step, index) => {
                html += `
                    <div class="solution-step">
                        ${step}
                    </div>
                `;
            });

            html += `
                </div>
                <div class="feedback-content" style="margin-top: 1rem; padding-top: 1rem; border-top: 2px solid #E2E8F0;">
                    <strong>Final Answer:</strong> ${formatAnswer(problem)}
                </div>
            `;

            feedbackBox.className = 'feedback-box feedback-correct';
            feedbackBox.innerHTML = html;

            document.getElementById('submitBtn').disabled = true;
            renderMath();
        }

        function nextProblem() {
            if (currentProblemIndex < problems.length - 1) {
                currentProblemIndex++;
                displayProblem();
            } else {
                showSummary();
            }
        }

        function previousProblem() {
            if (currentProblemIndex > 0) {
                currentProblemIndex--;
                displayProblem();
            }
        }

        function showSummary() {
            const problemCard = document.getElementById('problemCard');
            const completed = completedProblems.size;
            const total = problems.length;
            const percentage = Math.round((completed / total) * 100);

            // Check if there are missed problems to review
            const missed = getMissedProblems();
            const missedCount = Object.keys(missed).length;

            let reviewButton = '';
            if (missedCount > 0 && !reviewMode) {
                reviewButton = `
                    <a href="week4-bonds.html?review=true" class="btn-primary" style="text-decoration: none; display: inline-block; background-color: #DD6B20;">
                        Review ${missedCount} Missed Problem${missedCount > 1 ? 's' : ''}
                    </a>
                `;
            }

            let celebrationMessage = '';
            if (reviewMode && percentage === 100) {
                celebrationMessage = `
                    <div style="background-color: #C6F6D5; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        Excellent! You've mastered all the problems you previously missed!
                    </div>
                `;
            }

            problemCard.innerHTML = `
                <div style="text-align: center; padding: 3rem;">
                    <h2 style="font-size: 2rem; margin-bottom: 1rem;">${reviewMode ? 'Review Session' : 'Practice Session'} Complete!</h2>
                    ${celebrationMessage}
                    <div style="font-size: 3rem; font-weight: bold; color: #2C5282; margin: 2rem 0;">
                        ${completed} / ${total}
                    </div>
                    <div style="font-size: 1.25rem; color: #4A5568; margin-bottom: 2rem;">
                        You got ${percentage}% of problems correct on the first try!
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                        ${reviewButton}
                        <button class="btn-primary" onclick="location.reload()">Practice Again</button>
                        <a href="index.html" class="btn-secondary" style="text-decoration: none; display: inline-block;">Back to Topics</a>
                    </div>
                </div>
            `;
        }

        function renderMath() {
            // Simple rendering - for more complex math, we'd use KaTeX's auto-render
            setTimeout(() => {
                const elements = document.querySelectorAll('.problem-text, .formula-box, .solution-step, .hint-box');
                elements.forEach(element => {
                    // Replace common LaTeX patterns with rendered math
                    // This is a simplified version - full KaTeX auto-render would be more robust
                });
            }, 100);
        }

        // Allow Enter key to submit
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('answerInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !document.getElementById('submitBtn').disabled) {
                    checkAnswer();
                }
            });
            loadProblems();
        });
    </script>
</body>
</html>
